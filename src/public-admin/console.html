<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Gamify Console</title>
</head>
<body>

<script>
/* ------------------------------
   0) äº‹å‰ã‚»ãƒƒãƒˆ: GM_addStyle / ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯
   ------------------------------ */
(function(){
  // Tampermonkey ãªã—ã§ã‚‚åŒã˜APIåã§CSSã‚’æ³¨å…¥ã§ãã‚‹ã‚ˆã†ã«
  window.GM_addStyle = window.GM_addStyle || function(css){
    try { const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s); } catch(_){}
  };

  // #tenant=...&token=...&base=... ã‚’ localStorage ã«ä¿å­˜
  try {
    const q = new URLSearchParams(location.hash.slice(1));
    const tenant = q.get('tenant') || 'default';
    const token  = q.get('token')  || '';
    const base   = (q.get('base') ?? '').trim();
    const baseUrl = base === '' ? location.origin : base;
    localStorage.setItem("sgc.profile.v3", JSON.stringify({ tenant, baseUrl, token }));
  } catch(_){}
})();
</script>

<script>
/* ==UserScript==
 * @name         Sales Gamify Console (v2.3 UI: ãƒ«ãƒ¼ãƒ«è‡ªç”±ç·¨é›†ãƒ»CSVå–è¾¼ãƒ»å®‰å®šåŒ–)
 * @namespace    https://habitica.com/
 * @version      2.3.0
 * @description  Habiticaä¸Šã«å–¶æ¥­ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šUIã‚’è¿½åŠ ã€‚ã‚¹ã‚³ã‚¢/ã‚¢ãƒ/ãƒ©ãƒ™ãƒ«/CSV/ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç·¨é›†ã€‚èª­ã¿è¾¼ã¿å®Œäº†ã¨åŒæ™‚ã«è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’å‡ºã™ã‚ˆã†å®‰å®šåŒ–ã€‚
 * @match        https://habitica.com/*
 * @run-at       document-end
 * @grant        GM_addStyle
 * ==/UserScript== */

(() => {
  /* ====== åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
  const LS_KEY  = "sgc.profile.v3";
  const LS_VIEW = "sgc.view.v3";
  const LS_UNDO = "sgc.undo.v1";
  const MAX_UNDO = 8;

  const h = (html) => { const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstElementChild; };
  const asNum=(v,d=0)=>{ const n=Number(v); return Number.isFinite(n)?n:d; };
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const load=(k,def={})=>{ try{ return JSON.parse(localStorage.getItem(k)||"")||def; }catch{ return def; } };
  const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v||{}));
  const toast=(msg,bad=false)=>{ const el=h(`<div class="sgc-toast" style="background:${bad?"#c0392b":"#222"}">${msg}</div>`); document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };
  const loadProfile=()=>load(LS_KEY,{ tenant:"default", baseUrl:"", token:"" });
  const saveProfile=(p)=>save(LS_KEY,p);

  const headers=(p)=>{ const hd={"Accept":"application/json"}; if(p?.token){ hd.Authorization=`Bearer ${p.token}`; } return hd; };
  const apiGET=async(url,p)=>{ const r=await fetch(url,{headers:headers(p)}); if(!r.ok) throw new Error(String(r.status)); return r.json(); };
  const apiPUT=async(url,body,p)=>{ const r=await fetch(url,{method:"PUT",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); try{return await r.json();}catch{return {ok:true}} };
  const apiPOSTForm=async(url,form,p)=>{ const r=await fetch(url,{method:"POST",headers:headers(p),body:form}); if(!r.ok) throw new Error(String(r.status)); try{return await r.json();}catch{return {ok:true}} };

  /* ====== ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ« + ä½¿ã„å‹æ‰‹æ”¹è‰¯ï¼‰ ====== */
  GM_addStyle(`
    #sgc-fab{position:fixed; top:110px; right:18px; z-index:2147483646;
      background:#6c5ce7; color:#fff; border-radius:14px; padding:10px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,.25); font-weight:700; display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none}
    #sgc-fab:hover{filter:brightness(1.06)}
    #sgc-modal-mask{position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:2147483645; display:none}
    #sgc-modal{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      z-index:2147483646; width:min(1160px,96vw); max-height:88vh; background:#fff; border-radius:14px;
      overflow:hidden; box-shadow:0 24px 48px rgba(0,0,0,.25); display:none;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .sgc-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f7f7fb;border-bottom:1px solid #ececf5;gap:12px}
    .sgc-title{font-weight:800}
    .sgc-kv{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sgc-tabs{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid #f1f1f6;flex-wrap:wrap}
    .sgc-tab{padding:6px 10px;border-radius:8px;font-weight:700;color:#555;cursor:pointer}
    .sgc-tab.active{background:#6c5ce7;color:#fff}
    .sgc-body{padding:14px;max-height:calc(88vh - 134px);overflow:auto}
    .sgc-row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;padding:8px 0}
    .sgc-row input,.sgc-row select,.sgc-row textarea{border:1px solid #dfe3f0;border-radius:8px;padding:9px 10px;width:100%;font-size:14px;background:#fff}
    .sgc-help{font-size:12px;color:#777}
    .sgc-actions{position:sticky; bottom:0; background:#fff; z-index:1;
      display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #ececf5;align-items:center}
    .sgc-btn{background:#e9e9f4;border:none;padding:9px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .sgc-btn.primary{background:#6c5ce7;color:#fff}
    .sgc-badge{background:#f0efff;color:#5c54d6;border-radius:999px;padding:3px 8px;font-size:12px}
    .sgc-toast{position:fixed;right:16px;bottom:16px;background:#222;color:#fff;padding:10px 14px;border-radius:12px;z-index:2147483647;opacity:.95}
    .sgc-list{display:flex;flex-direction:column;gap:8px}
    .sgc-card{border:1px solid #e8e8f5;border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .sgc-card .full{grid-column:1 / -1}
    .sgc-card .muted{color:#777;font-size:12px}
    .sgc-del{background:#fff;border:1px solid #e1e1ef}
    .sgc-bare{border:1px dashed #ddd;border-radius:10px;padding:10px}
    .sgc-row-compact{display:flex;gap:8px;align-items:center}
    /* HubSpotè¡Œã‚’ãƒ¯ã‚¤ãƒ‰ã«ï¼š3ã‚«ãƒ©ãƒ (ãƒ©ãƒ™ãƒ«ID/ã‚¿ã‚¤ãƒˆãƒ«/å‰Šé™¤) */
    .sgc-card-hub{grid-template-columns:1.4fr 2fr 120px}
    .sgc-card-hub input{width:100%}
    @media(max-width:768px){
      .sgc-row{grid-template-columns:1fr}
      .sgc-card{grid-template-columns:1fr}
      .sgc-card-hub{grid-template-columns:1fr}
    }
  `);

  /* ====== å›ºå®šãƒœã‚¿ãƒ³ ====== */
  function ensureFab(){
    if(document.getElementById("sgc-fab")) return;
    const fab = h(`<div id="sgc-fab" title="Sales Gamify Console">âš™ï¸ è¨­å®š</div>`);
    fab.addEventListener("click", openModal);
    document.body.appendChild(fab);
  }

  /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ ====== */
  let profile={}, currentTab="score", rulesCache=null, labelsCache=null;
  let modal, bodyArea;

  function ensureModal(){
    if(document.getElementById("sgc-modal")) return;

    document.body.appendChild(h(`<div id="sgc-modal-mask"></div>`));

    modal = h(`
      <div id="sgc-modal" role="dialog" aria-modal="true" aria-label="Sales Gamify Console">
        <div class="sgc-hd">
          <div class="sgc-kv"><div class="sgc-title">Sales Gamify Console</div><span class="sgc-badge">UIå…¨XPç·¨é›†+CSV</span></div>
          <div class="sgc-kv">
            <label style="font-size:12px;color:#666">Tenant:</label>
            <input id="sgc-tenant" style="width:180px" placeholder="default">
            <label style="font-size:12px;color:#666">BaseURL:</label>
            <input id="sgc-base" style="width:300px" placeholder="https://sales-gamify.onrender.com">
            <label style="font-size:12px;color:#666">Token:</label>
            <input id="sgc-token" style="width:240px" placeholder="(Bearerä¸è¦)">
            <button id="sgc-ping" class="sgc-btn">Ping</button>
            <button id="sgc-save-top" class="sgc-btn primary">ä¿å­˜</button>
            <button id="sgc-close" class="sgc-btn">é–‰ã˜ã‚‹</button>
          </div>
        </div>
        <div class="sgc-tabs" id="sgc-tabs"></div>
        <div id="sgc-body" class="sgc-body"></div>
        <div class="sgc-actions">
          <button id="sgc-save" class="sgc-btn primary">ä¿å­˜</button>
        </div>
      </div>
    `);
    document.body.appendChild(modal);

    bodyArea = modal.querySelector("#sgc-body");
    modal.querySelector("#sgc-ping").addEventListener("click", doPing);
    modal.querySelector("#sgc-close").addEventListener("click", closeModal);
    modal.querySelector("#sgc-save").addEventListener("click", saveAll);
    modal.querySelector("#sgc-save-top").addEventListener("click", saveAll);
    document.addEventListener("keydown",(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); saveAll(); }});
    document.getElementById("sgc-modal-mask").addEventListener("click", closeModal);
  }

  function openModal(){
    ensureModal();
    profile=loadProfile();
    document.getElementById("sgc-modal-mask").style.display="block";
    modal.style.display="block";
    modal.querySelector("#sgc-tenant").value=profile.tenant||"default";
    modal.querySelector("#sgc-base").value=profile.baseUrl||"";
    modal.querySelector("#sgc-token").value=profile.token||"";
    initTabs();
    loadAll();
  }
  function closeModal(){
    modal.style.display="none";
    document.getElementById("sgc-modal-mask").style.display="none";
  }

  function initTabs(){
    const tabs = modal.querySelector("#sgc-tabs");
    tabs.innerHTML="";
    const defs=[
      {id:"score",  label:"ã‚¹ã‚³ã‚¢è¨­å®š"},
      {id:"hub",    label:"HubSpoté€£æºï¼ˆãƒ©ãƒ™ãƒ«ï¼‰"},
      {id:"approve",label:"æ‰¿èªãƒ»å£²ä¸Šï¼ˆCSVé€£å‹•ï¼‰"},
      {id:"csv",    label:"CSVå–è¾¼"},
      {id:"dash",   label:"ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"},
    ];
    defs.forEach(t=>{
      const el=h(`<div class="sgc-tab" data-tab="${t.id}">${t.label}</div>`);
      if(t.id===currentTab) el.classList.add("active");
      el.addEventListener("click",()=>{ currentTab=t.id; render(); });
      tabs.appendChild(el);
    });
    render();
  }

  function baseURL(){ return String(modal.querySelector("#sgc-base").value||"").replace(/\/+$/,""); }
  function tenant(){ return String(modal.querySelector("#sgc-tenant").value||"default"); }
  function token(){ return String(modal.querySelector("#sgc-token").value||""); }
  function ensureProfileFromInputs(){ profile={ tenant:tenant(), baseUrl:baseURL(), token:token() }; saveProfile(profile); }

  async function doPing(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ toast("BaseURL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true); return; }
    try{
      const j=await apiGET(`${profile.baseUrl}/healthz`, profile);
      toast("OK: æ¥ç¶š");
      console.log("healthz:", j);
    }catch(e){ toast("æ¥ç¶šã‚¨ãƒ©ãƒ¼", true); }
  }

  /* ====== ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ & ä¿å­˜ ====== */
  async function loadAll(){
    ensureProfileFromInputs();
    if(!profile.baseUrl) return;
    try{
      const [rules, labels] = await Promise.all([
        apiGET(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/rules`, profile).catch(()=>({})),
        apiGET(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/labels`, profile).catch(()=>({ items:[] })),
      ]);
      rulesCache = rules || {};
      labelsCache = Array.isArray(labels?.items) ? labels.items : [];
      render();
    }catch(e){ console.warn(e); toast("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", true); }
  }

  async function saveAll(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ toast("BaseURL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true); return; }

    collectScoreToCaches();
    collectApproveToCache();
    collectHubToCache();

    try{
      await apiPUT(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/rules`, rulesCache||{}, profile);
      await apiPUT(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/labels`, { items: labelsCache||[] }, profile);
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
      await loadAll();
    }catch(e){
      console.error(e);
      const msg = String(e||"");
      if (msg.includes("401")) {
        toast("ä¿å­˜ã«å¤±æ•—: 401 Unauthorizedï¼ˆãƒ†ãƒŠãƒ³ãƒˆåã¨ãƒˆãƒ¼ã‚¯ãƒ³ã®çµ„ã¿åˆã‚ã›ãŒ Render ã® SGC_TOKENS ã¨ä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ï¼‰", true);
      } else {
        toast("ä¿å­˜ã«å¤±æ•—: "+msg, true);
      }
    }
  }

  /* ====== ã‚¿ãƒ–æç”» ====== */
  function render(){
    modal.querySelectorAll(".sgc-tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===currentTab));
    bodyArea.innerHTML="";
    if(currentTab==="score") renderScore();
    else if(currentTab==="hub") renderHub();
    else if(currentTab==="approve") renderApprove();
    else if(currentTab==="csv") renderCSV();
    else if(currentTab==="dash") renderDash();
  }

  function safeRules(){
    const r = rulesCache || {};
    r.xp = r.xp || {};
    r.xp.call = r.xp.call || {};
    r.xp.minutes = r.xp.minutes || {};
    r.xp.appointment = r.xp.appointment || {};
    r.approval = r.approval || { enabled:true, xp:0, badge:"æ‰¿èª" };
    r.sales = r.sales || { milestones: [] };
    return r;
  }

  /* ====== ã‚¹ã‚³ã‚¢è¨­å®š ====== */
  function renderScore(){
    const r=safeRules();
    const perCall = Number(r?.xp?.call?.perCall ?? 1);
    const unitMin = clamp(Math.round(Number(r?.xp?.minutes?.unitMs || 300000)/60000) || 5, 1, 60);
    const perUnit = Number(r?.xp?.minutes?.perUnitMs ?? r?.xp?.minutes?.per5min ?? 2);
    const list = Array.isArray(r?.xp?.minutes?.list) ? r.xp.minutes.list : [{min:unitMin,xp:perUnit}];
    const apXP    = Number(r?.xp?.appointment?.xp ?? 20);
    const apBadge = String(r?.xp?.appointment?.badge || "ğŸ…æ–°è¦ã‚¢ãƒç²å¾—");

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>ç™ºä¿¡ 1ã‚³ãƒ¼ãƒ«ã‚ãŸã‚ŠXP</label>
        <input id="sgc-xp-call" type="number" min="0" step="1" value="${perCall}">
      </div>
    `));

    const box = h(`<div class="sgc-row"><label>é€šè©±æ™‚é–“ã«å¿œã˜ãŸXP</label>
      <div class="sgc-bare">
        <div id="sgc-minutes-list" class="sgc-list"></div>
        <div style="margin-top:8px"><button id="sgc-add-min" class="sgc-btn">ï¼‹ è¡Œã‚’è¿½åŠ </button>
          <span class="sgc-help">â€»ã‚µãƒ¼ãƒå´ã¯å½“é¢ã€Œå…ˆé ­1è¡Œã€ã‚’ä½¿ç”¨ã€‚å…¨è¡Œã¯ <code>xp.minutes.list</code> ã«ä¿å­˜ã—å°†æ¥æ‹¡å¼µã—ã¾ã™ã€‚</span>
        </div>
      </div>
    </div>`);
    bodyArea.appendChild(box);

    const listEl = box.querySelector("#sgc-minutes-list");
    function pushMinuteRow(v){ listEl.appendChild(renderMinuteRow(v)); }
    function renderMinuteRow(v){
      const row = h(`<div class="sgc-row-compact">
        <span>æ¯</span><input class="sgc-min" type="number" min="1" value="${Number(v?.min)||5}" style="width:80px">
        <span>åˆ†ã”ã¨ã«</span><input class="sgc-min-xp" type="number" min="0" value="${Number(v?.xp)||0}" style="width:120px"><span>XP</span>
        <button class="sgc-btn sgc-del">å‰Šé™¤</button>
      </div>`);
      row.querySelector(".sgc-del").addEventListener("click",()=>row.remove());
      return row;
    }
    list.forEach(pushMinuteRow);
    box.querySelector("#sgc-add-min").addEventListener("click",()=>pushMinuteRow({min:5,xp:0}));

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>æ—¢å®šï¼šæ–°è¦ã‚¢ãƒï¼ˆHubSpotï¼‰</label>
        <div class="sgc-row-compact">
          <input id="sgc-ap-xp" type="number" min="0" step="1" value="${apXP}" style="width:120px"> <span>XP</span>
          <span style="width:10px"></span>
          <span>ãƒãƒƒã‚¸å</span>
          <input id="sgc-ap-badge" type="text" value="${apBadge}" placeholder="ä¾‹: ğŸ…æ–°è¦ã‚¢ãƒç²å¾—" style="width:300px">
        </div>
        <div class="sgc-help">ã€Œæ–°è¦ã‚¢ãƒã€ã®æ—¢å®šå€¤ï¼ˆã‚«ã‚¹ã‚¿ãƒ Outcomeã«åŒåãŒã‚ã‚Œã°ãã¡ã‚‰ãŒå„ªå…ˆï¼‰ã€‚</div>
      </div>
    `));

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>ã‚«ã‚¹ã‚¿ãƒ Outcomeï¼ˆHubSpotãƒ©ãƒ™ãƒ«ï¼‰</label>
        <div>
          <div class="sgc-help">HubSpoté€£æºã‚¿ãƒ–ã§ãƒ©ãƒ™ãƒ«ID/ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ã“ã“ã«ä¸€è¦§ãŒå‡ºã¾ã™ã€‚å„ãƒ©ãƒ™ãƒ«ã”ã¨ã«ã€Œæœ‰åŠ¹/ç„¡åŠ¹ãƒ»XPãƒ»ãƒãƒƒã‚¸ã€ã‚’è¨­å®šå¯èƒ½ã€‚</div>
          <div id="sgc-custom-list" class="sgc-list"></div>
          <div class="sgc-help">è¡Œã®è¿½åŠ /å‰Šé™¤ã¯ã€ŒHubSpoté€£æºã€ã‚¿ãƒ–ã§è¡Œã£ã¦ãã ã•ã„ã€‚</div>
        </div>
      </div>
    `));

    const list2=bodyArea.querySelector("#sgc-custom-list");
    ensureLabelsArray();
    labelsCache.forEach(it=> list2.appendChild(renderCustomCard(it)));
    if(labelsCache.length===0){
      list2.appendChild(h(`<div class="sgc-help">â€» ã¾ã ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã€ŒHubSpoté€£æºã€ã‚¿ãƒ–ã§ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`));
    }

    function renderCustomCard(item){
      const enabled = !!item.enabled;
      const xp = Number.isFinite(Number(item.xp)) ? Number(item.xp) : "";
      const badge = item.badge || "";
      const el=h(`
        <div class="sgc-card" data-id="${item.id||""}" data-title="${item.title||""}">
          <div><label class="muted">ãƒ©ãƒ™ãƒ«ID</label><div><strong>${item.id||"(æœªæŒ‡å®š)"}</strong></div></div>
          <div><label class="muted">ã‚¿ã‚¤ãƒˆãƒ«</label><div>${item.title||"(æœªæŒ‡å®š)"}</div></div>
          <div class="full" style="display:flex;gap:10px;align-items:center">
            <label style="display:flex;gap:6px;align-items:center"><input class="sgc-en" type="checkbox" ${enabled?"checked":""}> æœ‰åŠ¹ã«ã™ã‚‹</label>
            <span>XP</span><input class="sgc-xp" type="number" min="0" step="1" value="${xp}" style="max-width:120px">
            <span>ãƒãƒƒã‚¸</span><input class="sgc-badge" type="text" value="${badge}" placeholder="ä¾‹: ğŸ·ï¸è¦‹è¾¼ã¿A æˆæœ" style="max-width:300px">
          </div>
        </div>
      `);
      return el;
    }
  }

  function collectScoreToCaches(){
    const r=safeRules();
    r.xp.call.perCall = asNum(modal.querySelector("#sgc-xp-call")?.value,0);

    const rows=[...modal.querySelectorAll("#sgc-minutes-list .sgc-row-compact")];
    const list = rows.map(row=>({ min:asNum(row.querySelector(".sgc-min").value,5), xp:asNum(row.querySelector(".sgc-min-xp").value,0) }));
    if(list.length===0) list.push({min:5,xp:0});
    r.xp.minutes.unitMs = list[0].min*60*1000;
    r.xp.minutes.perUnitMs = list[0].xp;
    if(list[0].min===5) r.xp.minutes.per5min=list[0].xp; else delete r.xp.minutes.per5min;
    r.xp.minutes.list = list;

    r.xp.appointment.xp = asNum(modal.querySelector("#sgc-ap-xp")?.value,20);
    r.xp.appointment.badge = String(modal.querySelector("#sgc-ap-badge")?.value||"");

    const listEl=[...modal.querySelectorAll("#sgc-custom-list .sgc-card")];
    listEl.forEach(card=>{
      const id   = card.getAttribute("data-id")||"";
      const tit  = card.getAttribute("data-title")||"";
      const en   = card.querySelector(".sgc-en").checked;
      const xp   = card.querySelector(".sgc-xp").value;
      const bd   = card.querySelector(".sgc-badge").value;
      const it = labelsCache.find(x=>(x.id||"")===(id||"") && (x.title||"")===(tit||""));
      if(it){
        it.enabled = !!en;
        const v = Number(xp);
        it.xp = Number.isFinite(v) ? v : undefined;
        it.badge = String(bd||"") || undefined;
      }
    });

    rulesCache=r;
  }

  /* ====== HubSpoté€£æºï¼ˆãƒ©ãƒ™ãƒ«ï¼‰ ====== */
  function ensureLabelsArray(){ labelsCache = Array.isArray(labelsCache)? labelsCache : []; }

  function renderHub(){
    ensureLabelsArray();
    bodyArea.appendChild(h(`<div class="sgc-help">HubSpotã®ã€Œãƒ©ãƒ™ãƒ«IDã€ã¨ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ã‚’è¡Œå˜ä½ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ä¿å­˜å¾Œã€ã€Œã‚¹ã‚³ã‚¢è¨­å®šã€ã‚¿ãƒ–ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>`));

    const area=h(`<div id="sgc-hub-list" class="sgc-list"></div>`);
    bodyArea.appendChild(area);

    const toolbar=h(`<div class="sgc-kv" style="margin:8px 0">
        <button id="sgc-add-row" class="sgc-btn">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        <button id="sgc-del-all" class="sgc-btn sgc-del">å…¨è¡Œã‚’ã‚¯ãƒªã‚¢</button>
      </div>`);
    bodyArea.appendChild(toolbar);

    labelsCache.forEach(it=> area.appendChild(renderHubRow(it)));
    if(labelsCache.length===0){
      area.appendChild(renderHubRow({id:"", title:""}));
    }

    bodyArea.querySelector("#sgc-add-row").addEventListener("click",()=> area.appendChild(renderHubRow({id:"", title:""})));
    bodyArea.querySelector("#sgc-del-all").addEventListener("click",()=>{ labelsCache=[]; area.innerHTML=""; area.appendChild(renderHubRow({id:"", title:""})); });

    function renderHubRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-hub">
          <div><label class="muted">HubSpot ãƒ©ãƒ™ãƒ«ID</label><input class="sgc-h-id" value="${item.id||""}" placeholder="ä¾‹: ac590467-..."></div>
          <div><label class="muted">ãƒ©ãƒ™ãƒ«å/ã‚¿ã‚¤ãƒˆãƒ«</label><input class="sgc-h-title" value="${item.title||""}" placeholder="ä¾‹: ãƒ‹ãƒ¼ã‚ºç„¡ã— / è¦‹è¾¼ã¿A"></div>
          <div style="display:flex;justify-content:flex-end;align-items:flex-end">
            <button class="sgc-btn sgc-del">å‰Šé™¤</button>
          </div>
        </div>
      `);
      row.querySelector(".sgc-del").addEventListener("click",()=> row.remove());
      if(item.enabled) row.setAttribute("data-enabled","1");
      if(Number.isFinite(Number(item.xp))) row.setAttribute("data-xp", String(item.xp));
      if(item.badge) row.setAttribute("data-badge", item.badge);
      return row;
    }
  }

  function collectHubToCache(){
    const list=[...modal.querySelectorAll("#sgc-hub-list .sgc-card")];
    const items=[];
    for(const row of list){
      const id = String(row.querySelector(".sgc-h-id")?.value||"").trim();
      const title = String(row.querySelector(".sgc-h-title")?.value||"").trim();
      if(!id && !title) continue;
      items.push({
        id, title,
        enabled: row.getAttribute("data-enabled")==="1" ? true : undefined,
        xp: Number.isFinite(Number(row.getAttribute("data-xp"))) ? Number(row.getAttribute("data-xp")) : undefined,
        badge: row.getAttribute("data-badge") || undefined,
      });
    }
    labelsCache = items;
  }

  /* ====== æ‰¿èªãƒ»å£²ä¸Šï¼ˆCSVé€£å‹•ï¼‰ ====== */
  function renderApprove(){
    const r=safeRules();
    const ap = r.approval || { enabled:true, xp:0, badge:"æ‰¿èª" };
    const milestones = Array.isArray(r.sales?.milestones) ? r.sales.milestones : [];

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>æ‰¿èªï¼ˆApprovalï¼‰æ™‚ã®XP</label>
        <div class="sgc-row-compact">
          <input id="sgc-approve-xp" type="number" min="0" step="1" value="${Number(ap.xp)||0}" style="width:120px"> <span>XP</span>
          <span>ãƒãƒƒã‚¸</span><input id="sgc-approve-badge" type="text" value="${String(ap.badge||"æ‰¿èª")}" style="width:240px">
          <label style="display:flex;gap:6px;align-items:center"><input id="sgc-approve-en" type="checkbox" ${ap.enabled!==false?"checked":""}> æœ‰åŠ¹</label>
        </div>
      </div>
    `));

    const wrap=h(`<div class="sgc-row"><label>å£²ä¸Šé”æˆï¼ˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ³ï¼‰</label>
      <div class="sgc-bare">
        <div id="sgc-ms-list" class="sgc-list"></div>
        <div style="margin-top:8px"><button id="sgc-add-ms" class="sgc-btn">ï¼‹ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ³è¿½åŠ </button></div>
      </div>
    </div>`);
    bodyArea.appendChild(wrap);

    const msList=wrap.querySelector("#sgc-ms-list");
    function pushMsRow(v){ msList.appendChild(renderMsRow(v)); }
    function renderMsRow(v){
      const row=h(`<div class="sgc-row-compact">
        <span>é‡‘é¡ï¼ˆåˆ°é”æ¯ï¼‰</span><input class="sgc-ms-amt" type="number" min="0" value="${Number(v?.amount)||100000}" style="width:160px">
        <span>XP</span><input class="sgc-ms-xp" type="number" min="0" value="${Number(v?.xp)||50}" style="width:120px">
        <span>ãƒãƒƒã‚¸</span><input class="sgc-ms-badge" type="text" value="${String(v?.badge||"å£²ä¸Š"+(Number(v?.amount)||100000).toLocaleString()+"é”æˆ")}" style="width:280px">
        <button class="sgc-btn sgc-del">å‰Šé™¤</button>
      </div>`);
      row.querySelector(".sgc-del").addEventListener("click",()=>row.remove());
      return row;
    }
    (milestones.length?milestones:[{amount:100000,xp:50,badge:"å£²ä¸Š10ä¸‡å††é”æˆ"}]).forEach(pushMsRow);
    wrap.querySelector("#sgc-add-ms").addEventListener("click",()=>pushMsRow({amount:100000,xp:50}));
  }

  function collectApproveToCache(){
    const r=safeRules();
    r.approval = {
      enabled: !!modal.querySelector("#sgc-approve-en")?.checked,
      xp: asNum(modal.querySelector("#sgc-approve-xp")?.value,0),
      badge: String(modal.querySelector("#sgc-approve-badge")?.value||"æ‰¿èª")
    };
    const rows=[...modal.querySelectorAll("#sgc-ms-list .sgc-row-compact")];
    r.sales = r.sales || {};
    r.sales.milestones = rows.map(row=>({
      amount: asNum(row.querySelector(".sgc-ms-amt").value,0),
      xp: asNum(row.querySelector(".sgc-ms-xp").value,0),
      badge: String(row.querySelector(".sgc-ms-badge").value||"")
    }));
    rulesCache=r;
  }

  /* ====== CSVå–è¾¼ ====== */
  function renderCSV(){
    const box=h(`
      <div class="sgc-row"><label>CSVã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <div>
          <div class="sgc-row-compact">
            <input id="sgc-csv-file" type="file" accept=".csv">
            <button id="sgc-upload" class="sgc-btn">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <button id="sgc-open-admin" class="sgc-btn">ç®¡ç†ç”»é¢ã‚’é–‹ã</button>
          </div>
          <div class="sgc-help">ã¾ãšã¯ <code>/admin/upload</code> ã«POSTã—ã¾ã™ã€‚ãƒ€ãƒ¡ãªã‚‰ <code>/admin/csv</code> â†’ <code>/admin/import</code> ã®é †ã«è©¦è¡Œã€‚å…¨éƒ¨ãƒ€ãƒ¡ãªã‚‰ç®¡ç†ç”»é¢ /admin ã‚’é–‹ãã¾ã™ã€‚</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(box);
    box.querySelector("#sgc-upload").addEventListener("click", doUpload);
    box.querySelector("#sgc-open-admin").addEventListener("click", ()=> window.open(`${baseURL()}/admin?tenant=${encodeURIComponent(tenant())}`,"_blank"));

    async function doUpload(){
      ensureProfileFromInputs();
      const f=modal.querySelector("#sgc-csv-file")?.files?.[0];
      if(!f){ toast("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„", true); return; }
      const tries=[ "/admin/upload", "/admin/csv", "/admin/import" ];
      const form=new FormData(); form.append("file", f); form.append("tenant", tenant());
      for(const path of tries){
        try{
          await apiPOSTForm(`${baseURL()}${path}`, form, profile);
          toast("CSVå–è¾¼ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ");
          return;
        }catch(e){ console.warn("upload fail", path, e); }
      }
      toast("ã‚µãƒ¼ãƒæœªå¯¾å¿œã®ã‚ˆã†ã§ã™ã€‚ç®¡ç†ç”»é¢ã‹ã‚‰å–ã‚Šè¾¼ã¿ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚", true);
    }
  }

  /* ====== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ====== */
  function renderDash(){
    const b=h(`
      <div class="sgc-row"><label>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</label>
        <div class="sgc-kv">
          <button id="sgc-open-dash" class="sgc-btn">é–‹ã</button>
          <div class="sgc-help">BaseURL ã® <code>/admin/dashboard?tenant=...</code> ã‚’æ–°è¦ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(b);
    b.querySelector("#sgc-open-dash").addEventListener("click",()=> window.open(`${baseURL()}/admin/dashboard?tenant=${encodeURIComponent(tenant())}`,"_blank"));
  }

  /* ====== èµ·å‹• ====== */
  function start(){ ensureFab(); }
  if(document.readyState==="complete"){ start(); }
  else window.addEventListener("load", start, {once:true});

})();
</script>

<script>
// ã“ã®å˜ä½“ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã‚‰è‡ªå‹•ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
(function openWhenReady(){
  const el = document.getElementById('sgc-fab');
  if (el) { el.click(); return; }
  setTimeout(openWhenReady, 100);
})();
</script>

</body>
</html>
