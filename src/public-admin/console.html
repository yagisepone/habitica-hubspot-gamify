<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Gamify Console</title>
</head>
<body>

<script>
/* ------------------------------
   0) 事前セット: GM_addStyle / マジックリンク
   ------------------------------ */
(function(){
  // Tampermonkey なしでも同じAPI名でCSSを注入できるように
  window.GM_addStyle = window.GM_addStyle || function(css){
    try { const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s); } catch(_){}
  };

  // #tenant=...&token=...&base=... を localStorage に保存
  try {
    const q = new URLSearchParams(location.hash.slice(1));
    const tenant = q.get('tenant') || 'default';
    const token  = q.get('token')  || '';
    const base   = (q.get('base') ?? '').trim();
    const baseUrl = base === '' ? location.origin : base;
    localStorage.setItem("sgc.profile.v3", JSON.stringify({ tenant, baseUrl, token }));
  } catch(_){}
})();
</script>

<script>
/* ==UserScript==
 * @name         Sales Gamify Console (v2.3 UI: ルール自由編集・CSV取込・安定化)
 * @namespace    https://habitica.com/
 * @version      2.3.0
 * @description  Habitica上に営業ゲーミフィケーション設定UIを追加。スコア/アポ/ラベル/CSV/ダッシュボードを編集。読み込み完了と同時に表示ボタンを出すよう安定化。
 * @match        https://habitica.com/*
 * @run-at       document-end
 * @grant        GM_addStyle
 * ==/UserScript== */

(() => {
  /* ====== 基本ユーティリティ ====== */
  const LS_KEY  = "sgc.profile.v3";
  const LS_VIEW = "sgc.view.v3";
  const LS_UNDO = "sgc.undo.v1";
  const MAX_UNDO = 8;
  const PIN_KEY = "sgc_pin";

  const h = (html) => { const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstElementChild; };
  const asNum=(v,d=0)=>{ const n=Number(v); return Number.isFinite(n)?n:d; };
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const load=(k,def={})=>{ try{ return JSON.parse(localStorage.getItem(k)||"")||def; }catch{ return def; } };
  const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v||{}));
  const toast=(msg,bad=false)=>{ const el=h(`<div class="sgc-toast" style="background:${bad?"#c0392b":"#222"}">${msg}</div>`); document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };
  const loadProfile=()=>load(LS_KEY,{ tenant:"default", baseUrl:"", token:"" });
  const saveProfile=(p)=>save(LS_KEY,p);

  const headers=(p)=>{ const hd={"Accept":"application/json"}; if(p?.token){ hd.Authorization=`Bearer ${p.token}`; } return hd; };
  const apiGET=async(url,p)=>{ const r=await fetch(url,{headers:headers(p)}); if(!r.ok) throw new Error(String(r.status)); return r.json(); };
  const apiPUT=async(url,body,p)=>{ const r=await fetch(url,{method:"PUT",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); try{return await r.json();}catch{return {ok:true}} };
  const apiPOST=async(url,body,p)=>{ const r=await fetch(url,{method:"POST",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); try{return await r.json();}catch{return {ok:true}} };
  const apiPOSTForm=async(url,form,p)=>{ const r=await fetch(url,{method:"POST",headers:headers(p),body:form}); if(!r.ok) throw new Error(String(r.status)); try{return await r.json();}catch{return {ok:true}} };

  /* ====== スタイル（オリジナル + 使い勝手改良） ====== */
  GM_addStyle(`
    #sgc-fab{position:fixed; top:110px; right:18px; z-index:2147483646;
      background:#6c5ce7; color:#fff; border-radius:14px; padding:10px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,.25); font-weight:700; display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none}
    #sgc-fab:hover{filter:brightness(1.06)}
    #sgc-modal-mask{position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:2147483645; display:none}
    #sgc-modal{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      z-index:2147483646; width:min(1160px,96vw); max-height:88vh; background:#fff; border-radius:14px;
      overflow:hidden; box-shadow:0 24px 48px rgba(0,0,0,.25); display:none;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .sgc-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f7f7fb;border-bottom:1px solid #ececf5;gap:12px}
    .sgc-title{font-weight:800}
    .sgc-kv{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sgc-tabs{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid #f1f1f6;flex-wrap:wrap}
    .sgc-tab{padding:6px 10px;border-radius:8px;font-weight:700;color:#555;cursor:pointer}
    .sgc-tab.active{background:#6c5ce7;color:#fff}
    .sgc-body{padding:14px;max-height:calc(88vh - 134px);overflow:auto}
    .sgc-row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;padding:8px 0}
    .sgc-row input,.sgc-row select,.sgc-row textarea{border:1px solid #dfe3f0;border-radius:8px;padding:9px 10px;width:100%;font-size:14px;background:#fff}
    .sgc-help{font-size:12px;color:#777}
    .sgc-actions{position:sticky; bottom:0; background:#fff; z-index:1;
      display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #ececf5;align-items:center}
    .sgc-btn{background:#e9e9f4;border:none;padding:9px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .sgc-btn.primary{background:#6c5ce7;color:#fff}
    .sgc-badge{background:#f0efff;color:#5c54d6;border-radius:999px;padding:3px 8px;font-size:12px}
    .sgc-toast{position:fixed;right:16px;bottom:16px;background:#222;color:#fff;padding:10px 14px;border-radius:12px;z-index:2147483647;opacity:.95}
    .sgc-list{display:flex;flex-direction:column;gap:8px}
    .sgc-card{border:1px solid #e8e8f5;border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .sgc-card .full{grid-column:1 / -1}
    .sgc-card .muted{color:#777;font-size:12px}
    .sgc-del{background:#fff;border:1px solid #e1e1ef}
    .sgc-bare{border:1px dashed #ddd;border-radius:10px;padding:10px}
    .sgc-row-compact{display:flex;gap:8px;align-items:center}
    /* HubSpot行をワイドに：3カラム(ラベルID/タイトル/削除) */
    .sgc-card-hub{grid-template-columns:2fr 3fr 120px}
    .sgc-card-hub input{width:100%}
    .sgc-pin-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:#555}
    .sgc-pin-toggle input{accent-color:#6c5ce7}
    #sgc-fab.pinned{background:#4d3cd1}
    .sgc-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    .sgc-table th,.sgc-table td{padding:8px 10px;border-bottom:1px solid #ececf5;text-align:left;vertical-align:top}
    .sgc-table th{background:#f7f7fb;color:#555;font-weight:700}
    .sgc-table tbody tr:hover{background:#fafaff}
    .sgc-compact{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sgc-filter{margin-top:10px}
    .sgc-cols{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
    .sgc-col{flex:1 1 360px;min-width:320px;display:flex;flex-direction:column;gap:10px}
    .sgc-card-shop{grid-template-columns:1fr 120px 120px 1fr 140px}
    .sgc-card-shop .full{grid-column:1/-1}
    .sgc-card-shop input[type="number"]{width:100%}
    .sgc-card-purchase{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .sgc-card-purchase .full{grid-column:1/-1}
    @media(max-width:768px){
      .sgc-row{grid-template-columns:1fr}
      .sgc-card{grid-template-columns:1fr}
      .sgc-card-hub{grid-template-columns:1fr}
      .sgc-card-shop{grid-template-columns:1fr}
      .sgc-card-purchase{grid-template-columns:1fr}
    }
  `);

  /* ====== 固定ボタン ====== */
  const isPinned = ()=> localStorage.getItem(PIN_KEY)==="1";
  const setPinned = (flag)=>{ if(flag){ localStorage.setItem(PIN_KEY,"1"); } else { localStorage.removeItem(PIN_KEY); } syncFabState(); maintainFab(); };

  function syncFabState(){
    const fab = document.getElementById("sgc-fab");
    if(fab){
      fab.classList.toggle("pinned", isPinned());
    }
    if(modal){
      const chk = modal.querySelector("#sgc-pin");
      if(chk) chk.checked = isPinned();
    }
  }

  function ensureFab(){
    let fab = document.getElementById("sgc-fab");
    if(!fab){
      fab = h(`<div id="sgc-fab" title="Sales Gamify Console">⚙️ 設定</div>`);
      fab.addEventListener("click", openModal);
      document.body.appendChild(fab);
    }
    syncFabState();
  }

  function maintainFab(){
    if(isPinned()){
      requestAnimationFrame(()=>ensureFab());
    }
  }

  function setupFabObserver(){
    if(fabObserver) return;
    fabObserver = new MutationObserver(()=> maintainFab());
    fabObserver.observe(document.body,{ childList:true, subtree:true });
  }

  /* ====== モーダル作成 ====== */
  let profile={}, currentTab="score", rulesCache=null, labelsCache=null;
  let adjustmentsCache=[], shopItemsCache=[], auditCache=[];
  let fabObserver=null;
  let modal, bodyArea;

  function ensureModal(){
    if(document.getElementById("sgc-modal")) return;

    document.body.appendChild(h(`<div id="sgc-modal-mask"></div>`));

    modal = h(`
      <div id="sgc-modal" role="dialog" aria-modal="true" aria-label="Sales Gamify Console">
        <div class="sgc-hd">
          <div class="sgc-kv"><div class="sgc-title">Sales Gamify Console</div><span class="sgc-badge">UI全XP編集+CSV</span></div>
          <div class="sgc-kv">
            <label style="font-size:12px;color:#666">Tenant:</label>
            <input id="sgc-tenant" style="width:180px" placeholder="default">
            <label style="font-size:12px;color:#666">BaseURL:</label>
            <input id="sgc-base" style="width:300px" placeholder="https://sales-gamify.onrender.com">
            <label style="font-size:12px;color:#666">Token:</label>
            <input id="sgc-token" style="width:240px" placeholder="(Bearer不要)">
            <label class="sgc-pin-toggle"><input id="sgc-pin" type="checkbox"> ピン留め</label>
            <button id="sgc-ping" class="sgc-btn">Ping</button>
            <button id="sgc-save-top" class="sgc-btn primary">保存</button>
            <button id="sgc-close" class="sgc-btn">閉じる</button>
          </div>
        </div>
        <div class="sgc-tabs" id="sgc-tabs"></div>
        <div id="sgc-body" class="sgc-body"></div>
        <div class="sgc-actions">
          <button id="sgc-save" class="sgc-btn primary">保存</button>
        </div>
      </div>
    `);
    document.body.appendChild(modal);

    bodyArea = modal.querySelector("#sgc-body");
    modal.querySelector("#sgc-ping").addEventListener("click", doPing);
    modal.querySelector("#sgc-close").addEventListener("click", closeModal);
    modal.querySelector("#sgc-save").addEventListener("click", saveAll);
    modal.querySelector("#sgc-save-top").addEventListener("click", saveAll);
    modal.querySelector("#sgc-pin").addEventListener("change", (e)=>{
      const flag = !!e.target.checked;
      setPinned(flag);
      if(flag){ toast("設定ボタンをピン留めしました"); }
      else{ toast("ピン留めを解除しました"); }
      ensureFab();
    });
    document.addEventListener("keydown",(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); saveAll(); }});
    document.getElementById("sgc-modal-mask").addEventListener("click", closeModal);
  }

  function openModal(){
    ensureModal();
    syncFabState();
    profile=loadProfile();
    document.getElementById("sgc-modal-mask").style.display="block";
    modal.style.display="block";
    modal.querySelector("#sgc-tenant").value=profile.tenant||"default";
    modal.querySelector("#sgc-base").value=profile.baseUrl||"";
    modal.querySelector("#sgc-token").value=profile.token||"";
    initTabs();
    loadAll();
  }
  function closeModal(){
    modal.style.display="none";
    document.getElementById("sgc-modal-mask").style.display="none";
  }

  function initTabs(){
    const tabs = modal.querySelector("#sgc-tabs");
    tabs.innerHTML="";
    const defs=[
      {id:"score",  label:"スコア設定"},
      {id:"hub",    label:"HubSpot連携（ラベル）"},
      {id:"approve",label:"承認・売上（CSV連動）"},
      {id:"csv",    label:"CSV取込"},
      {id:"dash",   label:"ダッシュボード"},
      {id:"adjust", label:"手動調整"},
      {id:"shop",   label:"ショップ"},
      {id:"audit",  label:"監査ログ"},
    ];
    defs.forEach(t=>{
      const el=h(`<div class="sgc-tab" data-tab="${t.id}">${t.label}</div>`);
      if(t.id===currentTab) el.classList.add("active");
      el.addEventListener("click",()=>{ currentTab=t.id; render(); });
      tabs.appendChild(el);
    });
    render();
  }

  function baseURL(){ return String(modal.querySelector("#sgc-base").value||"").replace(/\/+$/,""); }
  function tenant(){ return String(modal.querySelector("#sgc-tenant").value||"default"); }
  function token(){ return String(modal.querySelector("#sgc-token").value||""); }
  function ensureProfileFromInputs(){ profile={ tenant:tenant(), baseUrl:baseURL(), token:token() }; saveProfile(profile); }

  async function doPing(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ toast("BaseURL を入力してください", true); return; }
    try{
      const j=await apiGET(`${profile.baseUrl}/healthz`, profile);
      toast("OK: 接続");
      console.log("healthz:", j);
    }catch(e){ toast("接続エラー", true); }
  }

  /* ====== データロード & 保存 ====== */
  async function loadAll(){
    ensureProfileFromInputs();
    if(!profile.baseUrl) return;
    try{
      const [rules, labels] = await Promise.all([
        apiGET(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/rules`, profile).catch(()=>({})),
        apiGET(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/labels`, profile).catch(()=>({ items:[] })),
      ]);
      rulesCache = rules || {};
      labelsCache = Array.isArray(labels?.items) ? labels.items : [];
      adjustmentsCache = [];
      shopItemsCache = [];
      auditCache = [];
      render();
    }catch(e){ console.warn(e); toast("読み込みエラー", true); }
  }

  async function saveAll(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ toast("BaseURL を入力してください", true); return; }

    collectScoreToCaches();
    collectApproveToCache();
    collectHubToCache();

    try{
      await apiPUT(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/rules`, rulesCache||{}, profile);
      await apiPUT(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/labels`, { items: labelsCache||[] }, profile);
      toast("保存しました");
      await loadAll();
    }catch(e){
      console.error(e);
      const msg = String(e||"");
      if (msg.includes("401")) {
        toast("保存に失敗: 401 Unauthorized（テナント名とトークンの組み合わせが Render の SGC_TOKENS と一致していません）", true);
      } else {
        toast("保存に失敗: "+msg, true);
      }
    }
  }

  /* ====== タブ描画 ====== */
  function render(){
    modal.querySelectorAll(".sgc-tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===currentTab));
    bodyArea.innerHTML="";
    if(currentTab==="score") renderScore();
    else if(currentTab==="hub") renderHub();
    else if(currentTab==="approve") renderApprove();
    else if(currentTab==="csv") renderCSV();
    else if(currentTab==="dash") renderDash();
    else if(currentTab==="adjust") renderAdjust();
    else if(currentTab==="shop") renderShop();
    else if(currentTab==="audit") renderAudit();
  }

  function safeRules(){
    const r = rulesCache || {};
    r.xp = r.xp || {};
    r.xp.call = r.xp.call || {};
    r.xp.minutes = r.xp.minutes || {};
    r.xp.appointment = r.xp.appointment || {};
    r.approval = r.approval || { enabled:true, xp:0, badge:"承認" };
    r.sales = r.sales || { milestones: [] };
    return r;
  }

  /* ====== スコア設定 ====== */
  function renderScore(){
    const r=safeRules();
    const perCall = Number(r?.xp?.call?.perCall ?? 1);
    const unitMin = clamp(Math.round(Number(r?.xp?.minutes?.unitMs || 300000)/60000) || 5, 1, 60);
    const perUnit = Number(r?.xp?.minutes?.perUnitMs ?? r?.xp?.minutes?.per5min ?? 2);
    const list = Array.isArray(r?.xp?.minutes?.list) ? r.xp.minutes.list : [{min:unitMin,xp:perUnit}];
    const apXP    = Number(r?.xp?.appointment?.xp ?? 20);
    const apBadge = String(r?.xp?.appointment?.badge || "🏅新規アポ獲得");

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>発信 1コールあたりXP</label>
        <input id="sgc-xp-call" type="number" min="0" step="1" value="${perCall}">
      </div>
    `));

    const box = h(`<div class="sgc-row"><label>通話時間に応じたXP</label>
      <div class="sgc-bare">
        <div id="sgc-minutes-list" class="sgc-list"></div>
        <div style="margin-top:8px"><button id="sgc-add-min" class="sgc-btn">＋ 行を追加</button>
          <span class="sgc-help">※サーバ側は当面「先頭1行」を使用。全行は <code>xp.minutes.list</code> に保存し将来拡張します。</span>
        </div>
      </div>
    </div>`);
    bodyArea.appendChild(box);

    const listEl = box.querySelector("#sgc-minutes-list");
    function pushMinuteRow(v){ listEl.appendChild(renderMinuteRow(v)); }
    function renderMinuteRow(v){
      const row = h(`<div class="sgc-row-compact">
        <span>毎</span><input class="sgc-min" type="number" min="1" value="${Number(v?.min)||5}" style="width:80px">
        <span>分ごとに</span><input class="sgc-min-xp" type="number" min="0" value="${Number(v?.xp)||0}" style="width:120px"><span>XP</span>
        <button class="sgc-btn sgc-del">削除</button>
      </div>`);
      row.querySelector(".sgc-del").addEventListener("click",()=>row.remove());
      return row;
    }
    list.forEach(pushMinuteRow);
    box.querySelector("#sgc-add-min").addEventListener("click",()=>pushMinuteRow({min:5,xp:0}));

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>既定：新規アポ（HubSpot）</label>
        <div class="sgc-row-compact">
          <input id="sgc-ap-xp" type="number" min="0" step="1" value="${apXP}" style="width:120px"> <span>XP</span>
          <span style="width:10px"></span>
          <span>バッジ名</span>
          <input id="sgc-ap-badge" type="text" value="${apBadge}" placeholder="例: 🏅新規アポ獲得" style="width:300px">
        </div>
        <div class="sgc-help">「新規アポ」の既定値（カスタムOutcomeに同名があればそちらが優先）。</div>
      </div>
    `));

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>カスタムOutcome（HubSpotラベル）</label>
        <div>
          <div class="sgc-help">HubSpot連携タブでラベルID/タイトルを登録すると、ここに一覧が出ます。各ラベルごとに「有効/無効・XP・バッジ」を設定可能。</div>
          <div id="sgc-custom-list" class="sgc-list"></div>
          <div class="sgc-help">行の追加/削除は「HubSpot連携」タブで行ってください。</div>
        </div>
      </div>
    `));

    const list2=bodyArea.querySelector("#sgc-custom-list");
    ensureLabelsArray();
    labelsCache.forEach(it=> list2.appendChild(renderCustomCard(it)));
    if(labelsCache.length===0){
      list2.appendChild(h(`<div class="sgc-help">※ まだラベルがありません。まず「HubSpot連携」タブでラベルを追加してください。</div>`));
    }

    function renderCustomCard(item){
      const enabled = !!item.enabled;
      const xp = Number.isFinite(Number(item.xp)) ? Number(item.xp) : "";
      const badge = item.badge || "";
      const el=h(`
        <div class="sgc-card" data-id="${item.id||""}" data-title="${item.title||""}">
          <div><label class="muted">ラベルID</label><div><strong>${item.id||"(未指定)"}</strong></div></div>
          <div><label class="muted">タイトル</label><div>${item.title||"(未指定)"}</div></div>
          <div class="full" style="display:flex;gap:10px;align-items:center">
            <label style="display:flex;gap:6px;align-items:center"><input class="sgc-en" type="checkbox" ${enabled?"checked":""}> 有効にする</label>
            <span>XP</span><input class="sgc-xp" type="number" min="0" step="1" value="${xp}" style="max-width:120px">
            <span>バッジ</span><input class="sgc-badge" type="text" value="${badge}" placeholder="例: 🏷︎見込みA 成果" style="max-width:300px">
          </div>
        </div>
      `);
      return el;
    }
  }

  function collectScoreToCaches(){
    const r=safeRules();
    r.xp.call.perCall = asNum(modal.querySelector("#sgc-xp-call")?.value,0);

    const rows=[...modal.querySelectorAll("#sgc-minutes-list .sgc-row-compact")];
    const list = rows.map(row=>({ min:asNum(row.querySelector(".sgc-min").value,5), xp:asNum(row.querySelector(".sgc-min-xp").value,0) }));
    if(list.length===0) list.push({min:5,xp:0});
    r.xp.minutes.unitMs = list[0].min*60*1000;
    r.xp.minutes.perUnitMs = list[0].xp;
    if(list[0].min===5) r.xp.minutes.per5min=list[0].xp; else delete r.xp.minutes.per5min;
    r.xp.minutes.list = list;

    r.xp.appointment.xp = asNum(modal.querySelector("#sgc-ap-xp")?.value,20);
    r.xp.appointment.badge = String(modal.querySelector("#sgc-ap-badge")?.value||"");

    const listEl=[...modal.querySelectorAll("#sgc-custom-list .sgc-card")];
    listEl.forEach(card=>{
      const id   = card.getAttribute("data-id")||"";
      const tit  = card.getAttribute("data-title")||"";
      const en   = card.querySelector(".sgc-en").checked;
      const xp   = card.querySelector(".sgc-xp").value;
      const bd   = card.querySelector(".sgc-badge").value;
      const it = labelsCache.find(x=>(x.id||"")===(id||"") && (x.title||"")===(tit||""));
      if(it){
        it.enabled = !!en;
        const v = Number(xp);
        it.xp = Number.isFinite(v) ? v : undefined;
        it.badge = String(bd||"") || undefined;
      }
    });

    rulesCache=r;
  }

  /* ====== HubSpot連携（ラベル） ====== */
  function ensureLabelsArray(){ labelsCache = Array.isArray(labelsCache)? labelsCache : []; }

  function renderHub(){
    ensureLabelsArray();
    bodyArea.appendChild(h(`<div class="sgc-help">HubSpotの「ラベルID」と「タイトル」を行単位で追加してください。保存後、「スコア設定」タブに反映されます。</div>`));

    const area=h(`<div id="sgc-hub-list" class="sgc-list"></div>`);
    bodyArea.appendChild(area);

    const toolbar=h(`<div class="sgc-kv" style="margin:8px 0">
        <button id="sgc-add-row" class="sgc-btn">＋ 行を追加</button>
        <button id="sgc-del-all" class="sgc-btn sgc-del">全行をクリア</button>
      </div>`);
    bodyArea.appendChild(toolbar);

    labelsCache.forEach(it=> area.appendChild(renderHubRow(it)));
    if(labelsCache.length===0){
      area.appendChild(renderHubRow({id:"", title:""}));
    }

    bodyArea.querySelector("#sgc-add-row").addEventListener("click",()=> area.appendChild(renderHubRow({id:"", title:""})));
    bodyArea.querySelector("#sgc-del-all").addEventListener("click",()=>{ labelsCache=[]; area.innerHTML=""; area.appendChild(renderHubRow({id:"", title:""})); });

    function renderHubRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-hub">
          <div><label class="muted">HubSpot ラベルID</label><input class="sgc-h-id" value="${item.id||""}" placeholder="例: ac590467-..."></div>
          <div><label class="muted">ラベル名/タイトル</label><input class="sgc-h-title" value="${item.title||""}" placeholder="例: ニーズ無し / 見込みA"></div>
          <div style="display:flex;justify-content:flex-end;align-items:flex-end">
            <button class="sgc-btn sgc-del">削除</button>
          </div>
        </div>
      `);
      row.querySelector(".sgc-del").addEventListener("click",()=> row.remove());
      if(item.enabled) row.setAttribute("data-enabled","1");
      if(Number.isFinite(Number(item.xp))) row.setAttribute("data-xp", String(item.xp));
      if(item.badge) row.setAttribute("data-badge", item.badge);
      return row;
    }
  }

  function collectHubToCache(){
    const list=[...modal.querySelectorAll("#sgc-hub-list .sgc-card")];
    const items=[];
    for(const row of list){
      const id = String(row.querySelector(".sgc-h-id")?.value||"").trim();
      const title = String(row.querySelector(".sgc-h-title")?.value||"").trim();
      if(!id && !title) continue;
      items.push({
        id, title,
        enabled: row.getAttribute("data-enabled")==="1" ? true : undefined,
        xp: Number.isFinite(Number(row.getAttribute("data-xp"))) ? Number(row.getAttribute("data-xp")) : undefined,
        badge: row.getAttribute("data-badge") || undefined,
      });
    }
    labelsCache = items;
  }

  /* ====== 承認・売上（CSV連動） ====== */
  function renderApprove(){
    const r=safeRules();
    const ap = r.approval || { enabled:true, xp:0, badge:"承認" };
    const milestones = Array.isArray(r.sales?.milestones) ? r.sales.milestones : [];

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>承認（Approval）時のXP</label>
        <div class="sgc-row-compact">
          <input id="sgc-approve-xp" type="number" min="0" step="1" value="${Number(ap.xp)||0}" style="width:120px"> <span>XP</span>
          <span>バッジ</span><input id="sgc-approve-badge" type="text" value="${String(ap.badge||"承認")}" style="width:240px">
          <label style="display:flex;gap:6px;align-items:center"><input id="sgc-approve-en" type="checkbox" ${ap.enabled!==false?"checked":""}> 有効</label>
        </div>
      </div>
    `));

    const wrap=h(`<div class="sgc-row"><label>売上達成（マイルストン）</label>
      <div class="sgc-bare">
        <div id="sgc-ms-list" class="sgc-list"></div>
        <div style="margin-top:8px"><button id="sgc-add-ms" class="sgc-btn">＋ マイルストン追加</button></div>
      </div>
    </div>`);
    bodyArea.appendChild(wrap);

    const msList=wrap.querySelector("#sgc-ms-list");
    function pushMsRow(v){ msList.appendChild(renderMsRow(v)); }
    function renderMsRow(v){
      const row=h(`<div class="sgc-row-compact">
        <span>金額（到達毎）</span><input class="sgc-ms-amt" type="number" min="0" value="${Number(v?.amount)||100000}" style="width:160px">
        <span>XP</span><input class="sgc-ms-xp" type="number" min="0" value="${Number(v?.xp)||50}" style="width:120px">
        <span>バッジ</span><input class="sgc-ms-badge" type="text" value="${String(v?.badge||"売上"+(Number(v?.amount)||100000).toLocaleString()+"達成")}" style="width:280px">
        <button class="sgc-btn sgc-del">削除</button>
      </div>`);
      row.querySelector(".sgc-del").addEventListener("click",()=>row.remove());
      return row;
    }
    (milestones.length?milestones:[{amount:100000,xp:50,badge:"売上10万円達成"}]).forEach(pushMsRow);
    wrap.querySelector("#sgc-add-ms").addEventListener("click",()=>pushMsRow({amount:100000,xp:50}));
  }

  function collectApproveToCache(){
    const r=safeRules();
    r.approval = {
      enabled: !!modal.querySelector("#sgc-approve-en")?.checked,
      xp: asNum(modal.querySelector("#sgc-approve-xp")?.value,0),
      badge: String(modal.querySelector("#sgc-approve-badge")?.value||"承認")
    };
    const rows=[...modal.querySelectorAll("#sgc-ms-list .sgc-row-compact")];
    r.sales = r.sales || {};
    r.sales.milestones = rows.map(row=>({
      amount: asNum(row.querySelector(".sgc-ms-amt").value,0),
      xp: asNum(row.querySelector(".sgc-ms-xp").value,0),
      badge: String(row.querySelector(".sgc-ms-badge").value||"")
    }));
    rulesCache=r;
  }

  function formatDateTime(iso){
    if(!iso) return "-";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return String(iso);
    return d.toLocaleString("ja-JP",{ hour12:false });
  }

  async function fetchAdjustments(limit=50, userIdFilter=""){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ adjustmentsCache=[]; return adjustmentsCache; }
    const params = new URLSearchParams();
    params.set("limit", String(clamp(limit, 1, 200)));
    if(userIdFilter) params.set("userId", userIdFilter);
    const url = `${baseURL()}/tenant/${encodeURIComponent(tenant())}/adjustments?${params.toString()}`;
    try{
      const res = await apiGET(url, profile);
      adjustmentsCache = Array.isArray(res?.items) ? res.items : [];
      return adjustmentsCache;
    }catch(e){
      console.error("fetchAdjustments", e);
      throw e;
    }
  }

  async function fetchShopItems(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ shopItemsCache=[]; return shopItemsCache; }
    const url = `${baseURL()}/tenant/${encodeURIComponent(tenant())}/shop/items`;
    try{
      const res = await apiGET(url, profile);
      shopItemsCache = Array.isArray(res?.items) ? res.items : [];
      return shopItemsCache;
    }catch(e){
      console.error("fetchShopItems", e);
      throw e;
    }
  }

  async function fetchAudit(limit=100){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ auditCache=[]; return auditCache; }
    const params = new URLSearchParams();
    params.set("limit", String(clamp(limit, 1, 200)));
    const url = `${baseURL()}/tenant/${encodeURIComponent(tenant())}/audit?${params.toString()}`;
    try{
      const res = await apiGET(url, profile);
      auditCache = Array.isArray(res?.items) ? res.items : [];
      return auditCache;
    }catch(e){
      console.error("fetchAudit", e);
      throw e;
    }
  }

  function summarizeAuditDetail(ev){
    const d = ev?.detail;
    try{
      if(ev?.action==="adjust.create" && d){
        const xp = Number(d.deltaXp);
        const xpText = Number.isFinite(xp) ? `${xp>=0?"+":""}${xp}XP` : "";
        const bits = [
          d.userId ? String(d.userId) : "",
          xpText,
          d.badge ? `badge:${d.badge}` : "",
          d.note ? `note:${d.note}` : "",
        ].filter(Boolean);
        return bits.join(" / ");
      }
      if(ev?.action==="shop.item.put" && d){
        return `items=${d.count ?? 0}`;
      }
      if(ev?.action==="shop.purchase" && d){
        const xp = Number(d.deltaXp);
        const parts = [
          d.title ? String(d.title) : "",
          d.qty != null ? `qty:${d.qty}` : "",
          d.userId ? `user:${d.userId}` : "",
          Number.isFinite(xp) ? `${xp>=0?"+":""}${xp}XP` : "",
          d.newStock != null ? `stock:${d.newStock}` : "",
        ].filter(Boolean);
        return parts.join(" / ");
      }
    }catch{}
    if(!d) return "";
    if(typeof d === "string") return d;
    try{
      return JSON.stringify(d);
    }catch{
      return "";
    }
  }

  /* ====== CSV取込 ====== */
  function renderCSV(){
    const box=h(`
      <div class="sgc-row"><label>CSVのアップロード</label>
        <div>
          <div class="sgc-row-compact">
            <input id="sgc-csv-file" type="file" accept=".csv">
            <button id="sgc-upload" class="sgc-btn">アップロード</button>
            <button id="sgc-open-admin" class="sgc-btn">管理画面を開く</button>
          </div>
          <div class="sgc-help">まずは <code>/admin/upload</code> にPOSTします。ダメなら <code>/admin/csv</code> → <code>/admin/import</code> の順に試行。全部ダメなら管理画面 /admin を開きます。</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(box);
    box.querySelector("#sgc-upload").addEventListener("click", doUpload);
    box.querySelector("#sgc-open-admin").addEventListener("click", ()=> window.open(`${baseURL()}/admin?tenant=${encodeURIComponent(tenant())}`,"_blank"));

    async function doUpload(){
      ensureProfileFromInputs();
      const f=modal.querySelector("#sgc-csv-file")?.files?.[0];
      if(!f){ toast("CSVファイルを選択してください", true); return; }
      const tries=[ "/admin/upload", "/admin/csv", "/admin/import" ];
      const form=new FormData(); form.append("file", f); form.append("tenant", tenant());
      for(const path of tries){
        try{
          await apiPOSTForm(`${baseURL()}${path}`, form, profile);
          toast("CSV取込を受け付けました");
          return;
        }catch(e){ console.warn("upload fail", path, e); }
      }
      toast("サーバ未対応のようです。管理画面から取り込みを行ってください。", true);
    }
  }

  /* ====== ダッシュボード ====== */
  function renderDash(){
    const b=h(`
      <div class="sgc-row"><label>ダッシュボード</label>
        <div class="sgc-kv">
          <button id="sgc-open-dash" class="sgc-btn">開く</button>
          <div class="sgc-help">BaseURL の <code>/admin/dashboard?tenant=...</code> を新規タブで開きます。</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(b);
    b.querySelector("#sgc-open-dash").addEventListener("click",()=> window.open(`${baseURL()}/admin/dashboard?tenant=${encodeURIComponent(tenant())}`,"_blank"));
  }

  function renderAdjust(){
    ensureProfileFromInputs();
    const form=h(`
      <div class="sgc-bare">
        <div class="sgc-compact">
          <input id="sgc-adj-user" placeholder="ユーザーID" style="width:160px">
          <input id="sgc-adj-name" placeholder="ユーザー名 (任意)" style="width:180px">
          <input id="sgc-adj-delta" type="number" step="1" value="10" style="width:120px">
          <input id="sgc-adj-badge" placeholder="バッジ (任意)" style="width:200px">
        </div>
        <div class="sgc-compact sgc-filter">
          <input id="sgc-adj-note" placeholder="メモ (任意)" style="flex:1;min-width:280px">
        </div>
        <div class="sgc-compact">
          <button id="sgc-adj-submit" class="sgc-btn primary">XPを登録</button>
          <button id="sgc-adj-reload" class="sgc-btn">履歴を再読込</button>
          <span class="sgc-help">XPは正負どちらも可。最新50件を表示します。</span>
        </div>
      </div>
    `);
    bodyArea.appendChild(form);

    const filterRow=h(`
      <div class="sgc-compact sgc-filter">
        <label style="font-size:13px;color:#555">履歴フィルタ（userId）</label>
        <input id="sgc-adj-filter" placeholder="例: u001" style="width:160px">
        <button id="sgc-adj-filter-btn" class="sgc-btn">適用</button>
        <button id="sgc-adj-filter-clear" class="sgc-btn sgc-del">解除</button>
      </div>
    `);
    bodyArea.appendChild(filterRow);

    const table=h(`
      <table class="sgc-table">
        <thead>
          <tr>
            <th>時刻</th>
            <th>ユーザー</th>
            <th>XP</th>
            <th>バッジ</th>
            <th>メモ</th>
            <th>source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `);
    const tbody=table.querySelector("tbody");
    bodyArea.appendChild(table);

    const status=h(`<div class="sgc-help" id="sgc-adj-status"></div>`);
    bodyArea.appendChild(status);

    let currentFilter="";

    function renderRows(){
      tbody.innerHTML="";
      if(!adjustmentsCache.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=6;
        td.style.color="#777";
        td.textContent="履歴がありません";
        tr.appendChild(td);
        tbody.appendChild(tr);
        status.textContent="";
        return;
      }
      adjustmentsCache.forEach(item=>{
        const tr=document.createElement("tr");
        const cells=[
          formatDateTime(item?.createdAt),
          item?.userName ? `${item.userName} (${item.userId||""})` : item?.userId || "",
          typeof item?.deltaXp==="number" ? `${item.deltaXp>=0?"+":""}${item.deltaXp}` : "",
          item?.badge || "",
          item?.note || "",
          item?.source || "",
        ];
        cells.forEach((txt,idx)=>{
          const td=document.createElement("td");
          td.textContent = txt ?? "";
          if(idx===2) td.style.fontWeight="700";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      status.textContent = `取得件数: ${adjustmentsCache.length}${currentFilter ? ` / userId=${currentFilter}` : ""}`;
    }

    async function reload(filterVal=currentFilter){
      currentFilter = String(filterVal || "").trim();
      try{
        await fetchAdjustments(50, currentFilter);
        renderRows();
      }catch(e){
        toast("履歴の取得に失敗しました", true);
      }
    }

    async function submitAdjustment(){
      ensureProfileFromInputs();
      if(!profile.baseUrl){
        toast("BaseURL を入力してください", true);
        return;
      }
      const userId = form.querySelector("#sgc-adj-user").value.trim();
      const userName = form.querySelector("#sgc-adj-name").value.trim();
      const deltaRaw = Number(form.querySelector("#sgc-adj-delta").value);
      const badge = form.querySelector("#sgc-adj-badge").value.trim();
      const note = form.querySelector("#sgc-adj-note").value.trim();
      if(!userId){
        toast("ユーザーIDを入力してください", true);
        form.querySelector("#sgc-adj-user").focus();
        return;
      }
      if(!Number.isFinite(deltaRaw)){
        toast("XP増減は整数で入力してください", true);
        form.querySelector("#sgc-adj-delta").focus();
        return;
      }
      const payload={
        userId,
        userName: userName || undefined,
        deltaXp: Math.trunc(deltaRaw),
        badge: badge || undefined,
        note: note || undefined,
      };
      try{
        await apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/adjustments`, payload, profile);
        toast("手動XPを登録しました");
        form.querySelector("#sgc-adj-note").value="";
        await reload(currentFilter);
      }catch(e){
        console.error("adjustment.submit", e);
        const msg=String(e||"");
        if(msg.includes("401")) toast("保存に失敗: 401 Unauthorized", true);
        else toast("保存に失敗しました", true);
      }
    }

    form.querySelector("#sgc-adj-submit").addEventListener("click", submitAdjustment);
    form.querySelector("#sgc-adj-reload").addEventListener("click", ()=>reload(currentFilter));
    filterRow.querySelector("#sgc-adj-filter-btn").addEventListener("click", ()=>{
      const v=filterRow.querySelector("#sgc-adj-filter").value;
      reload(v);
    });
    filterRow.querySelector("#sgc-adj-filter-clear").addEventListener("click", ()=>{
      filterRow.querySelector("#sgc-adj-filter").value="";
      reload("");
    });
    filterRow.querySelector("#sgc-adj-filter").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        reload(e.target.value);
      }
    });

    reload("");
  }

  function renderShop(){
    ensureProfileFromInputs();
    bodyArea.appendChild(h(`<div class="sgc-help">ショップ品目を管理し、購入処理を登録します。</div>`));
    const cols=h(`<div class="sgc-cols"></div>`);
    bodyArea.appendChild(cols);
    const manageCol=h(`<div class="sgc-col"></div>`);
    const purchaseCol=h(`<div class="sgc-col"></div>`);
    cols.appendChild(manageCol);
    cols.appendChild(purchaseCol);

    const manageCard=h(`
      <div class="sgc-bare">
        <div class="sgc-compact">
          <button id="sgc-shop-add" class="sgc-btn">＋ 品目を追加</button>
          <button id="sgc-shop-save" class="sgc-btn primary">保存</button>
          <button id="sgc-shop-refresh" class="sgc-btn">再読込</button>
        </div>
        <div id="sgc-shop-list" class="sgc-list" style="margin-top:10px"></div>
        <div class="sgc-help">価格はXPの正の整数。stockを空欄にすると無制限になります。</div>
      </div>
    `);
    manageCol.appendChild(manageCard);
    const listEl=manageCard.querySelector("#sgc-shop-list");

    const purchaseCard=h(`
      <div class="sgc-bare">
        <div class="sgc-card sgc-card-purchase">
          <div>
            <label class="muted">ユーザーID</label>
            <input id="sgc-shop-buy-user" placeholder="例: u001">
          </div>
          <div>
            <label class="muted">ユーザー名 (任意)</label>
            <input id="sgc-shop-buy-name" placeholder="例: 田中">
          </div>
          <div class="full">
            <label class="muted">品目</label>
            <select id="sgc-shop-buy-item"></select>
          </div>
          <div>
            <label class="muted">数量</label>
            <input id="sgc-shop-buy-qty" type="number" min="1" step="1" value="1">
          </div>
          <div class="full sgc-compact">
            <button id="sgc-shop-buy-run" class="sgc-btn primary">購入処理</button>
            <button id="sgc-shop-buy-refresh" class="sgc-btn">品目を再読込</button>
          </div>
          <div class="full sgc-help">購入するとXPが減算され、在庫が更新されます。</div>
        </div>
      </div>
    `);
    purchaseCol.appendChild(purchaseCard);

    function renderItemRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-shop">
          <div class="full">
            <label class="muted">品目名</label>
            <input class="sgc-shop-title" placeholder="例: スタバ券">
          </div>
          <div>
            <label class="muted">価格 (XP)</label>
            <input class="sgc-shop-price" type="number" min="1" step="1">
          </div>
          <div>
            <label class="muted">在庫</label>
            <input class="sgc-shop-stock" type="number" min="0" step="1" placeholder="空欄=∞">
          </div>
          <div>
            <label class="muted">購入時バッジ</label>
            <input class="sgc-shop-badge" placeholder="例: ☕ごほうび">
          </div>
          <div>
            <label class="muted">状態</label>
            <div style="display:flex;flex-direction:column;gap:8px">
              <label style="display:flex;align-items:center;gap:6px"><input class="sgc-shop-enabled" type="checkbox" checked> 有効</label>
              <button type="button" class="sgc-btn sgc-del sgc-shop-remove">削除</button>
            </div>
          </div>
        </div>
      `);
      row.dataset.id = item?.id || "";
      row.querySelector(".sgc-shop-title").value = item?.title || "";
      const priceVal = Number(item?.priceXp);
      row.querySelector(".sgc-shop-price").value = Number.isFinite(priceVal) ? String(priceVal) : "";
      row.querySelector(".sgc-shop-stock").value =
        item?.stock === null || item?.stock === undefined ? "" : String(item.stock);
      row.querySelector(".sgc-shop-badge").value = item?.badgeOnBuy || "";
      row.querySelector(".sgc-shop-enabled").checked = item?.enabled !== false;
      row.querySelector(".sgc-shop-remove").addEventListener("click",()=> row.remove());
      return row;
    }

    function renderShopRows(){
      listEl.innerHTML="";
      if(!shopItemsCache.length){
        listEl.appendChild(h(`<div class="sgc-help">まだ品目がありません。『＋ 品目を追加』から登録してください。</div>`));
        return;
      }
      shopItemsCache.forEach(item=>{
        listEl.appendChild(renderItemRow(item));
      });
    }

    function fillPurchaseItems(selectedId=""){
      const sel=purchaseCard.querySelector("#sgc-shop-buy-item");
      sel.innerHTML="";
      if(!shopItemsCache.length){
        const opt=document.createElement("option");
        opt.value="";
        opt.textContent="品目がありません";
        sel.appendChild(opt);
        sel.disabled=true;
        return;
      }
      sel.disabled=false;
      shopItemsCache.forEach(item=>{
        const opt=document.createElement("option");
        const stockLabel = item?.stock === null || item?.stock === undefined ? "在庫∞" : `在庫${item.stock}`;
        opt.value = item?.id || "";
        opt.textContent = `${item?.title || ""} / XP ${item?.priceXp ?? ""} / ${stockLabel}`;
        if(item?.enabled === false){
          opt.disabled=true;
          opt.textContent += " (無効)";
        }
        if(selectedId && item?.id === selectedId){
          opt.selected=true;
        }
        sel.appendChild(opt);
      });
    }

    async function reloadShop(preserveId=""){
      const currentSelect = preserveId || purchaseCard.querySelector("#sgc-shop-buy-item")?.value || "";
      try{
        await fetchShopItems();
        renderShopRows();
        fillPurchaseItems(currentSelect);
      }catch(e){
        toast("ショップの読み込みに失敗しました", true);
      }
    }

    async function saveItems(){
      ensureProfileFromInputs();
      if(!profile.baseUrl){
        toast("BaseURL を入力してください", true);
        return;
      }
      const rows=[...listEl.querySelectorAll(".sgc-card-shop")];
      const items=[];
      for(const row of rows){
        const title=row.querySelector(".sgc-shop-title").value.trim();
        const priceVal=Number(row.querySelector(".sgc-shop-price").value);
        const stockInput=row.querySelector(".sgc-shop-stock").value.trim();
        const badge=row.querySelector(".sgc-shop-badge").value.trim();
        const enabled=row.querySelector(".sgc-shop-enabled").checked;
        if(!title){
          toast("品目名を入力してください", true);
          row.querySelector(".sgc-shop-title").focus();
          return;
        }
        if(!Number.isFinite(priceVal) || priceVal <= 0 || !Number.isInteger(priceVal)){
          toast("価格は1以上の整数で入力してください", true);
          row.querySelector(".sgc-shop-price").focus();
          return;
        }
        let stockVal = null;
        if(stockInput !== ""){
          const n = Number(stockInput);
          if(!Number.isFinite(n) || n < 0 || !Number.isInteger(n)){
            toast("在庫は0以上の整数で入力してください", true);
            row.querySelector(".sgc-shop-stock").focus();
            return;
          }
          stockVal = Math.trunc(n);
        }
        const item = {
          title,
          priceXp: Math.trunc(priceVal),
          enabled,
        };
        const id = row.dataset.id?.trim();
        if(id) item.id = id;
        if(stockInput === ""){
          item.stock = null;
        }else if(stockVal !== null){
          item.stock = stockVal;
        }
        if(badge) item.badgeOnBuy = badge;
        items.push(item);
      }
      try{
        await apiPUT(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/shop/items`, { items }, profile);
        toast("ショップの品目を保存しました");
        await reloadShop();
      }catch(e){
        console.error("shop.save", e);
        const msg=String(e||"");
        if(msg.includes("401")) toast("保存に失敗: 401 Unauthorized", true);
        else if(msg.includes("price-invalid")) toast("保存に失敗: 価格が正の整数ではありません", true);
        else if(msg.includes("stock-invalid")) toast("保存に失敗: 在庫が0以上の整数ではありません", true);
        else toast("保存に失敗しました", true);
      }
    }

    async function runPurchase(){
      ensureProfileFromInputs();
      if(!profile.baseUrl){
        toast("BaseURL を入力してください", true);
        return;
      }
      const userId=purchaseCard.querySelector("#sgc-shop-buy-user").value.trim();
      const userName=purchaseCard.querySelector("#sgc-shop-buy-name").value.trim();
      const itemId=purchaseCard.querySelector("#sgc-shop-buy-item").value;
      const qtyVal=Number(purchaseCard.querySelector("#sgc-shop-buy-qty").value);
      if(!userId){
        toast("ユーザーIDを入力してください", true);
        purchaseCard.querySelector("#sgc-shop-buy-user").focus();
        return;
      }
      if(!itemId){
        toast("購入する品目を選択してください", true);
        return;
      }
      if(!Number.isFinite(qtyVal) || qtyVal <= 0 || !Number.isInteger(qtyVal)){
        toast("数量は1以上の整数で入力してください", true);
        purchaseCard.querySelector("#sgc-shop-buy-qty").focus();
        return;
      }
      const payload={
        userId,
        userName: userName || undefined,
        itemId,
        qty: Math.trunc(qtyVal),
      };
      try{
        const res=await apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/shop/purchase`, payload, profile);
        const newStock = res?.newStock;
        const stockLabel = newStock === null || newStock === undefined ? "在庫: ∞" : `在庫: ${newStock}`;
        toast(`購入を登録しました (${stockLabel})`);
        adjustmentsCache = [];
        await reloadShop(itemId);
      }catch(e){
        console.error("shop.purchase", e);
        const msg=String(e||"");
        if(msg.includes("401")) toast("購入に失敗: 401 Unauthorized", true);
        else if(msg.includes("404")) toast("購入に失敗: 品目が見つかりません", true);
        else if(msg.includes("stock-shortage")) toast("購入に失敗: 在庫が不足しています", true);
        else toast("購入に失敗しました", true);
      }
    }

    manageCard.querySelector("#sgc-shop-add").addEventListener("click",()=> listEl.appendChild(renderItemRow({ title:"", priceXp:10, stock:null, enabled:true })));
    manageCard.querySelector("#sgc-shop-save").addEventListener("click", saveItems);
    manageCard.querySelector("#sgc-shop-refresh").addEventListener("click", ()=>reloadShop());
    purchaseCard.querySelector("#sgc-shop-buy-refresh").addEventListener("click", ()=>reloadShop());
    purchaseCard.querySelector("#sgc-shop-buy-run").addEventListener("click", runPurchase);

    reloadShop();
  }

  function renderAudit(){
    ensureProfileFromInputs();
    const controls=h(`
      <div class="sgc-compact">
        <button id="sgc-audit-reload" class="sgc-btn">監査ログを再読込</button>
      </div>
    `);
    bodyArea.appendChild(controls);

    const table=h(`
      <table class="sgc-table">
        <thead>
          <tr>
            <th>時刻</th>
            <th>actor</th>
            <th>action</th>
            <th>detail</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `);
    const tbody=table.querySelector("tbody");
    bodyArea.appendChild(table);

    const status=h(`<div class="sgc-help" id="sgc-audit-status"></div>`);
    bodyArea.appendChild(status);

    function renderRows(){
      tbody.innerHTML="";
      if(!auditCache.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=5;
        td.style.color="#777";
        td.textContent="監査ログがありません";
        tr.appendChild(td);
        tbody.appendChild(tr);
        status.textContent="";
        return;
      }
      auditCache.forEach(ev=>{
        const tr=document.createElement("tr");
        const cells=[
          formatDateTime(ev?.at),
          ev?.actor || "api",
          ev?.action || "",
          summarizeAuditDetail(ev),
          ev?.ip || "",
        ];
        cells.forEach(txt=>{
          const td=document.createElement("td");
          td.textContent = txt ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      status.textContent = `取得件数: ${auditCache.length}`;
    }

    async function reload(){
      try{
        await fetchAudit(100);
        renderRows();
      }catch(e){
        toast("監査ログの取得に失敗しました", true);
      }
    }

    controls.querySelector("#sgc-audit-reload").addEventListener("click", reload);
    reload();
  }

  /* ====== 起動 ====== */
  function start(){
    ensureFab();
    setupFabObserver();
    maintainFab();
  }
  if(document.readyState==="complete"){ start(); }
  else window.addEventListener("load", start, {once:true});

})();
</script>

<script>
// この単体ページを開いたら自動でモーダルを表示
(function openWhenReady(){
  const el = document.getElementById('sgc-fab');
  if (el) { el.click(); return; }
  setTimeout(openWhenReady, 100);
})();
</script>

</body>
</html>
