<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Gamify Console</title>
</head>
<body>

<script>
/* ------------------------------
   0) 事前セット: GM_addStyle / マジックリンク
   ------------------------------ */
(function(){
  // Tampermonkey なしでも同じAPI名でCSSを注入できるように
  window.GM_addStyle = window.GM_addStyle || function(css){
    try { const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s); } catch(_){}
  };

  // #tenant=...&token=...&base=... を localStorage に保存
  try {
    const q = new URLSearchParams(location.hash.slice(1));
    const tenant = q.get('tenant') || 'default';
    const token  = q.get('token')  || '';
    const base   = (q.get('base') ?? '').trim();
    const baseUrl = base === '' ? location.origin : base;
    localStorage.setItem("sgc.profile.v3", JSON.stringify({ tenant, baseUrl, token }));
  } catch(_){}
})();
</script>

<script>
/* ==UserScript==
 * @name         Sales Gamify Console (v2.3 UI: ルール自由編集・CSV取込・安定化)
 * @namespace    https://habitica.com/
 * @version      2.3.0
 * @description  Habitica上に営業ゲーミフィケーション設定UIを追加。スコア/アポ/ラベル/CSV/ダッシュボードを編集。読み込み完了と同時に表示ボタンを出すよう安定化。
 * @match        https://habitica.com/*
 * @run-at       document-end
 * @grant        GM_addStyle
 * ==/UserScript== */

(() => {
  /* ====== 基本ユーティリティ ====== */
  const LS_KEY  = "sgc.profile.v3";
  const LS_VIEW = "sgc.view.v3";
  const LS_UNDO = "sgc.undo.v1";
  const MAX_UNDO = 8;
  const PIN_KEY = "sgc_pin";
  const PIN_KEY_NEW = "sgc.alwaysShowFab";
  const HIDE_PAID_KEY = "sgc.hidePaidRewards";
  const GEAR_POSITION_KEY = "sgc.settings.position";

  const h = (html) => { const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstElementChild; };
  const asNum=(v,d=0)=>{ const n=Number(v); return Number.isFinite(n)?n:d; };
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const load=(k,def={})=>{ try{ return JSON.parse(localStorage.getItem(k)||"")||def; }catch{ return def; } };
  const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v||{}));
  const toast=(msg,bad=false)=>{ const el=h(`<div class="sgc-toast" style="background:${bad?"#c0392b":"#222"}">${msg}</div>`); document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };
  const statusOf=(err)=> Number.isFinite(Number(err?.status)) ? Number(err.status) : null;
  const describeHttpError=(err)=>{
    if(!err) return "unknown error";
    const status = statusOf(err);
    const statusText = err?.statusText ? String(err.statusText).trim() : "";
    const bodyText = err?.body ? String(err.body).trim() : err?.responseText ? String(err.responseText).trim() : "";
    let msg = "";
    if(status){ msg = `${status}${statusText ? ` ${statusText}` : ""}`; }
    if(bodyText){ msg = msg ? `${msg} - ${bodyText}` : bodyText; }
    const base = String(err?.message || "").trim();
    if(!msg) msg = base || "unknown error";
    return msg;
  };
  const csvEscape=(value)=>{
    const text = value === null || value === undefined ? "" : String(value);
    if(/["\r\n,]/.test(text)){
      return `"${text.replace(/"/g,'""')}"`;
    }
    return text;
  };
  const downloadCsv=(filename, header, rows)=>{
    const lines=[header.map(csvEscape).join(",")];
    rows.forEach((row)=> lines.push(row.map(csvEscape).join(",")));
    const blob=new Blob([lines.join("\r\n")],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),0);
  };
  const loadProfile=()=>load(LS_KEY,{ tenant:"default", baseUrl:"", token:"" });
  const saveProfile=(p)=>save(LS_KEY,p);
  function loadGearPositionSettings(){
    try{
      const raw = localStorage.getItem(GEAR_POSITION_KEY);
      if(!raw) return { top:120, left:18 };
      const parsed = JSON.parse(raw);
      const top = Number(parsed?.top);
      const left = Number(parsed?.left);
      return {
        top: Number.isFinite(top) ? top : 120,
        left: Number.isFinite(left) ? left : 18,
      };
    }catch(_){
      return { top:120, left:18 };
    }
  }
  function saveGearPositionSettings(pos){
    const safe = {
      top: Number.isFinite(Number(pos?.top)) ? Math.round(Number(pos.top)) : 120,
      left: Number.isFinite(Number(pos?.left)) ? Math.round(Number(pos.left)) : 18,
    };
    localStorage.setItem(GEAR_POSITION_KEY, JSON.stringify(safe));
    try{ window.top?.postMessage({ type:"sgc.updateGearPosition", position: safe }, "*"); }catch(_){ }
    return safe;
  }

  const headers=(p)=>{ const hd={"Accept":"application/json"}; if(p?.token){ hd.Authorization=`Bearer ${p.token}`; } return hd; };
  async function parseJsonText(text){
    if(!text) return null;
    try{
      return JSON.parse(text);
    }catch{
      return text;
    }
  }
  async function requestJson(url, options, profile){
    const res = await fetch(url, options);
    let text = "";
    try{ text = await res.text(); }catch{ text = ""; }
    if(!res.ok){
      const err = new Error((text || `${res.status} ${res.statusText}`).trim());
      err.status = res.status;
      err.statusText = res.statusText;
      err.body = text;
      err.url = url;
      err.options = options;
      err.profile = profile;
      throw err;
    }
    return parseJsonText(text);
  }
  const apiGET=async(url,p)=> requestJson(url,{headers:headers(p)},p);
  const apiPUT=async(url,body,p)=> requestJson(url,{method:"PUT",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)},p);
  const apiPOST=async(url,body,p)=> requestJson(url,{method:"POST",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)},p);
  const apiDELETE=async(url,p)=> requestJson(url,{method:"DELETE",headers:headers(p)},p);
  const apiPOSTForm=async(url,form,p)=> requestJson(url,{method:"POST",headers:headers(p),body:form},p);

  const DEFAULT_VIEW_STATE = { zoom: 100, density: "standard", fontSize: "m", contrast: "standard" };
  let keyboardShortcutsInitialized = false;
  let modalInteractionInitialized = false;

  function getTenant(){
    const el = document.querySelector('[name="tenant"],#sgc-tenant,#tenant,select#tenant');
    if(el && typeof el.value === "string"){
      const v = el.value.trim();
      if(v) return v;
    }
    try{
      const prof = loadProfile();
      if(prof && prof.tenant) return prof.tenant;
    }catch(_){}
    return "default";
  }
  function storageKey(suffix){
    return `gamify_${getTenant()}_${suffix}`;
  }
  function loadUIState(){
    try{
      return JSON.parse(localStorage.getItem(storageKey("ui")) || "{}") || {};
    }catch(_){
      return {};
    }
  }
  function mergeState(base, patch){
    const result = base && typeof base === "object" && !Array.isArray(base) ? { ...base } : {};
    Object.keys(patch || {}).forEach((key)=>{
      const value = patch[key];
      if(value && typeof value === "object" && !Array.isArray(value)){
        result[key] = mergeState(base && base[key], value);
      } else {
        result[key] = value;
      }
    });
    return result;
  }
  function saveUIState(partial){
    try{
      const current = loadUIState();
      const next = mergeState(current, partial || {});
      localStorage.setItem(storageKey("ui"), JSON.stringify(next));
    }catch(_){}
  }
  function getViewState(){
    const st = loadUIState();
    return { ...DEFAULT_VIEW_STATE, ...(st.view || {}) };
  }
  function setViewState(view){
    saveUIState({ view: { ...view } });
  }
  function updateTablePrefs(tableId, updater){
    const st = loadUIState();
    const tablePrefs = { ...(st.tablePrefs || {}) };
    const current = { hiddenCols: [], widths: {}, ...(tablePrefs[tableId] || {}) };
    const next = updater ? updater(current) || current : current;
    tablePrefs[tableId] = { hiddenCols: Array.from(new Set(next.hiddenCols || [])), widths: { ...(next.widths || {}) } };
    saveUIState({ tablePrefs });
  }
  function getTablePrefs(tableId){
    const st = loadUIState();
    const prefs = st.tablePrefs || {};
    return { hiddenCols: [], widths: {}, ...(prefs[tableId] || {}) };
  }

  /* ====== スタイル（オリジナル + 使い勝手改良） ====== */
  GM_addStyle(`
    #sgc-fab{position:fixed; top:110px; right:18px; z-index:2147483646;
      background:#6c5ce7; color:#fff; border-radius:14px; padding:10px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,.25); font-weight:700; display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none}
    #sgc-fab:hover{filter:brightness(1.06)}
    #sgc-modal{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      z-index:2147483646; width:min(1160px,96vw); max-height:88vh; background:#fff; border-radius:14px;
      overflow:hidden; box-shadow:0 24px 48px rgba(0,0,0,.25); display:none;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .sgc-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f7f7fb;border-bottom:1px solid #ececf5;gap:12px}
    .sgc-title{font-weight:800}
    .sgc-kv{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sgc-tabs{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid #f1f1f6;flex-wrap:wrap}
    .sgc-tab{padding:6px 10px;border-radius:8px;font-weight:700;color:#555;cursor:pointer}
    .sgc-tab.active{background:#6c5ce7;color:#fff}
    .sgc-body{padding:14px;}
    .sgc-row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;padding:8px 0}
    .sgc-row input,.sgc-row select,.sgc-row textarea{border:1px solid #dfe3f0;border-radius:8px;padding:9px 10px;width:100%;font-size:14px;background:#fff}
    .sgc-help{font-size:12px;color:#777}
    .sgc-actions{position:sticky; bottom:0; background:#fff; z-index:1;
      display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #ececf5;align-items:center}
    .sgc-btn{background:#e9e9f4;border:none;padding:9px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .sgc-btn.primary{background:#6c5ce7;color:#fff}
    .sgc-badge{background:#f0efff;color:#5c54d6;border-radius:999px;padding:3px 8px;font-size:12px}
    .sgc-toast{position:fixed;right:16px;bottom:16px;background:#222;color:#fff;padding:10px 14px;border-radius:12px;z-index:2147483647;opacity:.95}
    .sgc-list{display:flex;flex-direction:column;gap:8px}
    .sgc-card{border:1px solid #e8e8f5;border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .sgc-card .full{grid-column:1 / -1}
    .sgc-card .muted{color:#777;font-size:12px}
    .sgc-del{background:#fff;border:1px solid #e1e1ef}
    .sgc-bare{border:1px dashed #ddd;border-radius:10px;padding:10px}
    .sgc-row-compact{display:flex;gap:8px;align-items:center}
    /* HubSpot行をワイドに：3カラム(ラベルID/タイトル/削除) */
    .sgc-card-hub{grid-template-columns:2fr 3fr 120px}
    .sgc-card-hub input{width:100%}
    .sgc-pin-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:#555}
    .sgc-pin-toggle input{accent-color:#6c5ce7}
    #sgc-fab.pinned{background:#4d3cd1}
    .sgc-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    .sgc-table th,.sgc-table td{padding:8px 10px;border-bottom:1px solid #ececf5;text-align:left;vertical-align:top}
    .sgc-table th{background:#f7f7fb;color:#555;font-weight:700}
    .sgc-table tbody tr:hover{background:#fafaff}
    .sgc-compact{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sgc-filter{margin-top:10px}
    .sgc-cols{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
    .sgc-col{flex:1 1 360px;min-width:320px;display:flex;flex-direction:column;gap:10px}
    .sgc-card-shop{grid-template-columns:1fr 120px 120px 1fr 140px}
    .sgc-card-shop .full{grid-column:1/-1}
    .sgc-card-shop input[type="number"]{width:100%}
    .sgc-card-purchase{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .sgc-card-purchase .full{grid-column:1/-1}
    @media(max-width:768px){
      .sgc-row{grid-template-columns:1fr}
      .sgc-card{grid-template-columns:1fr}
      .sgc-card-hub{grid-template-columns:1fr}
      .sgc-card-shop{grid-template-columns:1fr}
      .sgc-card-purchase{grid-template-columns:1fr}
    }
    :root{
      --sgc-font:16px; --sgc-line:1.6; --sgc-pad:12px; --sgc-input:44px;
    }
    #sgc-modal{ font-size:var(--sgc-font); line-height:var(--sgc-line); }
    .sgc-row{ gap:16px; padding:10px 0; }
    .sgc-row input,.sgc-row select,.sgc-row textarea{
      height:var(--sgc-input); padding:10px 12px; font-size:15px;
    }
    .sgc-btn{ padding:10px 16px; font-size:14px; }
    .sgc-tab{ padding:8px 12px; font-size:14px; }
    .sgc-card{ gap:12px; }
    .sgc-help{ font-size:13px; }
    @media(min-width:1200px){
      #sgc-modal{ width:1200px; }
      .sgc-row{ grid-template-columns:260px 1fr; }
    }
    /* HubSpot連携の行入力幅を拡張 */
    #sgc-hub-list .sgc-card input{ width:100%; }
    /* フォーカスリング */
    .sgc-row input:focus,.sgc-row select:focus,.sgc-row textarea:focus{
      outline:2px solid #6c5ce7; outline-offset:1px;
    }

    /* --- enhanced modal and view controls --- */
    #sgc-modal{position:fixed;inset:0;top:auto;left:auto;transform:none;background:rgba(0,0,0,.35);z-index:2147483647;display:none;}
    #sgc-modal.is-open{display:block;}
    #sgc-shell{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(940px,94vw);height:min(680px,92vh);background:#fff;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.35);overflow:hidden;display:flex;flex-direction:column;}
    #sgc-titlebar{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #eee;background:#fff;cursor:move;}
    #sgc-titlebar .spacer{flex:1}
    #sgc-toolbar{display:flex;align-items:center;gap:12px;font-size:12px;cursor:auto;}
    #sgc-toolbar label{display:flex;align-items:center;gap:6px;color:#666;white-space:nowrap;}
    #sgc-toolbar input,#sgc-toolbar select{font-size:12px}
    #sgc-header-controls{display:flex;flex-wrap:wrap;gap:8px;padding:10px 12px;align-items:center;border-bottom:1px solid #f1f1f6;background:#fafbff;}
    #sgc-header-controls label{font-size:12px;color:#666}
    #sgc-header-controls input{height:32px;border-radius:8px;padding:6px 8px;border:1px solid #dfe3f0}
    #sgc-header-controls .sgc-btn{height:32px;padding:0 12px;}
    #sgc-header-controls .sgc-pin-toggle{font-size:12px;}
    #sgc-content-wrap{position:relative;width:100%;flex:1;overflow:auto;padding:12px;}
    #sgc-content{position:relative;width:100%;transform-origin:top left;}
    #sgc-body{width:100%;}
    #sgc-resizer{position:absolute;right:6px;bottom:6px;width:10px;height:10px;border-right:2px solid #bbb;border-bottom:2px solid #bbb;cursor:se-resize;opacity:.8}
    .density-compact .sgc-row{padding:6px 0;}
    .density-compact .sgc-table td,.density-compact .sgc-table th{padding:6px 8px}
    .font-s{font-size:12px}
    .font-m{font-size:14px}
    .font-l{font-size:16px}
    .contrast-high{color:#111;background:#fff}
    .contrast-high .sgc-card{border-color:#cbd5f5}
    .contrast-high .sgc-tabs{background:#f5f7ff}
    .contrast-high .sgc-body{background:#fff}
    #sgc-tabs{position:sticky;top:0;background:#fff;z-index:2}
    table.sgc-table thead{position:sticky;top:0;background:inherit;z-index:1}
    .th-resize{position:relative}
    .th-resize .resizer{position:absolute;top:0;right:0;width:6px;height:100%;cursor:col-resize;background:transparent}
    .column-menu{position:absolute;top:100%;right:0;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:8px;z-index:3;min-width:180px;display:flex;flex-direction:column;gap:4px;}
    .column-menu label{display:flex;align-items:center;gap:6px;font-size:12px;color:#444;}
    .sgc-table-controls{display:flex;justify-content:flex-end;gap:8px;margin:4px 0;position:relative;}
    .sgc-table-controls .sgc-columns-btn{background:#f3f4ff;border:none;border-radius:8px;padding:6px 12px;font-size:12px;cursor:pointer;}
    .sgc-table-controls .sgc-columns-btn:hover{background:#e4e7ff;}
    #sgc-content-wrap::-webkit-scrollbar{width:10px;height:10px}
    #sgc-content-wrap::-webkit-scrollbar-thumb{background:#ccc;border-radius:8px}
    @media (max-width: 900px){
      #sgc-toolbar{flex-wrap:wrap;row-gap:8px}
      #sgc-titlebar{flex-wrap:wrap;cursor:default;}
    }
  `);

  /* ====== 固定ボタン ====== */
  const isPinned = ()=> {
    const legacy = localStorage.getItem(PIN_KEY);
    const modern = localStorage.getItem(PIN_KEY_NEW);
    return legacy === "1" || modern === "1" || modern === "true";
  };
  const setPinned = (flag)=>{ 
    if(flag){
      localStorage.setItem(PIN_KEY,"1");
      localStorage.setItem(PIN_KEY_NEW,"true");
    } else {
      localStorage.removeItem(PIN_KEY);
      localStorage.removeItem(PIN_KEY_NEW);
    }
    try{
      window.top?.postMessage({ type:"sgc.alwaysShowFab", value: flag }, "*");
    }catch(_){}
    syncFabState(); 
    maintainFab(); 
  };

  function syncFabState(){
    const fab = document.getElementById("sgc-fab");
    if(fab){
      fab.classList.toggle("pinned", isPinned());
    }
    if(modal){
      const chk = modal.querySelector("#sgc-pin");
      if(chk) chk.checked = isPinned();
    }
  }

  function ensureFab(){
    let fab = document.getElementById("sgc-fab");
    if(!fab){
      fab = h(`<div id="sgc-fab" title="Sales Gamify Console">⚙️ 設定</div>`);
      fab.addEventListener("click", openModal);
      document.body.appendChild(fab);
    }
    syncFabState();
  }

  function maintainFab(){
    if(isPinned()){
      requestAnimationFrame(()=>ensureFab());
    }
  }

  function setupFabObserver(){
    if(fabObserver) return;
    fabObserver = new MutationObserver(()=> maintainFab());
    fabObserver.observe(document.body,{ childList:true, subtree:true });
  }

  /* ====== モーダル作成 ====== */
  let profile={}, currentTab="score", rulesCache=null, labelsCache=null;
  let adjustmentsCache=[], shopItemsCache=[], auditCache=[], shopItemsV2Cache=[], badgesCache=[];
  let fabObserver=null;
  let modal, shell, bodyArea, contentScroll;

  function ensureModal(){
    if(document.getElementById("sgc-modal")){
      modal = document.getElementById("sgc-modal");
      shell = modal.querySelector("#sgc-shell");
      bodyArea = modal.querySelector("#sgc-body");
      contentScroll = modal.querySelector("#sgc-content-wrap");
      return;
    }

    modal = h(`
      <div id="sgc-modal" role="dialog" aria-modal="true" aria-label="Sales Gamify Console">
        <div id="sgc-shell">
          <div id="sgc-titlebar">
            <div class="sgc-kv">
              <div class="sgc-title">Sales Gamify Console</div>
              <span class="sgc-badge">UI全XP編集+CSV</span>
            </div>
            <div class="spacer"></div>
            <div id="sgc-toolbar"></div>
            <button id="sgc-close" class="sgc-btn">閉じる</button>
          </div>
          <div id="sgc-header-controls">
            <label>Tenant:</label>
            <input id="sgc-tenant" style="width:160px" placeholder="default">
            <label>BaseURL:</label>
            <input id="sgc-base" style="width:260px" placeholder="https://sales-gamify.onrender.com">
            <label>Token:</label>
            <input id="sgc-token" style="width:220px" placeholder="(Bearer不要)">
            <label class="sgc-pin-toggle"><input id="sgc-pin" type="checkbox"> 常時表示</label>
            <button id="sgc-ping" class="sgc-btn">Ping</button>
            <button id="sgc-save-top" class="sgc-btn primary">保存</button>
          </div>
          <div id="sgc-tabs" class="sgc-tabs"></div>
          <div id="sgc-content-wrap">
            <div id="sgc-content">
              <div id="sgc-body" class="sgc-body"></div>
            </div>
          </div>
          <div class="sgc-actions">
            <button id="sgc-save" class="sgc-btn primary">保存</button>
          </div>
          <div id="sgc-resizer"></div>
        </div>
      </div>
    `);
    document.body.appendChild(modal);
    shell = modal.querySelector("#sgc-shell");
    bodyArea = modal.querySelector("#sgc-body");
    contentScroll = modal.querySelector("#sgc-content-wrap");

    const closeBtn = modal.querySelector("#sgc-close");
    const pingBtn = modal.querySelector("#sgc-ping");
    const saveBtn = modal.querySelector("#sgc-save");
    const saveTopBtn = modal.querySelector("#sgc-save-top");
    const pinToggle = modal.querySelector("#sgc-pin");

    pingBtn?.addEventListener("click", doPing);
    saveBtn?.addEventListener("click", saveAll);
    saveTopBtn?.addEventListener("click", saveAll);
    closeBtn?.addEventListener("click", closeModal);
    pinToggle?.addEventListener("change", (e)=>{
      const flag = !!e.target.checked;
      setPinned(flag);
      if(flag){ toast("設定ボタンを常時表示にしました"); }
      else{ toast("常時表示を解除しました"); }
      ensureFab();
    });
    ["#sgc-tenant","#sgc-base","#sgc-token"].forEach(sel=>{
      modal.querySelector(sel)?.addEventListener("input", ()=> ensureProfileFromInputs());
      modal.querySelector(sel)?.addEventListener("change", ()=> {
        ensureProfileFromInputs();
        applyViewState();
        initViewControls(); // rebuild to reflect tenant-specific state
      });
    });

    modal.addEventListener("pointerdown",(e)=>{
      if(e.target === modal){
        closeModal();
      }
    });

    initKeyboardShortcuts();
    initModalInteractions();
  }

  const MODAL_MARGIN = 16;
  const MODAL_MIN_WIDTH = 640;
  const MODAL_MIN_HEIGHT = 420;

  function ensureShellAbsolute(){
    if(!shell) return;
    const rect = shell.getBoundingClientRect();
    shell.style.transform = "translate(0,0)";
    shell.style.left = `${Math.round(rect.left)}px`;
    shell.style.top = `${Math.round(rect.top)}px`;
  }

  function ensureShellWithinViewport(persist=false){
    if(!shell) return;
    ensureShellAbsolute();
    const margin = MODAL_MARGIN;
    const rect = shell.getBoundingClientRect();
    const availWidth = Math.max(260, window.innerWidth - margin * 2);
    const availHeight = Math.max(260, window.innerHeight - margin * 2);
    const minWidth = Math.min(MODAL_MIN_WIDTH, availWidth);
    const minHeight = Math.min(MODAL_MIN_HEIGHT, availHeight);
    const width = clamp(rect.width, minWidth, availWidth);
    const height = clamp(rect.height, minHeight, availHeight);
    shell.style.width = `${Math.round(width)}px`;
    shell.style.height = `${Math.round(height)}px`;
    const maxLeft = Math.max(margin, window.innerWidth - width - margin);
    const maxTop = Math.max(margin, window.innerHeight - height - margin);
    const left = clamp(rect.left, margin, maxLeft);
    const top = clamp(rect.top, margin, maxTop);
    shell.style.left = `${Math.round(left)}px`;
    shell.style.top = `${Math.round(top)}px`;
    shell.style.transform = "translate(0,0)";
    if(persist){
      saveUIState({
        modal: {
          x: Math.round(left),
          y: Math.round(top),
          width: Math.round(width),
          height: Math.round(height),
        },
      });
    }
    return { left, top, width, height };
  }

  function applyModalState(){
    if(!shell) return;
    const stored = loadUIState().modal || {};
    const hasSize = Number.isFinite(stored.width) && Number.isFinite(stored.height);
    if(hasSize){
      ensureShellAbsolute();
      if(Number.isFinite(stored.width)) shell.style.width = `${Math.round(stored.width)}px`;
      if(Number.isFinite(stored.height)) shell.style.height = `${Math.round(stored.height)}px`;
      if(Number.isFinite(stored.x) && Number.isFinite(stored.y)){
        shell.style.left = `${Math.round(stored.x)}px`;
        shell.style.top = `${Math.round(stored.y)}px`;
        shell.style.transform = "translate(0,0)";
      }
      ensureShellWithinViewport(true);
    } else {
      shell.style.width = "";
      shell.style.height = "";
      shell.style.left = "50%";
      shell.style.top = "50%";
      shell.style.transform = "translate(-50%,-50%)";
      setTimeout(()=>ensureShellWithinViewport(false),0);
    }
  }

  function initModalInteractions(){
    if(modalInteractionInitialized) return;
    if(!shell) return;
    const titlebar = document.getElementById("sgc-titlebar");
    const resizer = document.getElementById("sgc-resizer");
    if(!titlebar || !resizer) return;
    modalInteractionInitialized = true;

    titlebar.addEventListener("pointerdown",(e)=>{
      if(e.button !== undefined && e.button !== 0) return;
      if(e.target.closest("#sgc-toolbar") || e.target.closest("#sgc-close")) return;
      ensureShellAbsolute();
      const startRect = shell.getBoundingClientRect();
      const startX = e.clientX;
      const startY = e.clientY;
      const pointerId = e.pointerId;
      function move(ev){
        if(pointerId !== undefined && ev.pointerId !== pointerId) return;
        const dx = ev.clientX - startX;
        const dy = ev.clientY - startY;
        const margin = MODAL_MARGIN;
        const width = startRect.width;
        const height = startRect.height;
        const x = clamp(startRect.left + dx, margin, Math.max(margin, window.innerWidth - width - margin));
        const y = clamp(startRect.top + dy, margin, Math.max(margin, window.innerHeight - height - margin));
        shell.style.left = `${Math.round(x)}px`;
        shell.style.top = `${Math.round(y)}px`;
        shell.style.transform = "translate(0,0)";
      }
      function up(ev){
        if(pointerId !== undefined && ev.pointerId !== pointerId) return;
        window.removeEventListener("pointermove", move);
        window.removeEventListener("pointerup", up);
        (()=>{
          const rect = shell.getBoundingClientRect();
          const margin = MODAL_MARGIN;
          const distLeft = rect.left - margin;
          const distRight = window.innerWidth - rect.right - margin;
          const distTop = rect.top - margin;
          const distBottom = window.innerHeight - rect.bottom - margin;
          const snapLeft = distLeft <= distRight;
          const snapTop = distTop <= distBottom;
          const width = rect.width;
          const height = rect.height;
          const x = snapLeft ? margin : Math.max(margin, window.innerWidth - width - margin);
          const y = snapTop ? margin : Math.max(margin, window.innerHeight - height - margin);
          shell.style.left = `${Math.round(x)}px`;
          shell.style.top = `${Math.round(y)}px`;
          shell.style.transform = "translate(0,0)";
          ensureShellWithinViewport(true);
        })();
      }
      window.addEventListener("pointermove", move);
      window.addEventListener("pointerup", up, { once:true });
    });

    resizer.addEventListener("pointerdown",(e)=>{
      if(e.button !== undefined && e.button !== 0) return;
      e.preventDefault();
      ensureShellAbsolute();
      const startRect = shell.getBoundingClientRect();
      const startX = e.clientX;
      const startY = e.clientY;
      const pointerId = e.pointerId;
      function move(ev){
        if(pointerId !== undefined && ev.pointerId !== pointerId) return;
        const margin = MODAL_MARGIN;
        const availWidth = Math.max(260, window.innerWidth - margin * 2);
        const availHeight = Math.max(260, window.innerHeight - margin * 2);
        const minWidth = Math.min(MODAL_MIN_WIDTH, availWidth);
        const minHeight = Math.min(MODAL_MIN_HEIGHT, availHeight);
        let width = startRect.width + (ev.clientX - startX);
        let height = startRect.height + (ev.clientY - startY);
        width = clamp(width, minWidth, availWidth);
        height = clamp(height, minHeight, availHeight);
        shell.style.width = `${Math.round(width)}px`;
        shell.style.height = `${Math.round(height)}px`;
      }
      function up(ev){
        if(pointerId !== undefined && ev.pointerId !== pointerId) return;
        window.removeEventListener("pointermove", move);
        window.removeEventListener("pointerup", up);
        ensureShellWithinViewport(true);
      }
      window.addEventListener("pointermove", move);
      window.addEventListener("pointerup", up, { once:true });
    });

    window.addEventListener("resize", ()=>{
      if(modal && modal.classList.contains("is-open")){
        ensureShellWithinViewport(true);
      }
    });
  }

  function initKeyboardShortcuts(){
    if(keyboardShortcutsInitialized) return;
    keyboardShortcutsInitialized = true;
    window.addEventListener("keydown",(e)=>{
      if(!modal || !modal.classList.contains("is-open")) return;
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){
        e.preventDefault();
        saveAll();
      } else if(e.key === "Escape"){
        e.preventDefault();
        closeModal();
      }
    });
  }

  function applyViewState(view){
    const state = { ...DEFAULT_VIEW_STATE, ...(view || {}) };
    const content = document.getElementById("sgc-content");
    const wrap = document.getElementById("sgc-content-wrap");
    if(!content || !wrap) return state;
    const zoom = clamp(Number(state.zoom) || 100, 80, 125);
    content.style.transform = `scale(${zoom / 100})`;
    ["density-compact"].forEach(cls => content.classList.remove(cls));
    if(state.density === "compact"){
      content.classList.add("density-compact");
    }
    ["font-s","font-m","font-l"].forEach(cls=>content.classList.remove(cls));
    content.classList.add(`font-${state.fontSize || "m"}`);
    content.classList.toggle("contrast-high", state.contrast === "high");
    return state;
  }

  function initViewControls(){
    const toolbar = document.getElementById("sgc-toolbar");
    const content = document.getElementById("sgc-content");
    const wrap = document.getElementById("sgc-content-wrap");
    if(!toolbar || !content || !wrap) return;
    toolbar.innerHTML = "";
    let current = getViewState();
    applyViewState(current);

    function wrapCtl(label, node){
      const el = document.createElement("label");
      el.textContent = label;
      el.appendChild(node);
      return el;
    }
    function commit(update){
      current = { ...current, ...update };
      setViewState(current);
      applyViewState(current);
    }

    const zoomInput = document.createElement("input");
    zoomInput.type = "range";
    zoomInput.min = "80";
    zoomInput.max = "125";
    zoomInput.step = "5";
    zoomInput.value = String(current.zoom);
    const zoomLabel = document.createElement("span");
    zoomLabel.textContent = `${current.zoom}%`;
    zoomInput.addEventListener("input",()=>{
      zoomLabel.textContent = `${zoomInput.value}%`;
      applyViewState({ ...current, zoom: Number(zoomInput.value) });
    });
    zoomInput.addEventListener("change",()=>{
      commit({ zoom: Number(zoomInput.value) });
    });
    toolbar.appendChild(wrapCtl("Zoom", zoomInput));
    toolbar.appendChild(zoomLabel);

    const density = document.createElement("select");
    [["standard","標準"],["compact","コンパクト"]].forEach(([value,label])=>{
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = label;
      density.appendChild(opt);
    });
    density.value = current.density;
    density.addEventListener("change",()=>{
      commit({ density: density.value });
    });
    toolbar.appendChild(wrapCtl("Density", density));

    const font = document.createElement("select");
    [["s","S"],["m","M"],["l","L"]].forEach(([value,label])=>{
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = label;
      font.appendChild(opt);
    });
    font.value = current.fontSize;
    font.addEventListener("change",()=>{
      commit({ fontSize: font.value });
    });
    toolbar.appendChild(wrapCtl("Font", font));

    const contrast = document.createElement("select");
    [["standard","標準"],["high","高"]].forEach(([value,label])=>{
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = label;
      contrast.appendChild(opt);
    });
    contrast.value = current.contrast;
    contrast.addEventListener("change",()=>{
      commit({ contrast: contrast.value });
    });
    toolbar.appendChild(wrapCtl("Contrast", contrast));
  }

  function enhanceTablesAfterRender(){
    if(!bodyArea) return;
    const tables = bodyArea.querySelectorAll("table");
    tables.forEach((table, index)=>{
      const explicit = table.getAttribute("data-table-id") || table.id || "";
      const tableId = explicit ? explicit : `${currentTab}-table-${index}`;
      enhanceTable(table, tableId);
    });
  }

  function enhanceTable(table, tableId){
    if(!table) return;
    const head = table.querySelector("thead");
    if(!head) return;
    const ths = head.querySelectorAll("th");
    if(!ths.length) return;
    const columnKeys = [];
    const columnLabels = [];

    ths.forEach((th, index)=>{
      let key = th.dataset.sgcColumnKey;
      if(!key){
        const raw = th.dataset.key || th.dataset.field || th.dataset.column || th.getAttribute("id") || (th.textContent || "").trim();
        key = (raw || `col${index}`).replace(/\s+/g,"_").toLowerCase();
        if(columnKeys.includes(key)){
          key = `${key}_${index}`;
        }
        th.dataset.sgcColumnKey = key;
      }
      columnKeys.push(key);
      columnLabels.push((th.textContent || key).trim() || key);
      th.classList.add("th-resize");
      if(!th.querySelector(".resizer")){
        const resizer = document.createElement("div");
        resizer.className = "resizer";
        th.appendChild(resizer);
        resizer.addEventListener("pointerdown",(e)=>{
          if(e.button !== undefined && e.button !== 0) return;
          e.preventDefault();
          const startWidth = th.getBoundingClientRect().width;
          const startX = e.clientX;
          const pointerId = e.pointerId;
          function move(ev){
            if(pointerId !== undefined && ev.pointerId !== pointerId) return;
            const delta = ev.clientX - startX;
            const width = Math.max(60, startWidth + delta);
            th.style.width = `${Math.round(width)}px`;
          }
          function up(ev){
            if(pointerId !== undefined && ev.pointerId !== pointerId) return;
            window.removeEventListener("pointermove", move);
            window.removeEventListener("pointerup", up);
            const width = Math.round(th.getBoundingClientRect().width);
            updateTablePrefs(tableId,(pref)=>{
              const next = { hiddenCols: Array.from(pref.hiddenCols || []), widths: { ...(pref.widths || {}) } };
              next.widths[key] = width;
              return next;
            });
          }
          window.addEventListener("pointermove", move);
          window.addEventListener("pointerup", up, { once:true });
        });
      }
    });

    table.dataset.sgcEnhanced = "1";
    table.dataset.sgcTableId = tableId;

    function setColumnVisibility(key, index, visible){
      const cells = table.querySelectorAll(`tr > *:nth-child(${index + 1})`);
      cells.forEach((cell)=>{
        cell.style.display = visible ? "" : "none";
      });
    }

    function applyPrefs(){
      const latest = getTablePrefs(tableId);
      ths.forEach((th, index)=>{
        const key = th.dataset.sgcColumnKey;
        if(!key) return;
        if(latest.widths && Number.isFinite(latest.widths[key])){
          th.style.width = `${Math.round(latest.widths[key])}px`;
        }
        const hidden = Array.isArray(latest.hiddenCols) && latest.hiddenCols.includes(key);
        setColumnVisibility(key, index, !hidden);
      });
    }

    let controls = table.previousElementSibling;
    if(!controls || !(controls.dataset && controls.dataset.sgcTableControls === tableId)){
      controls = document.createElement("div");
      controls.dataset.sgcTableControls = tableId;
      controls.className = "sgc-table-controls";
      controls.style.display = "flex";
      controls.style.justifyContent = "flex-end";
      controls.style.margin = "4px 0";
      controls.style.position = "relative";
      table.parentElement?.insertBefore(controls, table);
    } else {
      controls.innerHTML = "";
    }

    const gear = document.createElement("button");
    gear.type = "button";
    gear.textContent = "⚙ 列";
    gear.className = "sgc-btn sgc-columns-btn";
    gear.style.fontSize = "12px";
    controls.appendChild(gear);

    let menu=null;
    function closeMenu(){
      if(menu){
        menu.remove();
        menu=null;
      }
    }
    gear.addEventListener("click",(e)=>{
      e.stopPropagation();
      if(menu){
        closeMenu();
        return;
      }
      const latest = getTablePrefs(tableId);
      menu = document.createElement("div");
      menu.className = "column-menu";
      columnKeys.forEach((key, index)=>{
        const row = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !(latest.hiddenCols || []).includes(key);
        cb.addEventListener("change",()=>{
          const visible = cb.checked;
          setColumnVisibility(key, index, visible);
          updateTablePrefs(tableId,(pref)=>{
            const next = { hiddenCols: Array.from(pref.hiddenCols || []), widths: { ...(pref.widths || {}) } };
            if(visible){
              next.hiddenCols = next.hiddenCols.filter((v)=>v!==key);
            }else if(!next.hiddenCols.includes(key)){
              next.hiddenCols.push(key);
            }
            return next;
          });
        });
        row.appendChild(cb);
        const labelText = document.createElement("span");
        labelText.textContent = ` ${columnLabels[index]}`;
        row.appendChild(labelText);
        menu.appendChild(row);
      });
      controls.appendChild(menu);
      setTimeout(()=>document.addEventListener("click", closeMenu, { once:true }),0);
    });

    applyPrefs();
  }

  function openModal(){
    ensureModal();
    syncFabState();
    profile=loadProfile();
    modal.classList.add("is-open");
    modal.querySelector("#sgc-tenant").value=profile.tenant||"default";
    modal.querySelector("#sgc-base").value=profile.baseUrl||"";
    modal.querySelector("#sgc-token").value=profile.token||"";
    ensureProfileFromInputs();
    applyModalState();
    applyViewState();
    initViewControls();
    initTabs();
    loadAll();
  }
  function closeModal(){
    if(modal){
      modal.classList.remove("is-open");
    }
  }

  function initTabs(){
    const tabs = modal.querySelector("#sgc-tabs");
    tabs.innerHTML="";
    const defs=[
      {id:"score",       label:"スコア設定"},
      {id:"hub",         label:"HubSpot連携（ラベル）"},
      {id:"approve",     label:"承認・売上（CSV連動）"},
      {id:"csv",         label:"CSV取込"},
      {id:"dash",        label:"ダッシュボード"},
      {id:"adjust",      label:"手動調整"},
      {id:"shop",        label:"ショップ"},
      {id:"shopManage",  label:"ショップ管理"},
      {id:"badgeManage", label:"バッジ管理"},
      {id:"settings",    label:"設定"},
      {id:"audit",       label:"監査ログ"},
    ];
    defs.forEach(t=>{
      const el=h(`<div class="sgc-tab" data-tab="${t.id}">${t.label}</div>`);
      if(t.id===currentTab) el.classList.add("active");
      el.addEventListener("click",()=>{ currentTab=t.id; render(); });
      tabs.appendChild(el);
    });
    render();
  }

  function baseURL(){ return String(modal.querySelector("#sgc-base").value||"").replace(/\/+$/,""); }
  function tenant(){ return String(modal.querySelector("#sgc-tenant").value||"default"); }
  function token(){ return String(modal.querySelector("#sgc-token").value||""); }
  function ensureProfileFromInputs(){ profile={ tenant:tenant(), baseUrl:baseURL(), token:token() }; saveProfile(profile); }

  async function doPing(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ toast("BaseURL を入力してください", true); return; }
    try{
      const j=await apiGET(`${profile.baseUrl}/healthz`, profile);
      toast("OK: 接続");
      console.log("healthz:", j);
    }catch(e){ toast("接続エラー", true); }
  }

  /* ====== データロード & 保存 ====== */
  async function loadAll(){
    ensureProfileFromInputs();
    if(!profile.baseUrl) return;
    try{
      const [rules, labels] = await Promise.all([
        apiGET(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/rules`, profile).catch(()=>({})),
        apiGET(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/labels`, profile).catch(()=>({ items:[] })),
      ]);
      rulesCache = rules || {};
      labelsCache = Array.isArray(labels?.items) ? labels.items : [];
      adjustmentsCache = [];
      shopItemsCache = [];
      shopItemsV2Cache = [];
      badgesCache = [];
      auditCache = [];
      render();
    }catch(e){ console.warn(e); toast("読み込みエラー", true); }
  }

  async function saveAll(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ toast("BaseURL を入力してください", true); return; }

    collectScoreToCaches();
    collectApproveToCache();
    collectHubToCache();

    try{
    await apiPUT(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/rules`, rulesCache||{}, profile);
    await apiPUT(`${profile.baseUrl}/tenant/${encodeURIComponent(profile.tenant)}/labels`, { items: labelsCache||[] }, profile);
    toast("保存しました");
    await loadAll();
  }catch(e){
    console.error(e);
    const status = statusOf(e);
    if (status === 401) {
      toast("保存に失敗: 401 Unauthorized（テナント名とトークンの組み合わせが Render の SGC_TOKENS と一致していません）", true);
    } else {
      toast("保存に失敗: "+describeHttpError(e), true);
    }
  }
}

  /* ====== タブ描画 ====== */
  function render(){
    modal.querySelectorAll(".sgc-tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===currentTab));
    bodyArea.innerHTML="";
    if(currentTab==="score") renderScore();
    else if(currentTab==="hub") renderHub();
    else if(currentTab==="approve") renderApprove();
    else if(currentTab==="csv") renderCSV();
    else if(currentTab==="dash") renderDash();
    else if(currentTab==="adjust") renderAdjust();
    else if(currentTab==="shop") renderShop();
    else if(currentTab==="shopManage") renderShopManage();
    else if(currentTab==="badgeManage") renderBadgeManage();
    else if(currentTab==="settings") renderSettings();
    else if(currentTab==="audit") renderAudit();
    enhanceTablesAfterRender();
    applyViewState();
  }

  function safeRules(){
    const r = rulesCache || {};
    r.xp = r.xp || {};
    r.xp.call = r.xp.call || {};
    r.xp.minutes = r.xp.minutes || {};
    r.xp.appointment = r.xp.appointment || {};
    r.approval = r.approval || { enabled:true, xp:0, badge:"承認" };
    r.sales = r.sales || { milestones: [] };
    return r;
  }

  /* ====== スコア設定 ====== */
  function renderScore(){
    const r=safeRules();
    const perCall = Number(r?.xp?.call?.perCall ?? 1);
    const unitMin = clamp(Math.round(Number(r?.xp?.minutes?.unitMs || 300000)/60000) || 5, 1, 60);
    const perUnit = Number(r?.xp?.minutes?.perUnitMs ?? r?.xp?.minutes?.per5min ?? 2);
    const list = Array.isArray(r?.xp?.minutes?.list) ? r.xp.minutes.list : [{min:unitMin,xp:perUnit}];
    const apXP    = Number(r?.xp?.appointment?.xp ?? 20);
    const apBadge = String(r?.xp?.appointment?.badge || "🏅新規アポ獲得");

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>発信 1コールあたりXP</label>
        <input id="sgc-xp-call" type="number" min="0" step="1" value="${perCall}">
      </div>
    `));

    const box = h(`<div class="sgc-row"><label>通話時間に応じたXP</label>
      <div class="sgc-bare">
        <div id="sgc-minutes-list" class="sgc-list"></div>
        <div style="margin-top:8px"><button id="sgc-add-min" class="sgc-btn">＋ 行を追加</button>
          <span class="sgc-help">※サーバ側は当面「先頭1行」を使用。全行は <code>xp.minutes.list</code> に保存し将来拡張します。</span>
        </div>
      </div>
    </div>`);
    bodyArea.appendChild(box);

    const listEl = box.querySelector("#sgc-minutes-list");
    function pushMinuteRow(v){ listEl.appendChild(renderMinuteRow(v)); }
    function renderMinuteRow(v){
      const row = h(`<div class="sgc-row-compact">
        <span>毎</span><input class="sgc-min" type="number" min="1" value="${Number(v?.min)||5}" style="width:80px">
        <span>分ごとに</span><input class="sgc-min-xp" type="number" min="0" value="${Number(v?.xp)||0}" style="width:120px"><span>XP</span>
        <button class="sgc-btn sgc-del">削除</button>
      </div>`);
      row.querySelector(".sgc-del").addEventListener("click",()=>row.remove());
      return row;
    }
    list.forEach(pushMinuteRow);
    box.querySelector("#sgc-add-min").addEventListener("click",()=>pushMinuteRow({min:5,xp:0}));

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>既定：新規アポ（HubSpot）</label>
        <div class="sgc-row-compact">
          <input id="sgc-ap-xp" type="number" min="0" step="1" value="${apXP}" style="width:120px"> <span>XP</span>
          <span style="width:10px"></span>
          <span>バッジ名</span>
          <input id="sgc-ap-badge" type="text" value="${apBadge}" placeholder="例: 🏅新規アポ獲得" style="width:300px">
        </div>
        <div class="sgc-help">「新規アポ」の既定値（カスタムOutcomeに同名があればそちらが優先）。</div>
      </div>
    `));

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>カスタムOutcome（HubSpotラベル）</label>
        <div>
          <div class="sgc-help">HubSpot連携タブでラベルID/タイトルを登録すると、ここに一覧が出ます。各ラベルごとに「有効/無効・XP・バッジ」を設定可能。</div>
          <div id="sgc-custom-list" class="sgc-list"></div>
          <div class="sgc-help">行の追加/削除は「HubSpot連携」タブで行ってください。</div>
        </div>
      </div>
    `));

    const list2=bodyArea.querySelector("#sgc-custom-list");
    ensureLabelsArray();
    labelsCache.forEach(it=> list2.appendChild(renderCustomCard(it)));
    if(labelsCache.length===0){
      list2.appendChild(h(`<div class="sgc-help">※ まだラベルがありません。まず「HubSpot連携」タブでラベルを追加してください。</div>`));
    }

    function renderCustomCard(item){
      const enabled = !!item.enabled;
      const xp = Number.isFinite(Number(item.xp)) ? Number(item.xp) : "";
      const badge = item.badge || "";
      const el=h(`
        <div class="sgc-card" data-id="${item.id||""}" data-title="${item.title||""}">
          <div><label class="muted">ラベルID</label><div><strong>${item.id||"(未指定)"}</strong></div></div>
          <div><label class="muted">タイトル</label><div>${item.title||"(未指定)"}</div></div>
          <div class="full" style="display:flex;gap:10px;align-items:center">
            <label style="display:flex;gap:6px;align-items:center"><input class="sgc-en" type="checkbox" ${enabled?"checked":""}> 有効にする</label>
            <span>XP</span><input class="sgc-xp" type="number" min="0" step="1" value="${xp}" style="max-width:120px">
            <span>バッジ</span><input class="sgc-badge" type="text" value="${badge}" placeholder="例: 🏷︎見込みA 成果" style="max-width:300px">
          </div>
        </div>
      `);
      return el;
    }
  }

  function collectScoreToCaches(){
    const r=safeRules();
    r.xp.call.perCall = asNum(modal.querySelector("#sgc-xp-call")?.value,0);

    const rows=[...modal.querySelectorAll("#sgc-minutes-list .sgc-row-compact")];
    const list = rows.map(row=>({ min:asNum(row.querySelector(".sgc-min").value,5), xp:asNum(row.querySelector(".sgc-min-xp").value,0) }));
    if(list.length===0) list.push({min:5,xp:0});
    r.xp.minutes.unitMs = list[0].min*60*1000;
    r.xp.minutes.perUnitMs = list[0].xp;
    if(list[0].min===5) r.xp.minutes.per5min=list[0].xp; else delete r.xp.minutes.per5min;
    r.xp.minutes.list = list;

    r.xp.appointment.xp = asNum(modal.querySelector("#sgc-ap-xp")?.value,20);
    r.xp.appointment.badge = String(modal.querySelector("#sgc-ap-badge")?.value||"");

    const listEl=[...modal.querySelectorAll("#sgc-custom-list .sgc-card")];
    listEl.forEach(card=>{
      const id   = card.getAttribute("data-id")||"";
      const tit  = card.getAttribute("data-title")||"";
      const en   = card.querySelector(".sgc-en").checked;
      const xp   = card.querySelector(".sgc-xp").value;
      const bd   = card.querySelector(".sgc-badge").value;
      const it = labelsCache.find(x=>(x.id||"")===(id||"") && (x.title||"")===(tit||""));
      if(it){
        it.enabled = !!en;
        const v = Number(xp);
        it.xp = Number.isFinite(v) ? v : undefined;
        it.badge = String(bd||"") || undefined;
      }
    });

    rulesCache=r;
  }

  /* ====== HubSpot連携（ラベル） ====== */
  function ensureLabelsArray(){ labelsCache = Array.isArray(labelsCache)? labelsCache : []; }

  function renderHub(){
    ensureLabelsArray();
    bodyArea.appendChild(h(`<div class="sgc-help">HubSpotの「ラベルID」と「タイトル」を行単位で追加してください。保存後、「スコア設定」タブに反映されます。</div>`));

    const area=h(`<div id="sgc-hub-list" class="sgc-list"></div>`);
    bodyArea.appendChild(area);

    const toolbar=h(`<div class="sgc-kv" style="margin:8px 0">
        <button id="sgc-add-row" class="sgc-btn">＋ 行を追加</button>
        <button id="sgc-bulk-labels" class="sgc-btn">一括貼り付け（CSV/TSV）</button>
        <button id="sgc-del-all" class="sgc-btn sgc-del">全行をクリア</button>
      </div>`);
    bodyArea.appendChild(toolbar);

    labelsCache.forEach(it=> area.appendChild(renderHubRow(it)));
    if(labelsCache.length===0){
      area.appendChild(renderHubRow({id:"", title:""}));
    }

    bodyArea.querySelector("#sgc-add-row").addEventListener("click",()=> area.appendChild(renderHubRow({id:"", title:""})));
    bodyArea.querySelector("#sgc-del-all").addEventListener("click",()=>{ labelsCache=[]; area.innerHTML=""; area.appendChild(renderHubRow({id:"", title:""})); });
    bodyArea.querySelector("#sgc-bulk-labels").addEventListener("click", openBulkLabelModal);

    function renderHubRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-hub">
          <div><label class="muted">HubSpot ラベルID</label><input class="sgc-h-id" value="${item.id||""}" placeholder="例: ac590467-..."></div>
          <div><label class="muted">ラベル名/タイトル</label><input class="sgc-h-title" value="${item.title||""}" placeholder="例: ニーズ無し / 見込みA"></div>
          <div style="display:flex;justify-content:flex-end;align-items:flex-end">
            <button class="sgc-btn sgc-del">削除</button>
          </div>
        </div>
      `);
      row.querySelector(".sgc-del").addEventListener("click",()=> row.remove());
      if(item.enabled) row.setAttribute("data-enabled","1");
      if(Number.isFinite(Number(item.xp))) row.setAttribute("data-xp", String(item.xp));
      if(item.badge) row.setAttribute("data-badge", item.badge);
      return row;
    }

    function parseBulkLabelText(text){
      const lines = String(text||"")
        .split(/\r?\n/)
        .map((line)=>line.trim())
        .filter((line)=>line.length>0);
      if(!lines.length) return [];
      const delim = lines.some((line)=>line.includes("\t")) ? "\t" : ",";
      const items=[];
      for(const line of lines){
        const cols = line.split(delim).map((c)=>c.trim());
        if(!cols[0]) continue;
        const xpVal = cols[2] !== undefined ? Number(cols[2]) : NaN;
        items.push({
          id: cols[0],
          title: cols[1] || "",
          xp: Number.isFinite(xpVal) ? Math.trunc(xpVal) : undefined,
          badge: cols[3] || "",
        });
      }
      return items;
    }

    function openBulkLabelModal(){
      const overlay=h(`
        <div class="sgc-overlay">
          <div class="sgc-overlay-card">
            <div class="sgc-help">1行あたり <code>ラベルID,タイトル,XP(任意),バッジ(任意)</code> 形式で貼り付けてください。タブ区切りにも対応します。</div>
            <textarea id="sgc-bulk-text" placeholder="例: label-id-1,見込みA,5,🏅優良見込み"></textarea>
            <div class="sgc-compact" style="justify-content:flex-end;">
              <button id="sgc-bulk-cancel" class="sgc-btn">閉じる</button>
              <button id="sgc-bulk-apply" class="sgc-btn primary">追加</button>
            </div>
          </div>
        </div>
      `);
      modal.appendChild(overlay);
      const textarea = overlay.querySelector("#sgc-bulk-text");
      textarea?.focus();
      const close=()=> overlay.remove();
      overlay.querySelector("#sgc-bulk-cancel")?.addEventListener("click", (e)=>{ e.preventDefault(); close(); });
      overlay.addEventListener("click",(event)=>{
        if(event.target === overlay){ close(); }
      });
      overlay.querySelector("#sgc-bulk-apply")?.addEventListener("click",(event)=>{
        event.preventDefault();
        const text = textarea?.value || "";
        const parsed = parseBulkLabelText(text);
        if(!parsed.length){
          toast("貼り付け内容が解析できませんでした。ラベルIDとタイトルを確認してください。", true);
          return;
        }
        parsed.forEach((item)=>{
          labelsCache.push({
            id: item.id,
            title: item.title,
            xp: item.xp,
            badge: item.badge || undefined,
          });
        });
        area.innerHTML="";
        labelsCache.forEach(it=> area.appendChild(renderHubRow(it)));
        toast(`${parsed.length} 行を追加しました`);
        close();
      });
    }
  }

  function collectHubToCache(){
    const list=[...modal.querySelectorAll("#sgc-hub-list .sgc-card")];
    const items=[];
    for(const row of list){
      const id = String(row.querySelector(".sgc-h-id")?.value||"").trim();
      const title = String(row.querySelector(".sgc-h-title")?.value||"").trim();
      if(!id && !title) continue;
      items.push({
        id, title,
        enabled: row.getAttribute("data-enabled")==="1" ? true : undefined,
        xp: Number.isFinite(Number(row.getAttribute("data-xp"))) ? Number(row.getAttribute("data-xp")) : undefined,
        badge: row.getAttribute("data-badge") || undefined,
      });
    }
    labelsCache = items;
  }

  /* ====== 承認・売上（CSV連動） ====== */
  function renderApprove(){
    const r=safeRules();
    const ap = r.approval || { enabled:true, xp:0, badge:"承認" };
    const milestones = Array.isArray(r.sales?.milestones) ? r.sales.milestones : [];

    bodyArea.appendChild(h(`
      <div class="sgc-row"><label>承認（Approval）時のXP</label>
        <div class="sgc-row-compact">
          <input id="sgc-approve-xp" type="number" min="0" step="1" value="${Number(ap.xp)||0}" style="width:120px"> <span>XP</span>
          <span>バッジ</span><input id="sgc-approve-badge" type="text" value="${String(ap.badge||"承認")}" style="width:240px">
          <label style="display:flex;gap:6px;align-items:center"><input id="sgc-approve-en" type="checkbox" ${ap.enabled!==false?"checked":""}> 有効</label>
        </div>
      </div>
    `));

    const wrap=h(`<div class="sgc-row"><label>売上達成（マイルストン）</label>
      <div class="sgc-bare">
        <div id="sgc-ms-list" class="sgc-list"></div>
        <div style="margin-top:8px"><button id="sgc-add-ms" class="sgc-btn">＋ マイルストン追加</button></div>
      </div>
    </div>`);
    bodyArea.appendChild(wrap);

    const msList=wrap.querySelector("#sgc-ms-list");
    function pushMsRow(v){ msList.appendChild(renderMsRow(v)); }
    function renderMsRow(v){
      const row=h(`<div class="sgc-row-compact">
        <span>金額（到達毎）</span><input class="sgc-ms-amt" type="number" min="0" value="${Number(v?.amount)||100000}" style="width:160px">
        <span>XP</span><input class="sgc-ms-xp" type="number" min="0" value="${Number(v?.xp)||50}" style="width:120px">
        <span>バッジ</span><input class="sgc-ms-badge" type="text" value="${String(v?.badge||"売上"+(Number(v?.amount)||100000).toLocaleString()+"達成")}" style="width:280px">
        <button class="sgc-btn sgc-del">削除</button>
      </div>`);
      row.querySelector(".sgc-del").addEventListener("click",()=>row.remove());
      return row;
    }
    (milestones.length?milestones:[{amount:100000,xp:50,badge:"売上10万円達成"}]).forEach(pushMsRow);
    wrap.querySelector("#sgc-add-ms").addEventListener("click",()=>pushMsRow({amount:100000,xp:50}));
  }

  function collectApproveToCache(){
    const r=safeRules();
    r.approval = {
      enabled: !!modal.querySelector("#sgc-approve-en")?.checked,
      xp: asNum(modal.querySelector("#sgc-approve-xp")?.value,0),
      badge: String(modal.querySelector("#sgc-approve-badge")?.value||"承認")
    };
    const rows=[...modal.querySelectorAll("#sgc-ms-list .sgc-row-compact")];
    r.sales = r.sales || {};
    r.sales.milestones = rows.map(row=>({
      amount: asNum(row.querySelector(".sgc-ms-amt").value,0),
      xp: asNum(row.querySelector(".sgc-ms-xp").value,0),
      badge: String(row.querySelector(".sgc-ms-badge").value||"")
    }));
    rulesCache=r;
  }

  function formatDateTime(iso){
    if(!iso) return "-";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return String(iso);
    return d.toLocaleString("ja-JP",{ hour12:false });
  }

  function normalizeOpsLog(raw){
    if(!raw || typeof raw !== "object") return raw;
    const clone = { ...raw };
    const ts = clone.ts || clone.createdAt || clone.at || clone.date || null;
    const deltaRaw = clone.deltaXp ?? clone.delta ?? clone.amount ?? null;
    const deltaNum = Number(deltaRaw);
    const sourceRaw = clone.source || clone.type || (clone.badgeOnBuy ? "shop" : "");
    const source = sourceRaw ? String(sourceRaw) : "";
    const type = clone.type || (source === "shop" ? "purchase" : "adjust");
    const badgeRaw = clone.badge ?? clone.badgeOnBuy;
    const noteRaw = clone.note ?? clone.reason;
    return {
      ...clone,
      ts,
      createdAt: ts,
      deltaXp: Number.isFinite(deltaNum) ? deltaNum : undefined,
      type,
      source: source || type,
      badge: badgeRaw != null && badgeRaw !== "" ? String(badgeRaw) : undefined,
      note: noteRaw != null && noteRaw !== "" ? String(noteRaw) : undefined,
    };
  }

  function mapManualEventToRow(ev){
    if(!ev || typeof ev !== "object") return null;
    const action = ev.action || ev.type;
    const detail = ev.detail || {};
    const base = {
      id: ev.id || `${action || "manual"}-${ev.at || ev.ts || Date.now()}`,
      createdAt: ev.at || ev.ts || ev.createdAt || ev.date || null,
      actor: ev.actor || "",
      ip: ev.ip || "",
      ua: ev.ua || "",
      reason: detail.reason || detail.note || "",
      userId: detail.userId || detail.uid || "",
    };
    if(action === "manual.xp"){
      const delta = Number(detail.deltaXp ?? detail.delta ?? 0);
      return {
        ...base,
        type: "xp",
        deltaXp: Number.isFinite(delta) ? delta : 0,
      };
    }
    if(action === "manual.level"){
      const delta = Number(detail.deltaLevel ?? detail.delta ?? 0);
      return {
        ...base,
        type: "level",
        deltaLevel: Number.isFinite(delta) ? delta : 0,
      };
    }
    return null;
  }

  function downloadManualCsv(items){
    const header=["timestamp","userId","deltaXp","deltaLevel","reason","actor","ip","ua"];
    const rows=(items||[]).map((item)=>[
      item?.createdAt || "",
      item?.userId || "",
      Number.isFinite(item?.deltaXp) ? item.deltaXp : "",
      Number.isFinite(item?.deltaLevel) ? item.deltaLevel : "",
      item?.reason || "",
      item?.actor || "",
      item?.ip || "",
      item?.ua || "",
    ]);
    downloadCsv(`manual-log-${tenant()}.csv`, header, rows);
  }

  function downloadAuditCsv(items){
    const header=["timestamp","action","actor","detail","ip","ua"];
    const rows=(items||[]).map((item)=>{
      let detail="";
      if(typeof item?.detail === "string"){
        detail = item.detail;
      }else if(item?.detail){
        try{ detail = JSON.stringify(item.detail); }catch{ detail=""; }
      }
      return [
        item?.at || item?.ts || "",
        item?.action || "",
        item?.actor || "",
        detail,
        item?.ip || "",
        item?.ua || "",
      ];
    });
    downloadCsv(`audit-log-${tenant()}.csv`, header, rows);
  }

  async function fetchAdjustments(limit=50, userIdFilter=""){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ adjustmentsCache=[]; return adjustmentsCache; }
    const params = new URLSearchParams();
    params.set("limit", String(clamp(Math.max(50, limit), 1, 200)));
    const url = `${baseURL()}/ops/${encodeURIComponent(tenant())}/audit?${params.toString()}`;
    try{
      const res = await apiGET(url, profile);
      const items = Array.isArray(res?.items) ? res.items : [];
      const rows = [];
      for(const ev of items){
        const mapped = mapManualEventToRow(ev);
        if(!mapped) continue;
        if(userIdFilter && mapped.userId !== userIdFilter) continue;
        rows.push(mapped);
      }
      adjustmentsCache = rows;
      return adjustmentsCache;
    }catch(e){
      const status = statusOf(e);
      if(status === 404 || status === 405){
        try{
          const legacyParams = new URLSearchParams();
          legacyParams.set("limit", String(clamp(Math.max(50, limit), 1, 200)));
          const legacyUrl = `${baseURL()}/tenant/${encodeURIComponent(tenant())}/audit?${legacyParams.toString()}`;
          const res = await apiGET(legacyUrl, profile);
          const items = Array.isArray(res?.items) ? res.items : [];
          const rows = [];
          for(const ev of items){
            const mapped = mapManualEventToRow(ev);
            if(!mapped) continue;
            if(userIdFilter && mapped.userId !== userIdFilter) continue;
            rows.push(mapped);
          }
          adjustmentsCache = rows;
          return adjustmentsCache;
        }catch(err){
          console.error("fetchAdjustments (legacy)", err);
          throw err;
        }
      }
      console.error("fetchAdjustments", e);
      throw e;
    }
  }

  async function fetchShopItems(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ shopItemsCache=[]; return shopItemsCache; }
    const params = new URLSearchParams();
    params.set("tenant", tenant());
    const url = `${baseURL()}/ops/catalog?${params.toString()}`;
    try{
      const res = await apiGET(url, profile);
      shopItemsCache = Array.isArray(res?.items) ? res.items : [];
      return shopItemsCache;
    }catch(e){
      const code = e && typeof e === "object" && "message" in e ? String(e.message) : String(e ?? "");
      if(code === "404" || code === "405"){
        try{
          const legacyUrl = `${baseURL()}/tenant/${encodeURIComponent(tenant())}/shop/items`;
          const res = await apiGET(legacyUrl, profile);
          shopItemsCache = Array.isArray(res?.items) ? res.items : [];
          return shopItemsCache;
        }catch(err){
          console.error("fetchShopItems (legacy)", err);
          throw err;
        }
      }
      console.error("fetchShopItems", e);
      throw e;
    }
  }

  async function fetchShopItemsV2(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ shopItemsV2Cache=[]; return shopItemsV2Cache; }
    try{
      const res = await apiGET(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/items`, profile);
      shopItemsV2Cache = Array.isArray(res?.items) ? res.items : [];
      return shopItemsV2Cache;
    }catch(e){
      console.error("fetchShopItemsV2", e);
      throw e;
    }
  }

  async function saveShopItemV2(item){
    ensureProfileFromInputs();
    if(!profile.baseUrl) throw new Error("base-required");
    const payload = { ...item };
    if(!payload.name) throw new Error("name-required");
    if(!Number.isFinite(Number(payload.value))) throw new Error("value-invalid");
    return apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/items`, payload, profile);
  }

  async function deleteShopItemV2(id, opts={}){
    ensureProfileFromInputs();
    if(!profile.baseUrl) throw new Error("base-required");
    const suffix = opts?.hard ? "?hard=1" : "";
    return apiDELETE(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/items/${encodeURIComponent(id)}${suffix}`, profile);
  }

  async function restoreShopItemV2(id){
    ensureProfileFromInputs();
    if(!profile.baseUrl) throw new Error("base-required");
    return apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/items/${encodeURIComponent(id)}/restore`, {}, profile);
  }

  async function fetchBadgesV2(){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ badgesCache=[]; return badgesCache; }
    try{
      const res = await apiGET(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/badges`, profile);
      badgesCache = Array.isArray(res?.badges) ? res.badges : [];
      return badgesCache;
    }catch(e){
      console.error("fetchBadgesV2", e);
      throw e;
    }
  }

  async function saveBadgeV2(item){
    ensureProfileFromInputs();
    if(!profile.baseUrl) throw new Error("base-required");
    return apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/badges`, item, profile);
  }

  async function replaceBadgesV2(list){
    ensureProfileFromInputs();
    if(!profile.baseUrl) throw new Error("base-required");
    return apiPUT(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/badges`, { badges: list }, profile);
  }

  async function deleteBadgeV2(id, opts={}){
    ensureProfileFromInputs();
    if(!profile.baseUrl) throw new Error("base-required");
    const suffix = opts?.hard ? "?hard=1" : "";
    return apiDELETE(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/badges/${encodeURIComponent(id)}${suffix}`, profile);
  }

  async function fetchAudit(limit=100){
    ensureProfileFromInputs();
    if(!profile.baseUrl){ auditCache=[]; return auditCache; }
    const params = new URLSearchParams();
    params.set("limit", String(clamp(limit, 1, 200)));
    const url = `${baseURL()}/ops/${encodeURIComponent(tenant())}/audit?${params.toString()}`;
    try{
      const res = await apiGET(url, profile);
      auditCache = Array.isArray(res?.items) ? res.items : [];
      return auditCache;
    }catch(e){
      const status = statusOf(e);
      if(status === 404 || status === 405){
        try{
          const legacyUrl = `${baseURL()}/tenant/${encodeURIComponent(tenant())}/audit?${params.toString()}`;
          const res = await apiGET(legacyUrl, profile);
          auditCache = Array.isArray(res?.items) ? res.items : [];
          return auditCache;
        }catch(err){
          console.error("fetchAudit (legacy)", err);
          throw err;
        }
      }
      console.error("fetchAudit", e);
      throw e;
    }
  }

  function summarizeAuditDetail(ev){
    const d = ev?.detail;
    try{
      if(ev?.action==="adjust.create" && d){
        const xp = Number(d.deltaXp);
        const xpText = Number.isFinite(xp) ? `${xp>=0?"+":""}${xp}XP` : "";
        const bits = [
          d.userId ? String(d.userId) : "",
          xpText,
          d.badge ? `badge:${d.badge}` : "",
          d.note ? `note:${d.note}` : "",
        ].filter(Boolean);
        return bits.join(" / ");
      }
      if(ev?.action==="shop.item.put" && d){
        return `items=${d.count ?? 0}`;
      }
      if(ev?.action==="shop.purchase" && d){
        const xp = Number(d.deltaXp);
        const parts = [
          d.title ? String(d.title) : "",
          d.qty != null ? `qty:${d.qty}` : "",
          d.userId ? `user:${d.userId}` : "",
          Number.isFinite(xp) ? `${xp>=0?"+":""}${xp}XP` : "",
          d.newStock != null ? `stock:${d.newStock}` : "",
        ].filter(Boolean);
        return parts.join(" / ");
      }
    }catch{}
    if(!d) return "";
    if(typeof d === "string") return d;
    try{
      return JSON.stringify(d);
    }catch{
      return "";
    }
  }

  /* ====== CSV取込 ====== */
  function renderCSV(){
    const box=h(`
      <div class="sgc-row"><label>CSVのアップロード</label>
        <div>
          <div class="sgc-row-compact">
            <input id="sgc-csv-file" type="file" accept=".csv">
            <button id="sgc-upload" class="sgc-btn">アップロード</button>
            <button id="sgc-open-admin" class="sgc-btn">管理画面を開く</button>
          </div>
          <div class="sgc-help">まずは <code>/admin/upload</code> にPOSTします。ダメなら <code>/admin/csv</code> → <code>/admin/import</code> の順に試行。全部ダメなら管理画面 /admin を開きます。</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(box);
    box.querySelector("#sgc-upload").addEventListener("click", doUpload);
    box.querySelector("#sgc-open-admin").addEventListener("click", ()=> window.open(`${baseURL()}/admin?tenant=${encodeURIComponent(tenant())}`,"_blank"));

    async function doUpload(){
      ensureProfileFromInputs();
      const f=modal.querySelector("#sgc-csv-file")?.files?.[0];
      if(!f){ toast("CSVファイルを選択してください", true); return; }
      const tries=[ "/admin/upload", "/admin/csv", "/admin/import" ];
      const form=new FormData(); form.append("file", f); form.append("tenant", tenant());
      for(const path of tries){
        try{
          await apiPOSTForm(`${baseURL()}${path}`, form, profile);
          toast("CSV取込を受け付けました");
          return;
        }catch(e){ console.warn("upload fail", path, e); }
      }
      toast("サーバ未対応のようです。管理画面から取り込みを行ってください。", true);
    }
  }

  /* ====== ダッシュボード ====== */
  function renderDash(){
    const b=h(`
      <div class="sgc-row"><label>ダッシュボード</label>
        <div class="sgc-kv">
          <button id="sgc-open-dash" class="sgc-btn">開く</button>
          <div class="sgc-help">BaseURL の <code>/admin/dashboard?tenant=...</code> を新規タブで開きます。</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(b);
    b.querySelector("#sgc-open-dash").addEventListener("click",()=> window.open(`${baseURL()}/admin/dashboard?tenant=${encodeURIComponent(tenant())}`,"_blank"));
  }

  function renderAdjust(){
    ensureProfileFromInputs();
    const form=h(`
      <div class="sgc-bare">
        <div class="sgc-compact sgc-row-compact">
          <label class="sgc-inline" style="display:flex;flex-direction:column;gap:4px;">
            <span class="muted">ユーザーID</span>
            <input id="sgc-adj-user" placeholder="ユーザーID" style="width:200px" title="社内ユーザーを識別するためのIDです（HubSpot/Zoom/HabiticaのIDマッピングに使用）。不明な場合は担当者に確認してください。">
          </label>
          <label class="sgc-inline" style="display:flex;flex-direction:column;gap:4px;">
            <span class="muted">XP増減</span>
            <input id="sgc-adj-delta" type="number" step="1" value="0" style="width:140px">
          </label>
          <label class="sgc-inline" style="display:flex;flex-direction:column;gap:4px;">
            <span class="muted">レベル増減</span>
            <input id="sgc-adj-level" type="number" step="1" value="0" style="width:140px">
          </label>
        </div>
        <div class="sgc-compact">
          <textarea id="sgc-adj-reason" class="wide" placeholder="理由 / メモ (任意)" style="min-height:80px;"></textarea>
        </div>
        <div class="sgc-compact">
          <button id="sgc-adj-submit" class="sgc-btn primary">手動調整を登録</button>
          <button id="sgc-adj-reload" class="sgc-btn">履歴を再読込</button>
          <button id="sgc-adj-export" class="sgc-btn">CSVダウンロード</button>
          <span class="sgc-help">XPとレベルは片方のみでも可。最新50件を表示します。</span>
        </div>
        <div class="sgc-kv" style="margin-top:6px; gap:8px;">
          <button id="sgc-quick-misscall" type="button" class="sgc-btn">ミス架電 -1</button>
          <button id="sgc-quick-demo5" type="button" class="sgc-btn">デモ +5</button>
        </div>
      </div>
    `);
    bodyArea.appendChild(form);

    const filterRow=h(`
      <div class="sgc-compact sgc-filter">
        <label style="font-size:13px;color:#555">履歴フィルタ（userId）</label>
        <input id="sgc-adj-filter" placeholder="例: u001" style="width:160px">
        <button id="sgc-adj-filter-btn" class="sgc-btn">適用</button>
        <button id="sgc-adj-filter-clear" class="sgc-btn sgc-del">解除</button>
      </div>
    `);
    bodyArea.appendChild(filterRow);

    const table=h(`
      <table class="sgc-table">
        <thead>
          <tr>
            <th>時刻</th>
            <th>ユーザー</th>
            <th>XP</th>
            <th>レベル</th>
            <th>理由</th>
            <th>実行者</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `);
    const tbody=table.querySelector("tbody");
    bodyArea.appendChild(table);

    const status=h(`<div class="sgc-help" id="sgc-adj-status"></div>`);
    bodyArea.appendChild(status);

    let currentFilter="";

    function renderRows(){
      tbody.innerHTML="";
      if(!adjustmentsCache.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=7;
        td.style.color="#777";
        td.textContent="履歴がありません";
        tr.appendChild(td);
        tbody.appendChild(tr);
        status.textContent="";
        return;
      }
      adjustmentsCache.forEach(item=>{
        const tr=document.createElement("tr");
        if(item?.ua){
          tr.title = item.ua;
        }
        const xpText = Number.isFinite(item?.deltaXp) ? `${item.deltaXp>=0?"+":""}${item.deltaXp}` : "";
        const lvText = Number.isFinite(item?.deltaLevel) ? `${item.deltaLevel>=0?"+":""}${item.deltaLevel}` : "";
        const cells=[
          formatDateTime(item?.createdAt),
          item?.userId || "",
          xpText,
          lvText,
          item?.reason || "",
          item?.actor || "",
          item?.ip || "",
        ];
        cells.forEach((txt,idx)=>{
          const td=document.createElement("td");
          td.textContent = txt ?? "";
          if(idx===2 || idx===3){
            td.style.fontWeight="700";
            td.style.textAlign="right";
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      status.textContent = `取得件数: ${adjustmentsCache.length}${currentFilter ? ` / userId=${currentFilter}` : ""}`;
    }

    async function reload(filterVal=currentFilter){
      currentFilter = String(filterVal || "").trim();
      try{
        await fetchAdjustments(50, currentFilter);
        renderRows();
      }catch(e){
        toast("履歴の取得に失敗しました: "+describeHttpError(e), true);
      }
    }

    async function submitAdjustment(){
      ensureProfileFromInputs();
      if(!profile.baseUrl){
        toast("BaseURL を入力してください", true);
        return;
      }
      const userId = form.querySelector("#sgc-adj-user").value.trim();
      const xpInput = form.querySelector("#sgc-adj-delta").value.trim();
      const levelInput = form.querySelector("#sgc-adj-level").value.trim();
      const reason = form.querySelector("#sgc-adj-reason").value.trim();
      if(!userId){
        toast("ユーザーIDを入力してください", true);
        form.querySelector("#sgc-adj-user").focus();
        return;
      }
      const xpDelta = xpInput === "" ? 0 : Number(xpInput);
      const levelDelta = levelInput === "" ? 0 : Number(levelInput);
      if(!Number.isFinite(xpDelta)){
        toast("XP増減は整数で入力してください", true);
        form.querySelector("#sgc-adj-delta").focus();
        return;
      }
      if(!Number.isFinite(levelDelta)){
        toast("レベル増減は整数で入力してください", true);
        form.querySelector("#sgc-adj-level").focus();
        return;
      }
      if(xpDelta === 0 && levelDelta === 0){
        toast("XP または レベルのいずれかに値を入力してください", true);
        return;
      }
      const payload = {
        userId,
        deltaXp: Math.trunc(xpDelta),
        deltaLvl: Math.trunc(levelDelta),
        note: reason || undefined,
      };
      try{
        const resp = await apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/ops/adjust-xp`, payload, profile);
        const appliedXp = Number(resp?.applied?.deltaXp || xpDelta || 0);
        const appliedLv = Number(resp?.applied?.deltaLvl || levelDelta || 0);
        const parts=[];
        if(appliedXp) parts.push(`XP:${appliedXp>=0?"+":""}${appliedXp}`);
        if(appliedLv) parts.push(`Lv:${appliedLv>=0?"+":""}${appliedLv}`);
        const summary = parts.length ? parts.join(" / ") : "OK";
        toast(`手動調整を登録しました (${summary})`);
        await reload(currentFilter);
      }catch(e){
        console.error("adjustment.submit", e);
        const status = statusOf(e);
        if(status === 401) toast("保存に失敗: 401 Unauthorized", true);
        else toast("保存に失敗: "+describeHttpError(e), true);
      }
    }

    form.querySelector("#sgc-adj-submit").addEventListener("click", submitAdjustment);
    form.querySelector("#sgc-adj-reload").addEventListener("click", ()=>reload(currentFilter));
    form.querySelector("#sgc-adj-export").addEventListener("click", ()=>{
      if(!adjustmentsCache.length){
        toast("ダウンロード対象の履歴がありません", true);
        return;
      }
      downloadManualCsv(adjustmentsCache);
    });
    filterRow.querySelector("#sgc-adj-filter-btn").addEventListener("click", ()=>{
      const v=filterRow.querySelector("#sgc-adj-filter").value;
      reload(v);
    });
    filterRow.querySelector("#sgc-adj-filter-clear").addEventListener("click", ()=>{
      filterRow.querySelector("#sgc-adj-filter").value="";
      reload("");
    });
    filterRow.querySelector("#sgc-adj-filter").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        reload(e.target.value);
      }
    });

    form.querySelector("#sgc-quick-misscall")?.addEventListener("click",(event)=>{
      event.preventDefault();
      const xp = form.querySelector("#sgc-adj-delta");
      const lv = form.querySelector("#sgc-adj-level");
      const reasonEl = form.querySelector("#sgc-adj-reason");
      if(xp) xp.value = "-1";
      if(lv) lv.value = "0";
      if(reasonEl) reasonEl.value = "ミス架電";
    });
    form.querySelector("#sgc-quick-demo5")?.addEventListener("click",(event)=>{
      event.preventDefault();
      const xp = form.querySelector("#sgc-adj-delta");
      const lv = form.querySelector("#sgc-adj-level");
      const reasonEl = form.querySelector("#sgc-adj-reason");
      if(xp) xp.value = "5";
      if(lv) lv.value = "0";
      if(reasonEl) reasonEl.value = "デモ付与";
    });

    reload("");
  }

  function renderShop(){
    ensureProfileFromInputs();
    bodyArea.appendChild(h(`<div class="sgc-help">ショップ品目を管理し、購入処理を登録します。</div>`));
    const hidePref = localStorage.getItem(HIDE_PAID_KEY)==="1" || localStorage.getItem(HIDE_PAID_KEY)==="true";
    const hideToggle=h(`
      <div class="sgc-compact" style="margin:8px 0 4px;">
        <label style="display:flex;align-items:center;gap:6px">
          <input id="sgc-hide-paid-toggle" type="checkbox" ${hidePref?"checked":""}>
          Habitica公式の有料アイテムを非表示にする
        </label>
        <span class="sgc-help">有効にすると、ブックマークレット/インジェクタ経由で Habitica 側の有料リワードを隠します。</span>
      </div>
    `);
    bodyArea.appendChild(hideToggle);
    hideToggle.querySelector("#sgc-hide-paid-toggle")?.addEventListener("change",(event)=>{
      const flag = !!event.target.checked;
      if(flag){
        localStorage.setItem(HIDE_PAID_KEY, "1");
        toast("有料アイテムを非表示に設定しました（Habitica画面を再読み込みしてください）");
      }else{
        localStorage.removeItem(HIDE_PAID_KEY);
        toast("有料アイテムの非表示を解除しました");
      }
      try{
        window.top?.postMessage({ type:"sgc.hidePaidRewards", value: flag }, "*");
      }catch(_){}
    });
    const cols=h(`<div class="sgc-cols"></div>`);
    bodyArea.appendChild(cols);
    const manageCol=h(`<div class="sgc-col"></div>`);
    const purchaseCol=h(`<div class="sgc-col"></div>`);
    cols.appendChild(manageCol);
    cols.appendChild(purchaseCol);

    const manageCard=h(`
      <div class="sgc-bare">
        <div class="sgc-compact">
          <button id="sgc-shop-add" class="sgc-btn">＋ 品目を追加</button>
          <button id="sgc-shop-save" class="sgc-btn primary">保存</button>
          <button id="sgc-shop-refresh" class="sgc-btn">再読込</button>
        </div>
        <div id="sgc-shop-list" class="sgc-list" style="margin-top:10px"></div>
        <div class="sgc-help">価格はXPの正の整数。stockを空欄にすると無制限になります。</div>
      </div>
    `);
    manageCol.appendChild(manageCard);
    const listEl=manageCard.querySelector("#sgc-shop-list");

    const purchaseCard=h(`
      <div class="sgc-bare">
        <div class="sgc-card sgc-card-purchase">
          <div>
            <label class="muted">ユーザーID</label>
            <input id="sgc-shop-buy-user" placeholder="例: u001">
          </div>
          <div>
            <label class="muted">ユーザー名 (任意)</label>
            <input id="sgc-shop-buy-name" placeholder="例: 田中">
          </div>
          <div class="full">
            <label class="muted">品目</label>
            <select id="sgc-shop-buy-item"></select>
          </div>
          <div>
            <label class="muted">数量</label>
            <input id="sgc-shop-buy-qty" type="number" min="1" step="1" value="1">
          </div>
          <div class="full sgc-compact">
            <button id="sgc-shop-buy-run" class="sgc-btn primary">購入処理</button>
            <button id="sgc-shop-buy-refresh" class="sgc-btn">品目を再読込</button>
          </div>
          <div class="full sgc-help">購入するとXPが減算され、在庫が更新されます。</div>
        </div>
      </div>
    `);
    purchaseCol.appendChild(purchaseCard);

    function renderItemRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-shop">
          <div class="full">
            <label class="muted">品目名</label>
            <input class="sgc-shop-title" placeholder="例: スタバ券">
          </div>
          <div>
            <label class="muted">価格 (XP)</label>
            <input class="sgc-shop-price" type="number" min="1" step="1">
          </div>
          <div>
            <label class="muted">在庫</label>
            <input class="sgc-shop-stock" type="number" min="0" step="1" placeholder="空欄=∞">
          </div>
          <div>
            <label class="muted">購入時バッジ</label>
            <input class="sgc-shop-badge" placeholder="例: ☕ごほうび">
          </div>
          <div>
            <label class="muted">状態</label>
            <div style="display:flex;flex-direction:column;gap:8px">
              <label style="display:flex;align-items:center;gap:6px"><input class="sgc-shop-enabled" type="checkbox" checked> 有効</label>
              <button type="button" class="sgc-btn sgc-del sgc-shop-remove">削除</button>
            </div>
          </div>
        </div>
      `);
      row.dataset.id = item?.id || "";
      row.querySelector(".sgc-shop-title").value = item?.title || "";
      const priceVal = Number(item?.priceXp);
      row.querySelector(".sgc-shop-price").value = Number.isFinite(priceVal) ? String(priceVal) : "";
      row.querySelector(".sgc-shop-stock").value =
        item?.stock === null || item?.stock === undefined ? "" : String(item.stock);
      row.querySelector(".sgc-shop-badge").value = item?.badgeOnBuy || "";
      row.querySelector(".sgc-shop-enabled").checked = item?.enabled !== false;
      row.querySelector(".sgc-shop-remove").addEventListener("click",()=> row.remove());
      return row;
    }

    function renderShopRows(){
      listEl.innerHTML="";
      if(!shopItemsCache.length){
        listEl.appendChild(h(`<div class="sgc-help">まだ品目がありません。『＋ 品目を追加』から登録してください。</div>`));
        return;
      }
      shopItemsCache.forEach(item=>{
        listEl.appendChild(renderItemRow(item));
      });
    }

    function fillPurchaseItems(selectedId=""){
      const sel=purchaseCard.querySelector("#sgc-shop-buy-item");
      sel.innerHTML="";
      if(!shopItemsCache.length){
        const opt=document.createElement("option");
        opt.value="";
        opt.textContent="品目がありません";
        sel.appendChild(opt);
        sel.disabled=true;
        return;
      }
      sel.disabled=false;
      shopItemsCache.forEach(item=>{
        const opt=document.createElement("option");
        const stockLabel = item?.stock === null || item?.stock === undefined ? "在庫∞" : `在庫${item.stock}`;
        opt.value = item?.id || "";
        opt.textContent = `${item?.title || ""} / XP ${item?.priceXp ?? ""} / ${stockLabel}`;
        if(item?.enabled === false){
          opt.disabled=true;
          opt.textContent += " (無効)";
        }
        if(selectedId && item?.id === selectedId){
          opt.selected=true;
        }
        sel.appendChild(opt);
      });
    }

    async function reloadShop(preserveId=""){
      const currentSelect = preserveId || purchaseCard.querySelector("#sgc-shop-buy-item")?.value || "";
      try{
        await fetchShopItems();
        renderShopRows();
        fillPurchaseItems(currentSelect);
      }catch(e){
        toast("ショップの読み込みに失敗しました: "+describeHttpError(e), true);
      }
    }

    async function saveItems(){
      ensureProfileFromInputs();
      if(!profile.baseUrl){
        toast("BaseURL を入力してください", true);
        return;
      }
      const rows=[...listEl.querySelectorAll(".sgc-card-shop")];
      const items=[];
      for(const row of rows){
        const title=row.querySelector(".sgc-shop-title").value.trim();
        const priceVal=Number(row.querySelector(".sgc-shop-price").value);
        const stockInput=row.querySelector(".sgc-shop-stock").value.trim();
        const badge=row.querySelector(".sgc-shop-badge").value.trim();
        const enabled=row.querySelector(".sgc-shop-enabled").checked;
        if(!title){
          toast("品目名を入力してください", true);
          row.querySelector(".sgc-shop-title").focus();
          return;
        }
        if(!Number.isFinite(priceVal) || priceVal <= 0 || !Number.isInteger(priceVal)){
          toast("価格は1以上の整数で入力してください", true);
          row.querySelector(".sgc-shop-price").focus();
          return;
        }
        let stockVal = null;
        if(stockInput !== ""){
          const n = Number(stockInput);
          if(!Number.isFinite(n) || n < 0 || !Number.isInteger(n)){
            toast("在庫は0以上の整数で入力してください", true);
            row.querySelector(".sgc-shop-stock").focus();
            return;
          }
          stockVal = Math.trunc(n);
        }
        const item = {
          title,
          priceXp: Math.trunc(priceVal),
          enabled,
        };
        const id = row.dataset.id?.trim();
        if(id) item.id = id;
        if(stockInput === ""){
          item.stock = null;
        }else if(stockVal !== null){
          item.stock = stockVal;
        }
        if(badge) item.badgeOnBuy = badge;
        items.push(item);
      }
      try{
        try{
          await apiPUT(`${baseURL()}/ops/catalog`, { tenant: tenant(), items }, profile);
        }catch(err){
          const code = err && typeof err === "object" && "message" in err ? String(err.message) : String(err ?? "");
          if(code === "404" || code === "405"){
            await apiPUT(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/shop/items`, { items }, profile);
          }else{
            throw err;
          }
        }
        toast("ショップの品目を保存しました");
        await reloadShop();
      }catch(e){
        console.error("shop.save", e);
        const status = statusOf(e);
        const bodyText = String(e?.body || e?.message || "");
        if(status === 401) toast("保存に失敗: 401 Unauthorized", true);
        else if(bodyText.includes("price-invalid")) toast("保存に失敗: 価格が正の整数ではありません", true);
        else if(bodyText.includes("stock-invalid")) toast("保存に失敗: 在庫が0以上の整数ではありません", true);
        else toast("保存に失敗: "+describeHttpError(e), true);
      }
    }

    async function runPurchase(){
      ensureProfileFromInputs();
      if(!profile.baseUrl){
        toast("BaseURL を入力してください", true);
        return;
      }
      const userId=purchaseCard.querySelector("#sgc-shop-buy-user").value.trim();
      const userName=purchaseCard.querySelector("#sgc-shop-buy-name").value.trim();
      const itemId=purchaseCard.querySelector("#sgc-shop-buy-item").value;
      const qtyVal=Number(purchaseCard.querySelector("#sgc-shop-buy-qty").value);
      if(!userId){
        toast("ユーザーIDを入力してください", true);
        purchaseCard.querySelector("#sgc-shop-buy-user").focus();
        return;
      }
      if(!itemId){
        toast("購入する品目を選択してください", true);
        return;
      }
      if(!Number.isFinite(qtyVal) || qtyVal <= 0 || !Number.isInteger(qtyVal)){
        toast("数量は1以上の整数で入力してください", true);
        purchaseCard.querySelector("#sgc-shop-buy-qty").focus();
        return;
      }
      const payload={
        userId,
        userName: userName || undefined,
        itemId,
        qty: Math.trunc(qtyVal),
      };
      try{
        let res;
        try{
          res = await apiPOST(`${baseURL()}/ops/purchase`, { tenant: tenant(), ...payload }, profile);
        }catch(err){
          const code = err && typeof err === "object" && "message" in err ? String(err.message) : String(err ?? "");
          if(code === "404" || code === "405"){
            res = await apiPOST(`${baseURL()}/tenant/${encodeURIComponent(tenant())}/shop/purchase`, payload, profile);
          }else{
            throw err;
          }
        }
        const newStock = res?.newStock;
        const stockLabel = newStock === null || newStock === undefined ? "在庫: ∞" : `在庫: ${newStock}`;
        toast(`購入を登録しました (${stockLabel})`);
        adjustmentsCache = [];
        await reloadShop(itemId);
        try{
          await fetchAdjustments(50);
        }catch(err){
          console.warn("shop.purchase reload adjustments failed", err);
        }
      }catch(e){
        console.error("shop.purchase", e);
        const status = statusOf(e);
        const bodyText = String(e?.body || e?.message || "");
        if(status === 401) toast("購入に失敗: 401 Unauthorized", true);
        else if(status === 404 || bodyText.includes("item-not-found")) toast("購入に失敗: 品目が見つかりません", true);
        else if(bodyText.includes("stock-shortage")) toast("購入に失敗: 在庫が不足しています", true);
        else toast("購入に失敗: "+describeHttpError(e), true);
      }
    }

    manageCard.querySelector("#sgc-shop-add").addEventListener("click",()=> listEl.appendChild(renderItemRow({ title:"", priceXp:10, stock:null, enabled:true })));
    manageCard.querySelector("#sgc-shop-save").addEventListener("click", saveItems);
    manageCard.querySelector("#sgc-shop-refresh").addEventListener("click", ()=>reloadShop());
    purchaseCard.querySelector("#sgc-shop-buy-refresh").addEventListener("click", ()=>reloadShop());
    purchaseCard.querySelector("#sgc-shop-buy-run").addEventListener("click", runPurchase);

    reloadShop();
  }

  function renderShopManage(){
    ensureProfileFromInputs();
    const wrap=h(`
      <div class="sgc-bare">
        <div class="sgc-compact" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button class="sgc-btn" id="sgc-shopv2-add">＋ 品目を追加</button>
          <button class="sgc-btn" id="sgc-shopv2-reload">再読込</button>
          <span class="sgc-help">Render デプロイ後の新API。保存後は Habitica 埋め込みに即時反映されます。</span>
        </div>
        <div class="sgc-list" id="sgc-shopv2-list"></div>
        <div class="sgc-help" id="sgc-shopv2-status"></div>
      </div>
    `);
    bodyArea.appendChild(wrap);
    const listEl = wrap.querySelector("#sgc-shopv2-list");
    const statusEl = wrap.querySelector("#sgc-shopv2-status");

    function renderRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-shop" data-id="${item?.id || ""}">
          <div class="sgc-grid">
            <label>
              <span class="muted">名前</span>
              <input class="sgc-sv2-name" placeholder="例: スタバ券">
            </label>
            <label>
              <span class="muted">価値 (XP等)</span>
              <input class="sgc-sv2-value" type="number" step="1" min="-9999">
            </label>
            <label>
              <span class="muted">有料フラグ</span>
              <input class="sgc-sv2-paid" type="checkbox">
            </label>
            <label>
              <span class="muted">公開状態</span>
              <input class="sgc-sv2-active" type="checkbox" checked>
            </label>
          </div>
          <label class="muted" style="display:block;margin-top:8px;">
            説明
            <textarea class="sgc-sv2-desc" rows="2" placeholder="購入者向けの説明文"></textarea>
          </label>
          <div class="sgc-compact" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" class="sgc-btn primary sgc-sv2-save">保存</button>
            <button type="button" class="sgc-btn sgc-del sgc-sv2-delete">削除</button>
            <button type="button" class="sgc-btn sgc-sv2-restore" style="display:none;">復活</button>
          </div>
        </div>
      `);
      row.querySelector(".sgc-sv2-name").value = item?.name || "";
      row.querySelector(".sgc-sv2-value").value = item?.value != null ? String(item.value) : "";
      row.querySelector(".sgc-sv2-desc").value = item?.description || "";
      row.querySelector(".sgc-sv2-paid").checked = item?.isPaid === true;
      row.querySelector(".sgc-sv2-active").checked = item?.active !== false;
      if(item?.active === false){
        row.querySelector(".sgc-sv2-restore").style.display = "inline-flex";
      }
      row.querySelector(".sgc-sv2-save").addEventListener("click", async ()=>{
        try{
          const payload={
            id: row.dataset.id || undefined,
            name: row.querySelector(".sgc-sv2-name").value.trim(),
            value: Number(row.querySelector(".sgc-sv2-value").value || 0),
            description: row.querySelector(".sgc-sv2-desc").value.trim() || undefined,
            isPaid: row.querySelector(".sgc-sv2-paid").checked,
            active: row.querySelector(".sgc-sv2-active").checked,
          };
          if(!payload.name){
            toast("品目名を入力してください", true);
            row.querySelector(".sgc-sv2-name").focus();
            return;
          }
          if(!Number.isFinite(payload.value) || payload.value === 0){
            toast("価値は0以外の数値で入力してください", true);
            row.querySelector(".sgc-sv2-value").focus();
            return;
          }
          await saveShopItemV2(payload);
          toast("品目を保存しました");
          await reload();
        }catch(e){
          console.error("shopv2.save", e);
          toast("保存に失敗: "+describeHttpError(e), true);
        }
      });
      row.querySelector(".sgc-sv2-delete").addEventListener("click", async ()=>{
        const id = row.dataset.id || "";
        if(!id){
          row.remove();
          return;
        }
        try{
          await deleteShopItemV2(id);
          toast("品目を無効化しました");
          await reload();
        }catch(e){
          console.error("shopv2.delete", e);
          toast("削除に失敗: "+describeHttpError(e), true);
        }
      });
      row.querySelector(".sgc-sv2-restore").addEventListener("click", async ()=>{
        const id = row.dataset.id || "";
        if(!id) return;
        try{
          await restoreShopItemV2(id);
          toast("品目を復活させました");
          await reload();
        }catch(e){
          console.error("shopv2.restore", e);
          toast("復活に失敗: "+describeHttpError(e), true);
        }
      });
      return row;
    }

    async function reload(){
      try{
        const items = await fetchShopItemsV2();
        listEl.innerHTML="";
        if(!items.length){
          listEl.appendChild(h(`<div class="sgc-help">まだ品目がありません。『＋ 品目を追加』から登録してください。</div>`));
        }else{
          items.forEach((item)=> listEl.appendChild(renderRow(item)));
        }
        statusEl.textContent = `取得件数: ${items.length}`;
      }catch(e){
        statusEl.textContent = "読み込みに失敗しました";
        toast("ショップ管理の読み込みに失敗: "+describeHttpError(e), true);
      }
    }

    wrap.querySelector("#sgc-shopv2-add").addEventListener("click", ()=>{
      const tmpRow = renderRow({ id:"", name:"", value:1, description:"" });
      tmpRow.querySelector(".sgc-sv2-name").focus();
      listEl.prepend(tmpRow);
    });
    wrap.querySelector("#sgc-shopv2-reload").addEventListener("click", ()=> reload());

    reload();
  }

  function renderBadgeManage(){
    ensureProfileFromInputs();
    const typeOptions=[
      { value:"totalXpAtLeast", label:"累計XP >=" },
      { value:"callsDurationMsAtLeast", label:"通話時間(ms) >=" },
      { value:"appointmentsCountAtLeast", label:"アポ数 >=" },
      { value:"hasLabelCountAtLeast", label:"ラベル回数 >=" },
    ];
    const wrap=h(`
      <div class="sgc-bare">
        <div class="sgc-compact" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="sgc-btn" id="sgc-badge-add">＋ バッジを追加</button>
          <button class="sgc-btn" id="sgc-badge-reload">再読込</button>
          <button class="sgc-btn" id="sgc-badge-saveall">まとめて保存</button>
          <span class="sgc-help">バッジの付与条件とXP付与を管理します。</span>
        </div>
        <div class="sgc-list" id="sgc-badge-list"></div>
        <div class="sgc-help" id="sgc-badge-status"></div>
      </div>
    `);
    bodyArea.appendChild(wrap);
    const listEl = wrap.querySelector("#sgc-badge-list");
    const statusEl = wrap.querySelector("#sgc-badge-status");

    function renderRow(item){
      const row=h(`
        <div class="sgc-card sgc-card-badge" data-id="${item?.id || ""}">
          <div class="sgc-grid">
            <label>
              <span class="muted">タイトル</span>
              <input class="sgc-badge-title" placeholder="例: 100XP達成">
            </label>
            <label>
              <span class="muted">付与XP</span>
              <input class="sgc-badge-xp" type="number" step="1">
            </label>
            <label>
              <span class="muted">アイコン</span>
              <input class="sgc-badge-icon" placeholder="例: 🏅">
            </label>
            <label>
              <span class="muted">有効</span>
              <input class="sgc-badge-active" type="checkbox" checked>
            </label>
          </div>
          <label class="muted" style="display:block;margin-top:8px;">
            説明
            <textarea class="sgc-badge-desc" rows="2" placeholder="ユーザー向けの説明文"></textarea>
          </label>
          <div class="sgc-grid" style="margin-top:8px;">
            <label>
              <span class="muted">条件タイプ</span>
              <select class="sgc-badge-type"></select>
            </label>
            <label>
              <span class="muted">しきい値</span>
              <input class="sgc-badge-threshold" type="number" step="1" min="0">
            </label>
            <label>
              <span class="muted">ラベルID</span>
              <input class="sgc-badge-label" placeholder="hasLabelCountAtLeast 用">
            </label>
          </div>
          <div class="sgc-compact" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" class="sgc-btn primary sgc-badge-save">保存</button>
            <button type="button" class="sgc-btn sgc-del sgc-badge-delete">削除</button>
          </div>
        </div>
      `);
      const typeSel=row.querySelector(".sgc-badge-type");
      typeOptions.forEach(opt=>{
        const option=document.createElement("option");
        option.value=opt.value;
        option.textContent=opt.label;
        typeSel.appendChild(option);
      });
      row.querySelector(".sgc-badge-title").value = item?.title || "";
      row.querySelector(".sgc-badge-desc").value = item?.description || "";
      row.querySelector(".sgc-badge-xp").value = item?.xp != null ? String(item.xp) : "";
      row.querySelector(".sgc-badge-icon").value = item?.icon || "";
      row.querySelector(".sgc-badge-active").checked = item?.active !== false;
      typeSel.value = item?.criteria?.type || "totalXpAtLeast";
      row.querySelector(".sgc-badge-threshold").value = item?.criteria?.threshold != null ? String(item.criteria.threshold) : "1";
      row.querySelector(".sgc-badge-label").value = item?.criteria?.labelId || "";

      row.querySelector(".sgc-badge-save").addEventListener("click", async ()=>{
        try{
          const payload={
            id: row.dataset.id || undefined,
            title: row.querySelector(".sgc-badge-title").value.trim(),
            description: row.querySelector(".sgc-badge-desc").value.trim() || undefined,
            xp: row.querySelector(".sgc-badge-xp").value === "" ? undefined : Number(row.querySelector(".sgc-badge-xp").value),
            icon: row.querySelector(".sgc-badge-icon").value.trim() || undefined,
            active: row.querySelector(".sgc-badge-active").checked,
            criteria: {
              type: row.querySelector(".sgc-badge-type").value,
              threshold: Number(row.querySelector(".sgc-badge-threshold").value || 0),
              labelId: row.querySelector(".sgc-badge-label").value.trim() || undefined,
            },
          };
          if(!payload.title){
            toast("タイトルを入力してください", true);
            row.querySelector(".sgc-badge-title").focus();
            return;
          }
          if(!Number.isFinite(payload.criteria.threshold)){
            toast("しきい値を整数で入力してください", true);
            row.querySelector(".sgc-badge-threshold").focus();
            return;
          }
          if(payload.criteria.type === "hasLabelCountAtLeast" && !payload.criteria.labelId){
            toast("ラベルIDを入力してください", true);
            row.querySelector(".sgc-badge-label").focus();
            return;
          }
          await saveBadgeV2(payload);
          toast("バッジを保存しました");
          await reload();
        }catch(e){
          console.error("badge.save", e);
          toast("保存に失敗: "+describeHttpError(e), true);
        }
      });
      row.querySelector(".sgc-badge-delete").addEventListener("click", async ()=>{
        const id=row.dataset.id || "";
        if(!id){
          row.remove();
          return;
        }
        try{
          await deleteBadgeV2(id);
          toast("バッジを無効化しました");
          await reload();
        }catch(e){
          console.error("badge.delete", e);
          toast("削除に失敗: "+describeHttpError(e), true);
        }
      });
      return row;
    }

    async function reload(){
      try{
        const items = await fetchBadgesV2();
        listEl.innerHTML="";
        if(!items.length){
          listEl.appendChild(h(`<div class="sgc-help">まだバッジがありません。『＋ バッジを追加』から登録してください。</div>`));
        }else{
          items.forEach((item)=> listEl.appendChild(renderRow(item)));
        }
        statusEl.textContent = `取得件数: ${items.length}`;
      }catch(e){
        statusEl.textContent = "読み込みに失敗しました";
        toast("バッジ読み込みに失敗: "+describeHttpError(e), true);
      }
    }

    wrap.querySelector("#sgc-badge-add").addEventListener("click", ()=>{
      const tmp = renderRow({ id:"", title:"", criteria:{ type:"totalXpAtLeast", threshold:1 } });
      tmp.querySelector(".sgc-badge-title").focus();
      listEl.prepend(tmp);
    });
    wrap.querySelector("#sgc-badge-reload").addEventListener("click", ()=> reload());
    wrap.querySelector("#sgc-badge-saveall").addEventListener("click", async ()=>{
      const rows=[...listEl.querySelectorAll(".sgc-card-badge")];
      const payload=[];
      for(const row of rows){
        const title=row.querySelector(".sgc-badge-title").value.trim();
        if(!title){
          toast("タイトルを入力してください", true);
          row.querySelector(".sgc-badge-title").focus();
          return;
        }
        const thresholdVal=Number(row.querySelector(".sgc-badge-threshold").value || 0);
        if(!Number.isFinite(thresholdVal)){
          toast("しきい値を整数で入力してください", true);
          row.querySelector(".sgc-badge-threshold").focus();
          return;
        }
        const type=row.querySelector(".sgc-badge-type").value;
        const label=row.querySelector(".sgc-badge-label").value.trim();
        if(type === "hasLabelCountAtLeast" && !label){
          toast("ラベルIDを入力してください", true);
          row.querySelector(".sgc-badge-label").focus();
          return;
        }
        payload.push({
          id: row.dataset.id || undefined,
          title,
          description: row.querySelector(".sgc-badge-desc").value.trim() || undefined,
          xp: row.querySelector(".sgc-badge-xp").value === "" ? undefined : Number(row.querySelector(".sgc-badge-xp").value),
          icon: row.querySelector(".sgc-badge-icon").value.trim() || undefined,
          active: row.querySelector(".sgc-badge-active").checked,
          criteria: {
            type,
            threshold: thresholdVal,
            labelId: label || undefined,
          },
        });
      }
      try{
        await replaceBadgesV2(payload);
        toast("バッジ一覧を保存しました");
        await reload();
      }catch(e){
        console.error("badge.saveAll", e);
        toast("保存に失敗: "+describeHttpError(e), true);
      }
    });

    reload();
  }

  function renderSettings(){
    ensureProfileFromInputs();
    const pos = loadGearPositionSettings();
    const wrap=h(`
      <div class="sgc-bare">
        <div class="sgc-card" style="display:flex;flex-direction:column;gap:12px;">
          <div class="sgc-help">Habitica 上の歯車ボタンの位置を調整できます。変更すると即座に反映されます。</div>
          <div class="sgc-grid">
            <label>
              <span class="muted">top (px)</span>
              <input id="sgc-gear-top" type="number" step="1" min="0">
            </label>
            <label>
              <span class="muted">left (px)</span>
              <input id="sgc-gear-left" type="number" step="1" min="0">
            </label>
          </div>
          <div class="sgc-compact" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="sgc-btn primary" id="sgc-gear-save">保存</button>
            <button class="sgc-btn" id="sgc-gear-reset">既定値に戻す</button>
          </div>
        </div>
        <div class="sgc-card">
          <div class="muted" style="margin-bottom:6px;">AUTO_PARTY_DOMAINS</div>
          <div class="sgc-help">許可ドメインの設定はサーバー環境変数 <code>AUTO_PARTY_DOMAINS</code> で管理します。必要に応じて運用担当へ連絡してください。</div>
        </div>
      </div>
    `);
    bodyArea.appendChild(wrap);
    wrap.querySelector("#sgc-gear-top").value = pos.top;
    wrap.querySelector("#sgc-gear-left").value = pos.left;
    wrap.querySelector("#sgc-gear-save").addEventListener("click", ()=>{
      const topVal = Number(wrap.querySelector("#sgc-gear-top").value || 0);
      const leftVal = Number(wrap.querySelector("#sgc-gear-left").value || 0);
      const saved = saveGearPositionSettings({ top: topVal, left: leftVal });
      toast(`歯車位置を保存しました (top=${saved.top}px, left=${saved.left}px)`);
      wrap.querySelector("#sgc-gear-top").value = saved.top;
      wrap.querySelector("#sgc-gear-left").value = saved.left;
    });
    wrap.querySelector("#sgc-gear-reset").addEventListener("click", ()=>{
      const saved = saveGearPositionSettings({ top:120, left:18 });
      wrap.querySelector("#sgc-gear-top").value = saved.top;
      wrap.querySelector("#sgc-gear-left").value = saved.left;
      toast("既定位置にリセットしました");
    });
  }

  function renderAudit(){
    ensureProfileFromInputs();
    const controls=h(`
      <div class="sgc-compact">
        <button id="sgc-audit-reload" class="sgc-btn">監査ログを再読込</button>
        <button id="sgc-audit-export" class="sgc-btn">CSVダウンロード</button>
      </div>
    `);
    bodyArea.appendChild(controls);

    const table=h(`
      <table class="sgc-table">
        <thead>
          <tr>
            <th>時刻</th>
            <th>actor</th>
            <th>action</th>
            <th>detail</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    `);
    const tbody=table.querySelector("tbody");
    bodyArea.appendChild(table);

    const status=h(`<div class="sgc-help" id="sgc-audit-status"></div>`);
    bodyArea.appendChild(status);

    function renderRows(){
      tbody.innerHTML="";
      if(!auditCache.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=5;
        td.style.color="#777";
        td.textContent="監査ログがありません";
        tr.appendChild(td);
        tbody.appendChild(tr);
        status.textContent="";
        return;
      }
      auditCache.forEach(ev=>{
        const tr=document.createElement("tr");
        if(ev?.ua){
          tr.title = ev.ua;
        }
        const cells=[
          formatDateTime(ev?.at),
          ev?.actor || "api",
          ev?.action || "",
          summarizeAuditDetail(ev),
          ev?.ip || "",
        ];
        cells.forEach(txt=>{
          const td=document.createElement("td");
          td.textContent = txt ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      status.textContent = `取得件数: ${auditCache.length}`;
    }

    async function reload(){
      try{
        await fetchAudit(100);
        renderRows();
      }catch(e){
        toast("監査ログの取得に失敗しました: "+describeHttpError(e), true);
      }
    }

    controls.querySelector("#sgc-audit-reload").addEventListener("click", reload);
    controls.querySelector("#sgc-audit-export").addEventListener("click", ()=>{
      if(!auditCache.length){
        toast("ダウンロード対象の監査ログがありません", true);
        return;
      }
      downloadAuditCsv(auditCache);
    });
    reload();
  }

  /* ====== 起動 ====== */
  function start(){
    ensureFab();
    setupFabObserver();
    maintainFab();
  }
  if(document.readyState==="complete"){ start(); }
  else window.addEventListener("load", start, {once:true});

})();
</script>

<script>
// この単体ページを開いたら自動でモーダルを表示
(function openWhenReady(){
  const el = document.getElementById('sgc-fab');
  if (el) { el.click(); return; }
  setTimeout(openWhenReady, 100);
})();
</script>

<!-- === Readability / Comfort Mode (v2025-10-14) === -->
<style id="sgc-a11y">
  /* Base font and line-height */
  #sgc-modal,
  #sgc-modal input,
  #sgc-modal select,
  #sgc-modal textarea,
  #sgc-modal button {
    font-size: 16px;
    line-height: 1.5;
  }

  #sgc-modal { width: min(1200px, 96vw); }
  .sgc-hd{ padding: 16px 20px; }
  .sgc-title{ font-size: 19px; }
  .sgc-tabs{ gap: 10px; }
  .sgc-tab{ padding: 8px 14px; font-size: 15px; }

  .sgc-row{
    grid-template-columns: 220px 1fr;
    gap: 16px;
    align-items: center;
    padding: 10px 0;
  }
  .sgc-row label{ font-size: 15px; color:#222; }

  .sgc-row input,
  .sgc-row select,
  .sgc-row textarea{
    min-height: 44px;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 16px;
  }
  .sgc-row textarea{ min-height: 96px; }

  .sgc-row-compact input,
  .sgc-row-compact select{
    min-width: 180px;
  }

  .sgc-btn{
    min-height: 42px;
    padding: 0 16px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 15px;
  }

  .sgc-card{ gap: 14px; border-radius: 14px; }
  .sgc-help{ font-size: 14px; color:#666; }

  #sgc-modal input[type="checkbox"],
  #sgc-modal input[type="radio"]{
    transform: scale(1.2);
    transform-origin: center;
    margin-right: 6px;
  }

  #sgc-modal table{ font-size: 15px; }
  #sgc-modal table th,
  #sgc-modal table td{ padding: 12px 14px; }

  #sgc-modal input[type="number"]{ width: 130px; }

  #sgc-modal input[type="text"].wide,
  #sgc-modal select.wide{ min-width: 260px; }

  #sgc-modal .sgc-compact{ align-items: center; }
  #sgc-modal .sgc-row-compact{ align-items: center; }

  #sgc-modal .sgc-overlay{
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 30;
  }
  #sgc-modal .sgc-overlay-card{
    background: #fff;
    padding: 20px;
    border-radius: 14px;
    width: min(520px, 90%);
    display: flex;
    flex-direction: column;
    gap: 14px;
    box-shadow: 0 16px 32px rgba(0,0,0,0.18);
  }
  #sgc-modal .sgc-overlay-card textarea{
    width: 100%;
    min-height: 220px;
    border: 1px solid #dfe3f0;
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 15.5px;
  }
</style>

<!-- Optional: simple UI-scale toggle (90% / 100% / 110% / 125%) -->
<script>
  (function () {
    const KEY = "sgc.uiScale";
    const ORDER = [0.9, 1, 1.1, 1.25];
    const TITLE = "表示サイズ切替（90%/100%/110%/125%）";
    const modal = document.getElementById("sgc-modal");
    if (!modal) return;

    const savedRaw = Number(localStorage.getItem(KEY));
    const scale = ORDER.includes(savedRaw) ? savedRaw : 1;
    modal.style.zoom = String(scale);

    const btn = document.createElement("button");
    btn.className = "sgc-btn";
    btn.style.marginLeft = "8px";
    btn.title = TITLE;
    btn.textContent = `${Math.round(scale * 100)}%`;

    btn.onclick = () => {
      const currentRaw = Number(localStorage.getItem(KEY));
      const current = ORDER.includes(currentRaw) ? currentRaw : scale;
      const next = ORDER[(ORDER.indexOf(current) + 1) % ORDER.length];
      localStorage.setItem(KEY, String(next));
      location.reload();
    };

    document.querySelector(".sgc-hd .sgc-kv:last-of-type")?.appendChild(btn);
  })();
</script>

<!-- Ensure UI-scale toggle is available after modal initialization -->
<script>
  (function () {
    const KEY = "sgc.uiScale";
    const ORDER = [0.9, 1, 1.1, 1.25];
    const TITLE = "表示サイズ切替（90%/100%/110%/125%）";

    function apply(modal) {
      if (!modal) return false;
      const savedRaw = Number(localStorage.getItem(KEY));
      const scale = ORDER.includes(savedRaw) ? savedRaw : 1;
      modal.style.zoom = String(scale);
      const host = modal.querySelector(".sgc-hd .sgc-kv:last-of-type");
      if (!host) return true;
      let btn = host.querySelector(`button[title="${TITLE}"]`);
      if (!btn) {
        btn = document.createElement("button");
        btn.className = "sgc-btn";
        btn.type = "button";
        btn.title = TITLE;
        btn.style.marginLeft = "8px";
        btn.setAttribute("data-ui-scale-btn", "1");
        btn.addEventListener("click", () => {
          const currentRaw = Number(localStorage.getItem(KEY));
          const current = ORDER.includes(currentRaw) ? currentRaw : scale;
          const next = ORDER[(ORDER.indexOf(current) + 1) % ORDER.length];
          localStorage.setItem(KEY, String(next));
          location.reload();
        });
        host.appendChild(btn);
      }
      btn.textContent = `${Math.round(scale * 100)}%`;
      return true;
    }

    function ensure() {
      if (apply(document.getElementById("sgc-modal"))) return;
      const observer = new MutationObserver(() => {
        if (apply(document.getElementById("sgc-modal"))) {
          observer.disconnect();
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", ensure, { once: true });
    } else {
      ensure();
    }
  })();
</script>

</body>
</html>
