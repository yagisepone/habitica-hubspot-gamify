<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Gamify Console</title>
</head>
<body>

<script>
/* ------------------------------
   0) 事前セット: GM_addStyle / マジックリンク
   ------------------------------ */
(function(){
  // Tampermonkey なしでも同じAPI名でCSSを注入できるように
  window.GM_addStyle = window.GM_addStyle || function(css){
    try { const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s); } catch { /* noop */ }
  };

  // #tenant=...&token=...&base=... を localStorage に保存
  try {
    const q = new URLSearchParams(location.hash.slice(1));
    const tenant = q.get('tenant') || 'default';
    const token  = q.get('token')  || '';
    const base   = (q.get('base') ?? '').trim();
    const baseUrl = base === '' ? location.origin : base;
    localStorage.setItem("sgc.profile.v3", JSON.stringify({ tenant, baseUrl, token }));
  } catch { /* noop */ }
})();
</script>

<script>
/* ==UserScript==
 * @name         Sales Gamify Console (v2.3 UI: ルール自由編集・CSV取込・安定化)
 * @namespace    https://habitica.com/
 * @version      2.3.0
 * @description  Habitica上に営業ゲーミフィケーション設定UIを追加。スコア/アポ/ラベル/CSV/ダッシュボードを編集。読み込み完了と同時に表示ボタンを出すよう安定化。
 * @match        https://habitica.com/*
 * @run-at       document-end
 * @grant        GM_addStyle
 * ==/UserScript== */

(() => {
  /* ====== 基本ユーティリティ ====== */
  const LS_KEY  = "sgc.profile.v3";
  const LS_VIEW = "sgc.view.v3";
  const LS_UNDO = "sgc.undo.v1";
  const MAX_UNDO = 8;
  const PIN_KEY = "sgc_pin";

  const h = (html) => { const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstElementChild; };
  const asNum=(v,d=0)=>{ const n=Number(v); return Number.isFinite(n)?n:d; };
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const load=(k,def={})=>{ try { return JSON.parse(localStorage.getItem(k)||"") || def; } catch { return def; } };
  const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v||{}));
  const toast=(msg,bad=false)=>{ const el=h(`<div class="sgc-toast" style="background:${bad?"#c0392b":"#222"}">${msg}</div>`); document.body.appendChild(el); setTimeout(()=>el.remove(),3000); };
  const loadProfile=()=>load(LS_KEY,{ tenant:"default", baseUrl:"", token:"" });
  const saveProfile=(p)=>save(LS_KEY,p);

  const headers=(p)=>{ const hd={"Accept":"application/json"}; if(p?.token){ hd.Authorization=`Bearer ${p.token}`; } return hd; };
  const apiGET=async(url,p)=>{ const r=await fetch(url,{headers:headers(p)}); if(!r.ok) throw new Error(String(r.status)); return r.json(); };
  const apiPUT=async(url,body,p)=>{ const r=await fetch(url,{method:"PUT",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); try { return await r.json(); } catch { return { ok:true }; } };
  const apiPOST=async(url,body,p)=>{ const r=await fetch(url,{method:"POST",headers:{...headers(p),"Content-Type":"application/json"},body:JSON.stringify(body)}); if(!r.ok) throw new Error(String(r.status)); try { return await r.json(); } catch { return { ok:true }; } };
  const apiPOSTForm=async(url,form,p)=>{ const r=await fetch(url,{method:"POST",headers:headers(p),body:form}); if(!r.ok) throw new Error(String(r.status)); try { return await r.json(); } catch { return { ok:true }; } };

  /* ====== スタイル（オリジナル + 使い勝手改良） ====== */
  GM_addStyle(`
    #sgc-fab{position:fixed; top:110px; right:18px; z-index:2147483646;
      background:#6c5ce7; color:#fff; border-radius:14px; padding:10px 14px;
      box-shadow:0 6px 18px rgba(0,0,0,.25); font-weight:700; display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none}
    #sgc-fab:hover{filter:brightness(1.06)}
    #sgc-modal-mask{position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:2147483645; display:none}
    #sgc-modal{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      z-index:2147483646; width:min(1160px,96vw); max-height:88vh; background:#fff; border-radius:14px;
      overflow:hidden; box-shadow:0 24px 48px rgba(0,0,0,.25); display:none;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .sgc-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f7f7fb;border-bottom:1px solid #ececf5;gap:12px}
    .sgc-title{font-weight:800}
    .sgc-kv{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sgc-tabs{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid #f1f1f6;flex-wrap:wrap}
    .sgc-tab{padding:6px 10px;border-radius:8px;font-weight:700;color:#555;cursor:pointer}
    .sgc-tab.active{background:#6c5ce7;color:#fff}
    .sgc-body{padding:14px;max-height:calc(88vh - 134px);overflow:auto}
    .sgc-row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;padding:8px 0}
    .sgc-row input,.sgc-row select,.sgc-row textarea{border:1px solid #dfe3f0;border-radius:8px;padding:9px 10px;width:100%;font-size:14px;background:#fff}
    .sgc-help{font-size:12px;color:#777}
    .sgc-actions{position:sticky; bottom:0; background:#fff; z-index:1;
      display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #ececf5;align-items:center}
    .sgc-btn{background:#e9e9f4;border:none;padding:9px 14px;border-radius:10px;font-weight:800;cursor:pointer}
    .sgc-btn.primary{background:#6c5ce7;color:#fff}
    .sgc-badge{background:#f0efff;color:#5c54d6;border-radius:999px;padding:3px 8px;font-size:12px}
    .sgc-toast{position:fixed;right:16px;bottom:16px;background:#222;color:#fff;padding:10px 14px;border-radius:12px;z-index:2147483647;opacity:.95}
    .sgc-list{display:flex;flex-direction:column;gap:8px}
    .sgc-card{border:1px solid #e8e8f5;border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .sgc-card .full{grid-column:1 / -1}
    .sgc-card .muted{color:#777;font-size:12px}
    .sgc-del{background:#fff;border:1px solid #e1e1ef}
    .sgc-bare{border:1px dashed #ddd;border-radius:10px;padding:10px}
    .sgc-row-compact{display:flex;gap:8px;align-items:center}
    /* HubSpot行をワイドに：3カラム(ラベルID/タイトル/削除) */
    .sgc-card-hub{grid-template-columns:2fr 3fr 120px}
    .sgc-card-hub input{width:100%}
    .sgc-pin-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:#555}
    .sgc-pin-toggle input{accent-color:#6c5ce7}
    #sgc-fab.pinned{background:#4d3cd1}
    .sgc-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    .sgc-table th,.sgc-table td{padding:8px 10px;border-bottom:1px solid #ececf5;text-align:left;vertical-align:top}
    .sgc-table th{background:#f7f7fb;color:#555;font-weight:700}
    .sgc-table tbody tr:hover{background:#fafaff}
    .sgc-compact{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .sgc-filter{margin-top:10px}
    .sgc-cols{display:flex;gap:16px;flex-wrap:wrap;margin-top:10px}
    .sgc-col{flex:1 1 360px;min-width:320px;display:flex;flex-direction:column;gap:10px}
    .sgc-card-shop{grid-template-columns:1fr 120px 120px 1fr 140px}
    .sgc-card-shop .full{grid-column:1/-1}
    .sgc-card-shop input[type="number"]{width:100%}
    .sgc-card-purchase{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .sgc-card-purchase .full{grid-column:1/-1}
    @media(max-width:768px){
      .sgc-row{grid-template-columns:1fr}
      .sgc-card{grid-template-columns:1fr}
      .sgc-card-hub{grid-template-columns:1fr}
      .sgc-card-shop{grid-template-columns:1fr}
      .sgc-card-purchase{grid-template-columns:1fr}
    }
    :root{
      --sgc-font:16px; --sgc-line:1.6; --sgc-pad:12px; --sgc-input:44px;
    }
    #sgc-modal{ font-size:var(--sgc-font); line-height:var(--sgc-line); }
    .sgc-row{ gap:16px; padding:10px 0; }
    .sgc-row input,
