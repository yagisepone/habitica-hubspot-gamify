(function(){const BTN_ID='gamify-settings-btn';if(document.getElementById(BTN_ID))return;const btn=document.createElement('button');btn.id=BTN_ID;btn.type='button';btn.textContent='設定';Object.assign(btn.style,{position:'fixed',right:'24px',bottom:'120px',padding:'10px 14px',fontSize:'14px',lineHeight:'1',border:'none',borderRadius:'12px',boxShadow:'0 6px 18px rgba(0,0,0,.25)',background:'#6c5ce7',color:'#fff',cursor:'pointer',zIndex:'2147483647',userSelect:'none',opacity:'0.95',transition:'opacity .2s ease'});btn.onmouseenter=()=>btn.style.opacity='1';btn.onmouseleave=()=>btn.style.opacity='0.95';btn.addEventListener('click',()=>{if(typeof window.openSalesGamifyConsole==='function'){window.openSalesGamifyConsole()}else if(typeof window.SalesGamifyConsole==='function'){window.SalesGamifyConsole()}else{window.dispatchEvent(new CustomEvent('open-sales-gamify-console'))}});const LS_KEY='gamify_settings_btn_pos_v2';const safeMargins={top:72,right:24,bottom:120,left:24};const clamp=(v,min,max)=>Math.min(Math.max(v,min),max);function loadPos(){try{const p=JSON.parse(localStorage.getItem(LS_KEY)||'null');if(p&&typeof p.x==='number'&&typeof p.y==='number')return p}catch{}return null}function savePos(x,y){try{localStorage.setItem(LS_KEY,JSON.stringify({x,y}))}catch{}}function applyPos(x,y){btn.style.left=x+'px';btn.style.top=y+'px';btn.style.right='auto';btn.style.bottom='auto'}function initialPlace(){const saved=loadPos();const vw=window.innerWidth;const vh=window.innerHeight;if(saved){const x=clamp(saved.x,safeMargins.left,vw-safeMargins.right-btn.offsetWidth);const y=clamp(saved.y,safeMargins.top,vh-safeMargins.bottom-btn.offsetHeight);applyPos(x,y);return}requestAnimationFrame(()=>{const x=vw-safeMargins.right-btn.offsetWidth;const y=vh-safeMargins.bottom-btn.offsetHeight;applyPos(x,y);savePos(x,y)})}let dragging=false,startX=0,startY=0,baseX=0,baseY=0;function pointerDown(e){dragging=true;const r=btn.getBoundingClientRect();baseX=r.left;baseY=r.top;startX=(e.touches?e.touches[0].clientX:e.clientX);startY=(e.touches?e.touches[0].clientY:e.clientY);document.addEventListener('pointermove',pointerMove);document.addEventListener('pointerup',pointerUp,{once:true});document.addEventListener('touchmove',pointerMove,{passive:false});document.addEventListener('touchend',pointerUp,{once:true})}function pointerMove(e){if(!dragging)return;e.preventDefault?.();const cx=(e.touches?e.touches[0].clientX:e.clientX);const cy=(e.touches?e.touches[0].clientY:e.clientY);const vx=baseX+(cx-startX);const vy=baseY+(cy-startY);const x=clamp(vx,safeMargins.left,window.innerWidth-safeMargins.right-btn.offsetWidth);const y=clamp(vy,safeMargins.top,window.innerHeight-safeMargins.bottom-btn.offsetHeight);applyPos(x,y)}function pointerUp(){dragging=false;const rect=btn.getBoundingClientRect();const vw=window.innerWidth;const vh=window.innerHeight;const distLeft=rect.left-safeMargins.left;const distRight=vw-safeMargins.right-rect.right;const distTop=rect.top-safeMargins.top;const distBottom=vh-safeMargins.bottom-rect.bottom;const snapLeft=distLeft<=distRight;const snapTop=distTop<=distBottom;let x=snapLeft?safeMargins.left:vw-safeMargins.right-rect.width;let y=snapTop?safeMargins.top:vh-safeMargins.bottom-rect.height;applyPos(x,y);savePos(x,y);document.removeEventListener('pointermove',pointerMove);document.removeEventListener('touchmove',pointerMove)}btn.addEventListener('pointerdown',pointerDown);btn.addEventListener('touchstart',pointerDown,{passive:true});window.addEventListener('resize',()=>{const r=btn.getBoundingClientRect();const x=clamp(r.left,safeMargins.left,window.innerWidth-safeMargins.right-r.width);const y=clamp(r.top,safeMargins.top,window.innerHeight-safeMargins.bottom-r.height);applyPos(x,y);savePos(x,y)});(document.body||document.documentElement).appendChild(btn);initialPlace();})();
